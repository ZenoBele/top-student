<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Top Student - Delete Account</title>
  <link rel="icon" type="image/png" sizes="32x32" href="../images/favicon.png">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
</head>
<body class="bg-black text-white font-sans">

  <!-- Header -->
  <header class="bg-gray-900 px-6 py-4 shadow-md flex justify-between items-center">
    <h1 class="text-xl font-bold text-white">Top Student</h1>
    <nav class="space-x-4 text-sm">
      <a href="premium.html" class="text-white hover:text-[#0EA5E9]">Dashboard</a>
      <a href="../index.html" class="text-white hover:text-[#0EA5E9]"><i class="fa-solid fa-right-from-bracket"></i></a>
    </nav>
  </header>

  <div id="toastBox" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded shadow-lg text-white text-sm hidden z-51 bg-gray-800"></div>

  <!-- Main -->
  <main class="max-w-2xl mx-auto mt-16 p-6 bg-gray-800 shadow-lg rounded-lg text-center space-y-6">
    <h2 class="text-2xl font-bold text-red-500">Wait‚Ä¶ You're Leaving?</h2>
    <p class="text-gray-300 text-lg">You‚Äôve downloaded guides, explored paths, and grown. Are you sure this is goodbye?</p>
    <p class="text-gray-400 italic">‚ÄúDiscipline is choosing between what you want now and what you want most.‚Äù</p>

    <div class="mt-6">
      <label for="reason" class="block mb-2 text-sm font-medium text-gray-300">Why are you leaving?</label>
      <textarea id="reason" rows="4" class="w-full p-3 border border-gray-600 rounded bg-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-red-400" placeholder="We'd love to hear your feedback..."></textarea>
    </div>

    <div class="text-sm text-gray-400 space-y-2 text-left">
      <p><strong>Other Options:</strong></p>
      <ul class="list-disc pl-5">
        <li>Need help? <a href="contact.html" class="text-[#0EA5E9] underline">Contact us</a></li>
        <li>Want to downgrade? <a href="manage.html" class="text-[#0EA5E9] underline">Change your plan</a></li>
      </ul>
    </div>

    <div class="flex justify-center gap-4 mt-8">
      <button onclick="window.location.href='premium.html'" class="px-5 py-3 bg-gray-600 text-white rounded hover:bg-gray-500">Stay a bit longer</button>
      <button id="deleteBtn" class="px-5 py-3 bg-red-600 text-white rounded hover:bg-red-700">Delete Anyway</button>
    </div>
  </main>

  <!-- Loading Dots -->
  <div id="loaderDots" class="hidden fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50">
    <div class="flex space-x-2">
      <div class="w-3 h-3 bg-red-600 rounded-full animate-bounce [animation-delay:-0.5s]"></div>
      <div class="w-3 h-3 bg-red-400 rounded-full animate-bounce [animation-delay:-1s]"></div>
      <div class="w-3 h-3 bg-red-200 rounded-full animate-bounce"></div>
    </div>
  </div>

  <!-- Modern Confirmation Modal -->
  <div id="confirmModal" class="hidden fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50">
    <div class="bg-gray-800 p-6 rounded-lg shadow-md max-w-sm w-full space-y-4 text-center text-white">
      <h3 class="text-lg font-bold text-red-400">Confirm Deletion</h3>
      <p class="text-gray-300">Are you sure you want to delete your Top Student account? This cannot be undone.</p>
      <div class="flex justify-center gap-4 pt-4">
        <button id="cancelDelete" class="px-4 py-2 bg-gray-600 rounded hover:bg-gray-500">Cancel</button>
        <button id="confirmDelete" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Delete</button>
      </div>
    </div>
  </div>

<script type="module" defer>
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  const supabase = createClient(
    'https://mlwxxtvsozhwzjxmsvbg.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1sd3h4dHZzb3pod3pqeG1zdmJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4OTAwOTksImV4cCI6MjA2NDQ2NjA5OX0.i9KySUVeot9imnALKr79DYySocuj0_rko4nzPhPxekU'
  );

  const deleteBtn = document.getElementById("deleteBtn");
  const confirmModal = document.getElementById("confirmModal");
  const cancelDelete = document.getElementById("cancelDelete");
  const confirmDelete = document.getElementById("confirmDelete");
  const loaderDots = document.getElementById("loaderDots");

  deleteBtn.addEventListener("click", () => {
    confirmModal.classList.remove("hidden");
  });

  cancelDelete.addEventListener("click", () => {
    confirmModal.classList.add("hidden");
  });

  confirmDelete.addEventListener("click", async () => {
    confirmModal.classList.add("hidden");
    loaderDots.classList.remove("hidden");

    const reason = document.getElementById("reason").value.trim();

    const { data: { user }, error: userErr } = await supabase.auth.getUser();
    if (userErr || !user) {
      showToast("Error getting user info.", "error");
      loaderDots.classList.add("hidden");
      return;
    }

    const userId = user.id;

    // 1. Log delete request
    const { error: logError } = await supabase.from("delete_requests").insert([
      { user_id: userId, reason: reason || null }
    ]);
    if (logError) {
      showToast("Failed to submit request. Try again later.", "error");
      loaderDots.classList.add("hidden");
      return;
    }

    // 2. Deactivate
    const { error: deactivateError } = await supabase.from("profiles").update({
      is_active: false
    }).eq("id", userId);
    if (deactivateError) {
      showToast("Failed to deactivate account.", "error");
      loaderDots.classList.add("hidden");
      return;
    }

    // 3. Sign out and redirect
    await supabase.auth.signOut();
    showToast("Your account is scheduled for deletion üò¢", "success");

    setTimeout(() => {
      loaderDots.classList.add("hidden");
      window.location.href = "../index.html";
    }, 2500);
  });

  function showToast(msg, type = "info") {
    const box = document.getElementById("toastBox");
    box.textContent = msg;
    box.className = `fixed bottom-4 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded shadow-lg text-white text-sm z-50 ${
      type === "success" ? "bg-green-600" : type === "error" ? "bg-red-600" : "bg-blue-600"
    }`;
    box.classList.remove("hidden");
    setTimeout(() => {
      box.classList.add("hidden");
    }, 3000);
  }
</script>
</body>
</html>