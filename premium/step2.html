<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Top Student - University Application (Step 2)</title>
  <link rel="icon" type="image/png" sizes="32x32" href="../images/favicon.png">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <style>
  #saveStatus {
    text-align: center;
    font-weight: 600;
  }
  #saveStatus.error {
    color: #dc2626; /* red-600 */
  }
  #saveStatus.warning {
    color: #ca8a04; /* amber-600 */
  }
  #saveStatus.success {
    color: #16a34a; /* green-600 */
  }
</style>
</head>
<body class="bg-white text-gray-800">
  <!-- Header -->
  <header class="bg-gray-700 shadow mb-6">
    <div class="max-w-6xl mx-auto px-4 py-4 flex justify-between items-center">
      <div class="flex items-center gap-3">
        <span class="text-lg font-bold text-white">Top Student</span>
      </div>
      <nav class="flex gap-6 text-base text-white">
        <a href="https://www.google.com/search?q=south+african+universities" target="_blank" class="group transition-transform duration-200">
          <span class="group-hover:hidden font-semibold">Ex</span>
          <span class="hidden group-hover:inline-block font-medium text-blue-700 transition-all duration-500 ease-in">Explore Universities</span>
        </a>
        <a href="https://www.google.com/search?q=university+application+tips+south+africa" target="_blank" class="group transition-transform duration-200">
          <span class="group-hover:hidden font-semibold">App</span>
          <span class="hidden group-hover:inline-block font-medium text-blue-700 transition-all duration-500 ease-in">Application Tips</span>
        </a>
        <a href="https://www.google.com/search?q=south+africa+university+courses" target="_blank" class="group transition-transform duration-200">
          <span class="group-hover:hidden font-semibold">Co</span>
          <span class="hidden group-hover:inline-block font-medium text-blue-700 transition-all duration-500 ease-in">Courses & Info</span>
        </a>
      </nav>
    </div>
  </header>

  <div class="max-w-4xl mx-auto p-6 text-center">
    <h1 class="text-3xl font-bold text-green-500 mb-2">Choose Your Universities</h1>
    <p class="text-sm text-gray-600 mb-10">Step 2 of 5 – Select your top 3 public universities in South Africa that you wish to apply to.</p>

    <!-- Hero Step Logic Section -->
    <div class="flex flex-wrap justify-center gap-6 mb-12">
      <div class="flex flex-col items-center">
        <div class="w-20 h-20 flex items-center justify-center rounded-full bg-blue-500 text-white font-bold text-xl">Step</br>1</div>
        <span class="mt-2 text-sm font-medium text-gray-600">How to Apply</span>
      </div>
      <div class="flex flex-col items-center">
        <div class="w-20 h-20 flex items-center justify-center rounded-full bg-green-500 text-white font-bold text-xl">Step</br>2</div>
        <span class="mt-2 text-sm font-medium text-green-500">Choose University</span>
      </div>
      <div class="flex flex-col items-center">
        <div class="w-20 h-20 flex items-center justify-center rounded-full bg-yellow-500 text-white font-bold text-xl">Step</br>3</div>
        <span class="mt-2 text-sm font-medium text-gray-600">Agree to Terms</span>
      </div>
      <div class="flex flex-col items-center">
        <div class="w-20 h-20 flex items-center justify-center rounded-full bg-purple-500 text-white font-bold text-xl">Step</br>4</div>
        <span class="mt-2 text-sm font-medium text-gray-600">Personal Info</span>
      </div>
      <div class="flex flex-col items-center">
        <div class="w-20 h-20 flex items-center justify-center rounded-full bg-red-500 text-white font-bold text-xl">Step</br>5</div>
        <span class="mt-2 text-sm font-medium text-gray-600">What’s Next</span>
      </div>
    </div>

    <!-- Step 2 Section -->
<section class="mb-10 text-left max-w-2xl mx-auto">
      <h2 class="text-xl text-center font-semibold text-green-700 mb-4">Step 2: Choose Your University & Course</h2>
      <div class="bg-white shadow-md p-6 rounded-xl border border-green-200">
        <!-- Reminder Box -->
        <div class="mb-6 p-5 bg-gradient-to-br from-green-50 to-green-100 border-l-4 border-green-500 rounded-xl shadow-sm">
          <div class="flex items-start gap-4">
            <i class="fa-solid fa-school text-green-600 text-2xl mt-1"></i>
            <div class="text-sm text-green-900 leading-relaxed">
              <h3 class="text-base font-semibold text-green-800 mb-1">Choose Carefully</h3>
              <p>Select up to 3 public universities and your desired course for each choice.</p>
            </div>
          </div>
        </div>

        <!-- Dropdown Form -->
        <form id="university-form" class="space-y-6 text-sm text-gray-800">
          <!-- Choice 1 -->
          <div class="mb-6">
      <label class="block font-semibold text-green-700 mb-1">1st Choice Institution</label>
      <select id="choice1" name="choice1" class="w-full p-2 border border-green-400 rounded bg-green-900 text-white">
        <option value="">-- Select a university --</option>
        <option>University of South Africa</option>
        <option>University of Cape Town</option>
        <option>University of Johannesburg</option>
        <option>University of Venda</option>
        <option>Cape Peninsula University of Technology</option>
        <option>Tshwane University of Technology</option>
        <option>Durban University of Technology</option>
        <option>Vaal University of Technology</option>
        <option>University of Fort Hare</option>
        <option>University of the Free State</option>
        <option>University of Limpopo</option>
        <option>North-West University</option>
        <option>University of Pretoria</option>
        <option>Stellenbosch University</option>
        <option>University of the Western Cape</option>
        <option>University of the Witwatersrand</option>
        <option>University of KwaZulu-Natal</option>
        <option>Nelson Mandela University</option>
        <option>University of Zululand</option>
        <option>Central University of Technology</option>
        <option>Mangosuthu University of Technology</option>
        <option>University of Mpumalanga</option>
      </select>
      <label class="block mt-3 text-sm text-green-800">What do you want to apply for?</label>
      <input id="course1" type="text" placeholder="e.g., BSc Computer Science" class="w-full p-2 mt-1 border border-green-300 rounded" />
    </div>

    <div class="mb-6">
      <label class="block font-semibold text-lime-700 mb-1">2nd Choice Institution</label>
      <select id="choice2" class="w-full p-2 border border-lime-400 rounded bg-green-600 text-white">
        <option disabled selected>Select your second choice</option>
        <option>University of South Africa</option>
        <option>University of Cape Town</option>
        <option>University of Johannesburg</option>
        <option>University of Venda</option>
        <option>Cape Peninsula University of Technology</option>
        <option>Tshwane University of Technology</option>
        <option>Durban University of Technology</option>
        <option>Vaal University of Technology</option>
        <option>University of Fort Hare</option>
        <option>University of the Free State</option>
        <option>University of Limpopo</option>
        <option>North-West University</option>
        <option>University of Pretoria</option>
        <option>Stellenbosch University</option>
        <option>University of the Western Cape</option>
        <option>University of the Witwatersrand</option>
        <option>University of KwaZulu-Natal</option>
        <option>Nelson Mandela University</option>
        <option>University of Zululand</option>
        <option>Central University of Technology</option>
        <option>Mangosuthu University of Technology</option>
        <option>University of Mpumalanga</option>
      </select>
      <label class="block mt-3 text-sm text-lime-800">What do you want to apply for?</label>
      <input id="course2" type="text" placeholder="e.g., BA Psychology" class="w-full p-2 mt-1 border border-lime-300 rounded" />
    </div>

    <div class="mb-6">
      <label class="block font-semibold text-green-600 mb-1">3rd Choice Institution</label>
      <select id="choice3" class="w-full p-2 border border-green-300 rounded bg-green-300 text-white">
        <option disabled selected>Select your third choice</option>
        <option>University of South Africa</option>
        <option>University of Cape Town</option>
        <option>University of Johannesburg</option>
        <option>University of Venda</option>
        <option>Cape Peninsula University of Technology</option>
        <option>Tshwane University of Technology</option>
        <option>Durban University of Technology</option>
        <option>Vaal University of Technology</option>
        <option>University of Fort Hare</option>
        <option>University of the Free State</option>
        <option>University of Limpopo</option>
        <option>North-West University</option>
        <option>University of Pretoria</option>
        <option>Stellenbosch University</option>
        <option>University of the Western Cape</option>
        <option>University of the Witwatersrand</option>
        <option>University of KwaZulu-Natal</option>
        <option>Nelson Mandela University</option>
        <option>University of Zululand</option>
        <option>Central University of Technology</option>
        <option>Mangosuthu University of Technology</option>
        <option>University of Mpumalanga</option>
      </select>
      <label class="block mt-3 text-sm text-green-700">What do you want to apply for?</label>
      <input id="course3" type="text" placeholder="e.g., NDip Marketing" class="w-full p-2 mt-1 border border-green-200 rounded" />
    </div>
  </div>
        </form>
		
<div class="flex flex-col items-center text-center gap-3">		
<button id="saveChoicesBtn" class="mt-4 bg-green-600 text-center text-white px-6 py-2 rounded hover:bg-green-700">
  Save My University Choices
</button>
</div>
<p id="saveStatus" class="mt-2 text-sm text-green-800"></p>
        <!-- Next Step Box -->
<div id="actionbnt" class="flex justify-center">
  <div class="mt-8 p-5 bg-green-100/70 rounded-xl border border-green-300 text-sm text-green-900 shadow-sm max-w-xl w-full">
    <div class="flex flex-col items-center text-center gap-3">
      <i class="fa-solid fa-arrow-right text-green-600 text-lg"></i>
      <div>
        <strong class="block text-green-800 mb-1">Next Step: Step 3 – Agree to Terms</strong>
        <p>You'll review terms of data use, eligibility, and consent before submitting your selections.</p>
        <div class="mt-4 flex gap-4 justify-center">
          <a href="university.html" class="inline-block bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-6 rounded">
            ← Back
          </a>
          <a href="step3.html" class="inline-block bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded">
            Next →
          </a>
        </div>
      </div>
    </div>
  </div>
</div>
<div id="goToStep5BtnContainer" class="flex flex-col items-center text-center gap-3" style="display:none;">
  <button onclick="window.location.href='step5.html'" 
    class="mt-4 bg-green-600 text-center text-white px-6 py-2 rounded hover:bg-green-700">
    What Now
  </button>
</div>	
      </div>
    </section>
	
	
<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  const supabase = createClient(
    'https://mlwxxtvsozhwzjxmsvbg.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1sd3h4dHZzb3pod3pqeG1zdmJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4OTAwOTksImV4cCI6MjA2NDQ2NjA5OX0.i9KySUVeot9imnALKr79DYySocuj0_rko4nzPhPxekU'
  );
  
async function checkIdNumberAndToggle() {
    const { data: { user }, error: userError } = await supabase.auth.getUser();

    if (userError || !user) {
      // Not logged in or error
      document.getElementById('actionbnt').style.display = 'none';
      document.getElementById('goToStep5BtnContainer').style.display = 'none';
      return;
    }

    const { data, error } = await supabase
      .from('university_choices')
      .select('id_number')
      .eq('user_id', user.id)
      .single();

    if (error) {
      console.error('Error fetching university_choices:', error);
      document.getElementById('actionbnt').style.display = 'none';
      document.getElementById('goToStep5BtnContainer').style.display = 'none';
      return;
    }

    if (data && data.id_number && data.id_number.trim() !== '') {
      // Hide the original div
      document.getElementById('actionbnt').style.display = 'none';
      // Show the new button container
      document.getElementById('goToStep5BtnContainer').style.display = 'flex';
    } else {
      // Show original div
      document.getElementById('actionbnt').style.display = 'flex';
      // Hide new button container
      document.getElementById('goToStep5BtnContainer').style.display = 'none';
    }
  }

  checkIdNumberAndToggle();

  const universityOptions = [
    'University of South Africa',
    'University of Cape Town',
    'University of Johannesburg',
    'University of Venda',
    'Cape Peninsula University of Technology',
    'Tshwane University of Technology',
    'Durban University of Technology',
    'Vaal University of Technology',
    'University of Fort Hare',
    'University of the Free State',
    'University of Limpopo',
    'North-West University',
    'University of Pretoria',
    'Stellenbosch University',
    'University of the Western Cape',
    'University of the Witwatersrand',
    'University of KwaZulu-Natal',
    'Nelson Mandela University',
    'University of Zululand',
    'Central University of Technology',
    'Mangosuthu University of Technology',
    'University of Mpumalanga'
  ];

  const dropdowns = ['choice1', 'choice2', 'choice3'];
  dropdowns.forEach(id => {
    const select = document.getElementById(id);
    universityOptions.forEach(name => {
      const option = document.createElement('option');
      option.textContent = name;
      option.value = name;
      select.appendChild(option);
    });
  });

  const form = document.getElementById('university-form');
  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const data = {
      choice1: form.choice1.value,
      course1: form.course1.value,
      choice2: form.choice2.value,
      course2: form.course2.value,
      choice3: form.choice3.value,
      course3: form.course3.value
    };

    const { error } = await supabase.from('university_choices').insert([data]);
    if (error) {
      alert('Error saving data: ' + error.message);
    } else {
      alert('Choices submitted successfully!');
      form.reset();
    }
  });
  
document.addEventListener('DOMContentLoaded', async () => {
  const saveBtn = document.getElementById('saveChoicesBtn');
  const saveStatus = document.getElementById('saveStatus');

  // Helper to set status text and color class
  function setStatus(message, type = '') {
    saveStatus.textContent = message;
    saveStatus.className = ''; // reset
    if (type) saveStatus.classList.add(type);
  }

  // Check if user is signed in
  const { data: { user } } = await supabase.auth.getUser();
const firstChoice = document.getElementById('choice1').value.trim();
  console.log("First choice selected:", firstChoice);

  if (!user) {
    setStatus("You must be signed in to save your choices.", 'error');
    saveBtn.disabled = true;
    return;
  }

  // Check if user already submitted choices
const { data: existingChoices, error: fetchError } = await supabase
  .from('university_choices')
  .select('*')
  .eq('user_id', user.id)
  .maybeSingle();  // returns null if none found, no error

if (fetchError) {
  setStatus("Error checking previous submissions. Please try again later.", 'error');
  saveBtn.disabled = true;
  return;
}

if (existingChoices) {
  setStatus("Sorry, you have already applied. Please check your email, junk folder, or SMS for updates.", 'warning');
  saveBtn.disabled = true;
  return;
}

  // Save button click handler
saveBtn.addEventListener('click', async () => {
  const firstChoice = document.getElementById('choice1').value.trim();
  const firstProgramme = document.getElementById('course1').value.trim();
  const secondChoice = document.getElementById('choice2').value.trim();
  const thirdChoice = document.getElementById('choice3').value.trim();
  const secondProgramme = document.getElementById('course2').value.trim();
  const thirdProgramme = document.getElementById('course3').value.trim();

  console.log("First choice selected:", firstChoice);
  console.log("First programme entered:", firstProgramme);

  if (!firstChoice) {
    setStatus("Please select your 1st university choice before submitting.", "error");
    return;
  } 
  if (!firstProgramme) {
    setStatus("Please enter your 1st programme before submitting.", "error");
    return;
  }
  
  setStatus('Saving your choices...', '');
  saveBtn.disabled = true;

  const { error } = await supabase.from('university_choices').insert([{
    user_id: user.id,
    first_choice: firstChoice,
    second_choice: secondChoice,
    third_choice: thirdChoice,
    first_programme: firstProgramme,
    second_programme: secondProgramme,
    third_programme: thirdProgramme
  }]);

  if (error) {
    console.error(error);
    setStatus("Error saving choices. Please try again.", "error");
    saveBtn.disabled = false;
  } else {
    setStatus("Your university choices have been saved successfully!", "success");
    saveBtn.disabled = true;
  }
});
});

</script>
</body>
</html>
