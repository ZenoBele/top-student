<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Top Student - Reminder Preferences</title>
  <link rel="icon" type="image/png" sizes="32x32" href="../images/favicon.png">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body class="bg-black text-gray-800 font-sans min-h-screen">
  <!-- Top Bar -->
  <header class="flex justify-between items-center bg-gray-900 px-6 py-4 shadow-md">
    <div>
      <h1 class="text-xl font-bold text-white">Top Student</h1>
    </div>
    <div class="flex items-center gap-4">
      <nav class="space-x-4 text-sm">
        <a href="premium.html" class="text-white hover:text-[#0EA5E9]">Dashboard</a>
        <a href="contact.html" class="text-white hover:text-[#0EA5E9]"><i class="fa-solid fa-comments"></i></a>
        <a href="../index.html" class="text-white hover:text-[#0EA5E9]"><i class="fa-solid fa-right-from-bracket"></i></a>
      </nav>
    </div>
  </header>

   <main class="max-w-3xl mx-auto p-8 mt-10 bg-gradient-to-br from-gray-900 via-red-900 to-red-800 rounded-xl shadow-2xl border border-red-600">
<!-- Container to show current reminder info -->
<div id="reminderInfo" class="max-w-3xl mx-auto p-6 mt-8 bg-red-900 text-red-200 rounded-lg shadow-md hidden">
  <h3 class="text-xl font-bold mb-4">Your Current Reminder</h3>
  <p><strong>Topic:</strong> <span id="infoTopic"></span></p>
  <p><strong>Caption:</strong> <span id="infoCaption"></span></p>
  <p><strong>Date:</strong> <span id="infoDate"></span></p>
  <p><strong>Timing:</strong> <span id="infoTiming"></span></p>
  <p><strong>Platforms:</strong> <span id="infoPlatforms"></span></p>


  <button id="cancelReminderBtn" class="mt-6 bg-red-700 hover:bg-red-800 text-white py-2 px-4 rounded">
    Cancel This Reminder & Set New One
  </button>
</div>

<!-- Form container -->
<div id="formContainer">
  <form id="reminderForm" class="space-y-6">
  <h2 class="text-3xl font-extrabold mb-8 text-red-200 text-center tracking-wide">Reminder System Preferences</h2>
  
    <!-- Full Name -->
    <div>
      <label for="fullName" class="block text-red-300 font-semibold mb-2">Full Name</label>
      <input id="fullName" type="text" name="fullName" required placeholder="e.g. Anele Mokoena"
        class="w-full rounded-md p-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-red-500">
    </div>

    <!-- Contact Number -->
    <div>
      <label for="contact" class="block text-red-300 font-semibold mb-2">Contact Number</label>
      <input id="contact" type="tel" name="contact" required placeholder="+27 600 000 000"
        class="w-full rounded-md p-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-red-500">
    </div>

    <!-- Platforms -->
    <div>
      <span class="block text-red-300 font-semibold mb-2">Preferred Platforms</span>
      <div class="space-y-3">
        <label for="platformWhatsApp" class="inline-flex items-center space-x-2">
          <input id="platformWhatsApp" type="checkbox" name="platforms" value="WhatsApp" class="form-checkbox text-red-600">
          <span class="text-red-400">WhatsApp</span>
        </label>
        <label for="platformSMS" class="inline-flex items-center space-x-2">
          <input id="platformSMS" type="checkbox" name="platforms" value="SMS" class="form-checkbox text-red-600">
          <span class="text-red-400">SMS</span>
        </label>
        <label for="platformEmail" class="inline-flex items-center space-x-2">
          <input id="platformEmail" type="checkbox" name="platforms" value="Email" class="form-checkbox text-red-600">
          <span class="text-red-400">Email</span>
        </label>
      </div>
    </div>

    <!-- Reminder Topic -->
    <div>
      <label for="reminderTopic" class="block text-red-300 font-semibold mb-2">Things you need a reminder for</label>
      <input id="reminderTopic" type="text" name="reminderTopic" required
        placeholder="e.g. Life Sciences Study Session or Maths Exam"
        class="w-full rounded-md p-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-red-500">
    </div>

    <!-- Caption -->
    <div>
      <label for="caption" class="block text-red-300 font-semibold mb-2">Caption</label>
      <input id="caption" type="text" name="caption" required
        placeholder="e.g. Remind about Life Sciences study session or Prepare for next week maths exam"
        class="w-full rounded-md p-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-red-500">
    </div>

    <!-- Reminder Date -->
    <div>
      <label for="reminderDate" class="block text-red-300 font-semibold mb-2">Reminder Date</label>
      <input id="reminderDate" type="date" name="reminderDate" required
        class="w-full rounded-md p-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-red-500">
    </div>

    <!-- Reminder Time -->
    <div>
      <label for="timing" class="block text-red-300 font-semibold mb-2">When should we remind you?</label>
      <select id="timing" name="timing" required
        class="w-full rounded-md p-3 text-gray-900 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-red-500">
        <option value="" disabled selected>Select a time</option>
        <option value="1 day before">1 day before</option>
        <option value="1 week before">1 week before</option>
        <option value="1 month before">1 month before</option>
      </select>
    </div>

    <!-- Loading -->
    <p id="loadingText" class="text-red-400 mt-2 hidden font-semibold">Saving your reminder...</p>

    <!-- Submit -->
    <div>
      <button type="submit" class="w-full bg-red-700 hover:bg-red-800 text-white font-bold py-3 rounded-lg shadow-lg transition duration-300">
        Set Preferences
      </button>
    </div>
  </form>
</div>

<div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
  <div class="bg-white rounded-lg shadow-lg max-w-sm w-full p-6">
    <h3 class="text-lg font-semibold mb-4">Confirm Action</h3>
    <p class="mb-6" id="confirmMessage">Are you sure?</p>
    <div class="flex justify-end space-x-4">
      <button id="confirmCancelBtn" class="px-4 py-2 rounded border border-gray-300 hover:bg-gray-100">Cancel</button>
      <button id="confirmOkBtn" class="px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700">Yes, Cancel</button>
    </div>
  </div>
</div>

<div id="notification" class="fixed top-5 right-5 max-w-sm px-4 py-3 rounded shadow-lg text-white text-sm font-semibold hidden z-50"></div>

</main>

  <script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

  const supabase = createClient(
    'https://mlwxxtvsozhwzjxmsvbg.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1sd3h4dHZzb3pod3pqeG1zdmJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4OTAwOTksImV4cCI6MjA2NDQ2NjA5OX0.i9KySUVeot9imnALKr79DYySocuj0_rko4nzPhPxekU'
  );

  const formContainer = document.getElementById('formContainer');
  const form = document.getElementById('reminderForm')
  const loading = document.getElementById('loadingText')
  const notification = document.getElementById('notification');
  const loader = document.getElementById('loader');

    const reminderInfo = document.getElementById('reminderInfo');
const infoTopic = document.getElementById('infoTopic');
const infoCaption = document.getElementById('infoCaption');
const infoDate = document.getElementById('infoDate');
const infoTiming = document.getElementById('infoTiming');
const infoPlatforms = document.getElementById('infoPlatforms');
const cancelBtn = document.getElementById('cancelReminderBtn');

function showNotification(message, type = 'success') {
  notification.textContent = message;
  notification.className = 'fixed top-5 right-5 max-w-sm px-4 py-3 rounded shadow-lg text-white text-sm font-semibold z-50';

  if (type === 'success') {
    notification.classList.add('bg-green-600');
  } else if (type === 'error') {
    notification.classList.add('bg-red-800');
  } else if (type === 'info') {
    notification.classList.add('bg-blue-600');
  }

  notification.classList.remove('hidden');

  setTimeout(() => {
    notification.classList.add('hidden');
  }, 4000);
}

function showConfirm(message = 'Are you sure?') {
  return new Promise((resolve) => {
    const modal = document.getElementById('confirmModal');
    const msgEl = document.getElementById('confirmMessage');
    const btnCancel = document.getElementById('confirmCancelBtn');
    const btnOk = document.getElementById('confirmOkBtn');

    msgEl.textContent = message;
    modal.classList.remove('hidden');

    function cleanup() {
      modal.classList.add('hidden');
      btnCancel.removeEventListener('click', onCancel);
      btnOk.removeEventListener('click', onOk);
    }

    function onCancel() {
      cleanup();
      resolve(false);
    }

    function onOk() {
      cleanup();
      resolve(true);
    }

    btnCancel.addEventListener('click', onCancel);
    btnOk.addEventListener('click', onOk);
  });
}

async function fillReminderInfo(reminder) {
  infoTopic.textContent = reminder.reminder_topic;
  infoCaption.textContent = reminder.caption;
  infoDate.textContent = new Date(reminder.reminder_date).toLocaleDateString();
  infoTiming.textContent = reminder.timing;
  infoPlatforms.textContent = reminder.platforms.join(', ');
}

async function loadUserReminder() {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    // Not logged in - show form, hide reminder info
    formContainer.classList.remove('hidden');
    reminderInfo.classList.add('hidden');
    return;
  }

  const { data: reminder, error } = await supabase
    .from('reminders')
    .select('*')
    .eq('user_id', user.id)
    .maybeSingle();

  if (error) {
    showNotification('Error loading reminder: ' + error.message, 'error');
    formContainer.classList.remove('hidden');
    reminderInfo.classList.add('hidden');
    return;
  }

  if (reminder) {
    // Reminder exists — hide form, show info
    formContainer.classList.add('hidden');
    reminderInfo.classList.remove('hidden');
    await fillReminderInfo(reminder);
  } else {
    // No reminder — show form, hide info
    formContainer.classList.remove('hidden');
    reminderInfo.classList.add('hidden');
  }
}

// Initial load on page open
loadUserReminder();

cancelBtn.addEventListener('click', async () => {
  const confirmed = await showConfirm('Are you sure you want to cancel your current reminder?');
  if (!confirmed) return;

  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    showNotification('You must be logged in to cancel reminders.', 'error');
    return;
  }

  const { error } = await supabase
    .from('reminders')
    .delete()
    .eq('user_id', user.id);

  if (error) {
    showNotification('Failed to cancel reminder: ' + error.message, 'error');
  } else {
    showNotification('Reminder cancelled. You can set a new one now.', 'success');
    // Show form, hide reminder info
    formContainer.classList.remove('hidden');
    reminderInfo.classList.add('hidden');
  }
});

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  loading.classList.remove('hidden');

  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    loading.classList.add('hidden');
    showNotification('You must be logged in.', 'error');
    return;
  }

  const formData = new FormData(form);
  const platforms = formData.getAll('platforms');

  const reminder = {
    user_id: user.id,
    full_name: formData.get('fullName'),
    contact_number: formData.get('contact'),
    platforms: platforms,
    reminder_topic: formData.get('reminderTopic'),
    caption: formData.get('caption'),
    reminder_date: formData.get('reminderDate'),
    timing: formData.get('timing'),
  };

  // Check existing reminder
  const { data: existingReminder, error: checkError } = await supabase
    .from('reminders')
    .select('*')
    .eq('user_id', user.id)
    .maybeSingle();

  if (checkError) {
    loading.classList.add('hidden');
    showNotification('Failed to check existing reminders.', 'error');
    return;
  }

  if (existingReminder) {
    loading.classList.add('hidden');
    showNotification('You already have a reminder set. Please cancel it first before adding a new one.', 'info');
    return;
  }

  // Insert new reminder
  const { data: inserted, error } = await supabase.from('reminders').insert(reminder).select().single();
  loading.classList.add('hidden');

  if (error) {
    showNotification('Error saving reminder: ' + error.message, 'error');
  } else {
    showNotification('Reminder saved successfully!', 'success');
    form.reset();
    // Hide form, show reminder info with inserted data
    formContainer.classList.add('hidden');
    reminderInfo.classList.remove('hidden');
    await fillReminderInfo(inserted);
  }
});
</script>
</body>
</html>
