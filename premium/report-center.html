<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <title>Report Center – Top Student</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen mb-16 p-6 font-sans">

<header class="flex justify-between items-center bg-gray-900 px-6 py-4 shadow-md">
    <div>
      <h1 class="text-xl font-bold text-white">Top Student</h1>
    </div>
    <div class="flex items-center gap-4">
      <nav class="space-x-4 text-sm">
        <a href="premium.html" class="text-white hover:text-[#0EA5E9]">Dashboard</a>
        <a href="contact.html" class="text-white hover:text-[#0EA5E9]"><i class="fa-solid fa-comments"></i></a>
        <a href="../index.html" class="text-white hover:text-[#0EA5E9]"><i class="fa-solid fa-right-from-bracket"></i></a>
      </nav>
    </div>
  </header>

<div class="flex justify-center mt-8">
  <h1 class="text-3xl mb-4 font-bold text-purple-400 flex items-center gap-2 text-center">
    <i class="fas fa-chart-bar text-purple-500"></i>
    Report Center
  </h1>
</div>

    <div id="reports-display" class="space-y-8"></div>

    <div id="empty-msg" class="text-gray-400 text-center mt-10 hidden">
      You don’t have any reports yet.
    </div>
  </div>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  const supabase = createClient(
    'https://mlwxxtvsozhwzjxmsvbg.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1sd3h4dHZzb3pod3pqeG1zdmJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4OTAwOTksImV4cCI6MjA2NDQ2NjA5OX0.i9KySUVeot9imnALKr79DYySocuj0_rko4nzPhPxekU' // YOUR SUPABASE ANON KEY
  );

async function fetchReports() {
  const { data: { user }, error: authError } = await supabase.auth.getUser();

  if (authError || !user) {
    document.getElementById('empty-msg').textContent = 'Please log in to view reports.';
    document.getElementById('empty-msg').classList.remove('hidden');
    return;
  }

  const folderPath = `reports/${user.id}`;

  // List files in the private 'documents/reports/[user_id]' folder
  const { data: files, error } = await supabase
    .storage
    .from('documents')
    .list(folderPath, {
      limit: 100,
      offset: 0,
      sortBy: { column: 'name', order: 'desc' }
    });

  if (error) {
    Swal.fire('Error fetching reports: ' + error.message);
    return;
  }

  const container = document.getElementById('reports-display');
  container.innerHTML = '';

  if (!files || files.length === 0) {
    document.getElementById('empty-msg').classList.remove('hidden');
    return;
  }

  for (const file of files) {
    if (!file.name.endsWith('.pdf')) continue;

    const filePath = `${folderPath}/${file.name}`;

    const { data: signedUrlData, error: urlError } = await supabase
      .storage
      .from('documents')
      .createSignedUrl(filePath, 60 * 60 * 24 * 365); // 1 year

    if (urlError) {
      console.error('Signed URL Error:', urlError.message);
      continue;
    }

    const reportHtml = `
      <div class="bg-gray-800 p-6 rounded-lg shadow border border-purple-600">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg font-semibold text-white">${file.name}</h2>
          <a href="${signedUrlData.signedUrl}" target="_blank" class="text-red-700 hover:underline flex items-center gap-1">
            <i class="fas fa-file-pdf text-red-700"></i> Download PDF
          </a>
        </div>
      </div>
    `;

    container.insertAdjacentHTML('beforeend', reportHtml);
  }
}

fetchReports();
</script>
</body>
</html>
