<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Top Student - Premium Dashboard</title>
  <link rel="icon" type="image/png" sizes="32x32" href="../images/favicon.png">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-black text-white font-sans">

  <!-- Loader -->
<div id="loader" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="loader-container text-center">
    <div class="loader-spinner animate-spin rounded-full h-12 w-12 border-t-4 border-red-500 border-solid border-opacity-70"></div>
    <p class="mt-4 text-white text-sm font-medium">Fetching...</p>
  </div>
  </div>
</div>
  
  <div id="toastBox" class="hidden"></div>

  <!-- Top Bar -->
<header class="bg-gray-900 px-6 py-4 shadow-lg flex flex-col md:flex-row items-center justify-between gap-4">
  <!-- Left: Welcome Message -->
  <div class="max-w-full md:max-w-md truncate text-left">
    <h1 class="text-xl font-bold whitespace-nowrap overflow-hidden text-ellipsis">
      Welcome, <span id="user-name" class="inline-block align-middle">Top Student</span>
    </h1>
    <p class="text-sm text-gray-400 italic truncate" id="greeting">Loading greeting...</p>
  </div>

  <!-- Right: Icons -->
  <nav class="space-x-4 text-sm flex items-center justify-center md:justify-end">
    <a href="contact.html" class="hover:text-red-500" aria-label="Contact chat">
      <i class="fa-solid fa-comments"></i>
    </a>
    <a href="../index.html" class="hover:text-red-500" aria-label="Logout">
      <i class="fa-solid fa-right-from-bracket"></i>
    </a>
  </nav>
</header>

  <main class="p-6 space-y-12">
 
<section class="bg-gray-800 p-6 rounded-2xl shadow-lg">
  <div class="flex flex-col md:flex-row md:justify-between md:items-center gap-4 md:gap-0">
    <!-- Left: Premium label and description -->
    <div class="text-white">
      <h2 class="text-xl font-semibold mb-1 flex items-center gap-2">
        <i class="fas fa-crown text-red-500" aria-hidden="true"></i>
        <span>Premium</span>
      </h2>
      <p class="text-gray-300 text-sm max-w-md">
        All features unlocked: Life after school, priority support, and reports.
      </p>
    </div>

    <!-- Right: Action buttons -->
    <div class="flex flex-wrap gap-3 justify-start md:justify-end">
      <button
  id="open-downgrade-modal"
  type="button"
  class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-xl text-sm font-medium w-full md:w-auto"
>
  Downgrade
</button>

<!-- Modal -->
<div id="downgrade-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="bg-gray-800 text-white rounded-2xl shadow-2xl p-6 max-w-md w-full animate-fade-in">
    <h3 class="text-lg font-bold mb-4 text-red-400">
      ‚ö†Ô∏è Premium Downgrade Warning
    </h3>
    <p class="text-sm text-gray-300 mb-6">
      If you downgrade, you will <strong>lose access</strong> to premium features immediately.<br/>
      You will <strong>not</strong> be able to return here unless you pay the premium access fee ‚Äî even if you downgrade mid-month.
    </p>
    <div class="flex justify-end gap-4">
      <button id="cancel-downgrade" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded-xl text-sm">
        Cancel
      </button>
      <button id="confirm-downgrade" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-xl text-sm font-medium">
        Yes, Downgrade Me
      </button>
    </div>
  </div>
</div>

      <a href="manage.html" aria-label="Manage your Premium subscription">
        <button
          type="button"
          class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-xl text-sm font-medium w-full md:w-auto"
        >
          Manage Subscription
        </button>
      </a>
    </div>
  </div>
</section>

    <!-- Your Services -->
    <section class="grid grid-cols-1 md:grid-cols-2 gap-6">
     <div class="bg-gray-800 p-6 rounded-2xl shadow-lg">
  <h3 class="text-2xl font-extrabold text-white border-b border-gray-700 pb-2">Resources</h3>

<div class="flex flex-col gap-3">
  <!-- Reminder -->
  <a href="reminder.html" class="group bg-gradient-to-r from-gray-800 to-gray-900 p-4 rounded-xl shadow-sm hover:shadow-md transition duration-200">
    <div class="flex items-center gap-2">
      <div class="bg-red-600 text-white p-2 rounded-full text-lg group-hover:scale-105 transition">‚è∞</div>
      <div>
        <h4 class="text-white text-sm font-semibold group-hover:text-red-400">Reminder</h4>
        <p class="text-gray-400 text-xs leading-tight">What's due soon</p>
      </div>
    </div>
  </a>

  <!-- Tips -->
  <a href="tips.html" class="group bg-gradient-to-r from-gray-800 to-gray-900 p-4 rounded-xl shadow-sm hover:shadow-md transition duration-200">
    <div class="flex items-center gap-2">
      <div class="bg-red-600 text-white p-2 rounded-full text-lg group-hover:scale-105 transition">üéØ</div>
      <div>
        <h4 class="text-white text-sm font-semibold group-hover:text-red-400">Tips</h4>
        <p class="text-gray-400 text-xs leading-tight">Career help</p>
      </div>
    </div>
  </a>

  <!-- Exam -->
  <a href="exam.html" class="group bg-gradient-to-r from-gray-800 to-gray-900 p-4 rounded-xl shadow-sm hover:shadow-md transition duration-200">
    <div class="flex items-center gap-2">
      <div class="bg-red-600 text-white p-2 rounded-full text-lg group-hover:scale-105 transition">üìò</div>
      <div>
        <h4 class="text-white text-sm font-semibold group-hover:text-red-400">Exam</h4>
        <p class="text-gray-400 text-xs leading-tight">Prepare now</p>
      </div>
    </div>
  </a>

  <!-- Free Resources -->
  <a href="../resource.html" class="group bg-gradient-to-r from-gray-800 to-gray-900 p-4 rounded-xl shadow-sm hover:shadow-md transition duration-200">
    <div class="flex items-center gap-2">
      <div class="bg-red-600 text-white p-2 rounded-full text-lg group-hover:scale-105 transition">üìÇ</div>
      <div>
        <h4 class="text-white text-sm font-semibold group-hover:text-red-400">Free Resources</h4>
        <p class="text-gray-400 text-xs leading-tight">Guides & tools</p>
      </div>
    </div>
  </a>
</div>
</div>
<div class="bg-gray-800 p-6 rounded-2xl shadow-lg">
  <h3 class="text-2xl font-extrabold text-white border-b border-gray-700 pb-2">Exclusive Access</h3>

  <div class="grid gap-5">
    <!-- Card 1 -->
    <div class="bg-gray-800 p-4 rounded-xl hover:shadow-lg transition group">
      <div class="flex items-center justify-between">
        <div>
          <h4 class="text-lg font-semibold">University Application</h4>
          <p class="text-sm text-gray-400">Start your university journey</p>
        </div>
        <a href="university.html" class="bg-red-900 text-white text-sm font-medium px-4 py-1.5 rounded-md group-hover:bg-white group-hover:text-red-600 transition">Apply</a>
      </div>
    </div>

    <!-- Card 2 -->
    <div class="bg-gray-800 p-4 rounded-xl hover:shadow-lg transition group">
      <div class="flex items-center justify-between">
        <div>
          <h4 class="text-lg font-semibold">NSFAS Application</h4>
          <p class="text-sm text-gray-400">Apply for funding support</p>
        </div>
        <a href="nsfas_terms.html" class="bg-red-900 text-white text-sm font-medium px-4 py-1.5 rounded-md group-hover:bg-white group-hover:text-red-600 transition">Apply</a>
      </div>
    </div>

    <!-- Card 3 -->
    <div class="bg-gray-800 p-4 rounded-xl hover:shadow-lg transition group">
      <div class="flex items-center justify-between">
        <div>
          <h4 class="text-lg font-semibold">Life After School</h4>
          <p class="text-sm text-gray-400">Discipline & adulting tips</p>
        </div>
        <a href="life.html" class="bg-red-900 text-white text-sm font-medium px-4 py-1.5 rounded-md group-hover:bg-white group-hover:text-red-600 transition">Get</a>
      </div>
    </div>

    <!-- Reports -->
    <div class="text-center">
      <a href="report.html" class="inline-block bg-red-600 hover:bg-red-700 text-white text-sm font-semibold px-6 py-2 rounded-full transition duration-200 shadow">
        üìÑ Monthly Reports
      </a>
    </div>
  </div>
</div>
    </section>

    <!-- News Section -->
    <section class="bg-gray-800 p-6 rounded-2xl shadow-lg">
      <h3 class="text-lg font-bold mb-4"> News</h3>
      <a href="../news.html"><div id="news-list" class="space-y-4">
        <!-- News items will load here -->
      </div></a>
    </section>
	
    <!-- Notifications & Activity -->
<section class="grid grid-cols-1 md:grid-cols-2 gap-6">
  <!-- Notifications Panel -->
  <div id="notifications" class="bg-gray-800 p-6 rounded-2xl shadow-lg text-white">
    <h3 class="text-lg font-bold mb-4">üîî Notifications</h3>
    <ul id="notification-list" class="text-sm space-y-2"></ul>
  </div>

<!-- My Journey Panel (Clickable) -->
<div class="bg-gray-800 p-6 rounded-2xl shadow-lg text-white cursor-pointer hover:bg-gray-700 transition" aria-label="View your progress journey">
  <h3 class="text-lg font-bold mb-2">üìä Status</h3>
  <p id="status_text" class="text-sm text-gray-300">No status available.</p>
</div>
</section>

    <!-- Account Info -->
    <section class="bg-gray-800 p-6 rounded-2xl shadow-lg">
      <h3 class="text-lg font-bold mb-4">Your Space</h3>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <a href="profile-view.html" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-xl text-center block">Profile</a>
        <a href="experience.html" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-xl">Share</a>
        <a href="account.html" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-xl text-center block">Settings</a>
        <a href="../index.html" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-xl text-center block">Logout</a>
      </div>
    </section>

  </main>

  <!-- Supabase Script -->
<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  const supabase = createClient(
    'https://mlwxxtvsozhwzjxmsvbg.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1sd3h4dHZzb3pod3pqeG1zdmJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4OTAwOTksImV4cCI6MjA2NDQ2NjA5OX0.i9KySUVeot9imnALKr79DYySocuj0_rko4nzPhPxekU'
  );

  const loader = document.getElementById('loader');

  // Set greeting
  const greetings = [
    "Hope you're smashing goals today!",
    "Great to see you back!",
    "Ready to conquer the day?",
    "Keep pushing, Top Mind!",
    "Another step toward greatness!",
    "Let‚Äôs make progress today!",
    "Focus. Grind. Excel.",
    "Discipline unlocks your future."
  ];
  const greetingEl = document.getElementById('greeting');
  greetingEl.textContent = greetings[Math.floor(Math.random() * greetings.length)];

  // Load profile from sessionStorage
  const profile = JSON.parse(sessionStorage.getItem('user_profile'));
  document.getElementById('user-name').textContent = profile?.first_name || 'Top Student';
  
  function showToast(msg, type = 'info') {
  const toastBox = document.getElementById('toastBox');
  if (!toastBox) return;

  toastBox.textContent = msg;
  toastBox.className = `fixed bottom-6 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded shadow-lg text-white text-sm z-50 ${
    type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600'
  }`;

  toastBox.style.display = 'block';

  setTimeout(() => {
    toastBox.style.display = 'none';
  }, 3500);
}

  // Subscription check
 async function checkSubscriptionStatus() {
  // 1. Check if logged in
  const { data: { user }, error: authError } = await supabase.auth.getUser();

  if (authError || !user) {
    showToast("You're not logged in.", 'error');
    setTimeout(() => {
      window.location.href = '../index.html';
    }, 2000);
    return;
  }

  // 2. Fetch user profile
  const { data: profile, error: profileError } = await supabase
    .from('profiles')
    .select('*')
    .eq('id', user.id)
    .single();

  if (profileError || !profile) {
    showToast("Your profile is missing.", 'error');
    setTimeout(() => {
      window.location.href = '../index.html';
    }, 2000);
    return;
  }

  // 3. Store in session
  sessionStorage.setItem('user_profile', JSON.stringify(profile));
  if (loader) loader.classList.add('hidden');

  // 4. Calculate days since last payment
  const now = new Date();
  const lastPaid = new Date(profile.last_paid_at);
  const daysSince = Math.floor((now - lastPaid) / (1000 * 60 * 60 * 24));

  // 5. Downgrade if expired
  if (daysSince >= 30 && profile.role === 'premium') {
    const { error: updateError } = await supabase
      .from('profiles')
      .update({
        role: 'unpaid',
        previous_role: 'premium',
        status: false
      })
      .eq('id', user.id);

    if (updateError) {
      showToast("Failed to downgrade expired account.", 'error');
      return;
    }

    showToast("‚ö†Ô∏è Your subscription has expired. Redirecting...", 'error');
    setTimeout(() => {
      window.location.href = 'renew.html';
    }, 2500);
  }

  // 6. Warning banner if close to expiring
  else if (daysSince >= 25 && profile.role === 'premium') {
    const banner = document.createElement('div');
    banner.className =
      'relative bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-3 mb-4 text-sm flex items-start justify-between gap-4';
    banner.innerHTML = `
      <div>
        ‚ö†Ô∏è Your subscription expires in <strong>${30 - daysSince}</strong> days.
        <a href="renew.html" class="underline text-yellow-800 hover:text-yellow-600 ml-1">Renew Now</a>
      </div>
      <button id="close-banner" class="font-bold text-lg leading-none text-yellow-700 hover:text-red-600 focus:outline-none">&times;</button>
    `;
    document.body.prepend(banner);

    const closeBtn = document.getElementById('close-banner');
    if (closeBtn) {
      closeBtn.addEventListener('click', () => banner.remove());
    }
  }
}

checkSubscriptionStatus();

  // Load latest news
  const newsList = document.getElementById('news-list');
  async function loadNews() {
    const { data, error } = await supabase
      .from('news')
      .select('*')
      .order('created_at', { ascending: false })
      .limit(3);

    newsList.innerHTML = '';

    if (error) {
      newsList.innerHTML = `<p class="text-red-600">Failed to load news.</p>`;
      console.error(error);
      return;
    }

    if (data.length === 0) {
      newsList.innerHTML = `<p class="text-gray-500">No news at the moment.</p>`;
      return;
    }

    data.forEach(news => {
      const item = document.createElement('div');
      item.className = 'bg-gray-50 p-3 rounded border-l-4 border-red-500';
      item.innerHTML = `
        <p class="font-semibold text-gray-700">
          <i class="fas fa-circle text-[10px] mr-2 text-red-400"></i>${news.title}
        </p>
        <p class="text-sm text-gray-600">${news.body}</p>
      `;
      newsList.appendChild(item);
    });
  }
  loadNews();

  function formatDate(dateStr) {
    const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
    return new Date(dateStr).toLocaleDateString(undefined, options);
  }

  // Get current user ID
  async function getUserId() {
    const { data, error } = await supabase.auth.getUser();
    if (error || !data.user) return null;
    return data.user.id;
  }

  // üîª Downgrade logic
  const openBtn = document.getElementById('open-downgrade-modal');
  const modal = document.getElementById('downgrade-modal');
  const cancelBtn = document.getElementById('cancel-downgrade');
  const confirmBtn = document.getElementById('confirm-downgrade');

  openBtn.addEventListener('click', () => {
    modal.classList.remove('hidden');
  });

  cancelBtn.addEventListener('click', () => {
    modal.classList.add('hidden');
  });

  confirmBtn.addEventListener('click', async () => {
    confirmBtn.disabled = true;
    confirmBtn.textContent = 'Processing...';

    const { data: { user }, error: userError } = await supabase.auth.getUser();
    if (userError || !user) {
      alert("Error verifying user. Please try again.");
      return;
    }

    const { error: updateError } = await supabase
      .from('profiles')
      .update({ role: 'standard' })
      .eq('id', user.id);

    if (updateError) {
     showToast("Downgrade failed. Please try again later.");
      confirmBtn.disabled = false;
      confirmBtn.textContent = 'Yes, Downgrade Me';
      return;
    }

    await supabase.auth.signOut();
setTimeout(() => (window.location.href = '../index.html'), 300);
  });
  
const notificationList = document.getElementById('notification-list');

  async function loadNotifications(userId) {
    const { data, error } = await supabase
      .from('notifications')
      .select('*')
      .eq('user_id', userId)
      .order('created_at', { ascending: false })
      .limit(3);

    if (error || !data) {
      notificationList.innerHTML = '<li class="text-red-400">Could not load notifications.</li>';
      return;
    }

    if (data.length === 0) {
      notificationList.innerHTML = '<li class="text-gray-400">No notifications yet.</li>';
      return;
    }

    notificationList.innerHTML = '';
    data.forEach(item => {
      const li = document.createElement('li');
      li.innerHTML = `
        <div class="bg-red-700 p-3 rounded-lg">
          <div class="flex justify-between items-center">
            <span>${item.message}</span>
            <span class="text-xs text-gray-400">${formatDate(item.created_at)}</span>
          </div>
        </div>
      `;
      notificationList.appendChild(li);
    });
  }

async function fetchStatus() {
  const { data: { user }, error: authError } = await supabase.auth.getUser();

  if (authError || !user) {
    document.getElementById('status_text').textContent = 'Please log in to view your status.';
    return;
  }

  const { data: statusData, error } = await supabase
    .from('status')
    .select('status, created_at')
    .or(`uid.eq.${user.id},uid.is.null`)
    .order('created_at', { ascending: false })
    .limit(1);

  const statusElement = document.getElementById('status_text');

  if (error || !statusData || statusData.length === 0) {
    statusElement.textContent = 'No status available.';
  } else {
    statusElement.textContent = statusData[0].status;
  }
}

document.addEventListener('DOMContentLoaded', () => {
  fetchStatus();

  (async () => {
    const userId = await getUserId();
    if (!userId) {
      showToast("You're not logged in.", 'error');
      setTimeout(() => window.location.href = '../index.html', 2000);
      return;
    }
    await loadNotifications(userId);
  })();
});

document.addEventListener("DOMContentLoaded", async () => {
  const { data: { user } } = await supabase.auth.getUser()
  if (!user) return // not logged in

  const { data: profile, error } = await supabase
    .from('profiles')
    .select('trial, created_at, role')
    .eq('id', user.id)
    .single()

  if (error || !profile?.trial) return

  const createdAt = new Date(profile.created_at)
  const now = new Date()
  const msInDay = 1000 * 60 * 60 * 24
  const daysPassed = Math.floor((now - createdAt) / msInDay)
  const daysLeft = 7 - daysPassed

  if (daysPassed >= 7) {
  // Trial expired ‚Üí Update role and logout
  await supabase
    .from('profiles')
    .update({ role: 'unpaid', previous_role: 'premium', trial: false })
    .eq('id', user.id)

  await Swal.fire({
    icon: 'info',
    title: 'Trial Ended',
    text: 'Your trial has ended. Press OK to renew.',
    confirmButtonText: 'OK'
  })

  window.location.href = 'renew.html'
	  
  } else if (daysLeft <= 2) {
    // Trial expiring soon ‚Üí Alert
    Swal.fire({
      icon: 'warning',
      title: '‚è≥ Trial Almost Over',
      text: `You have only ${daysLeft} day${daysLeft === 1 ? '' : 's'} left in your trial.`,
      confirmButtonText: 'Renew',
      showCancelButton: true,
      cancelButtonText: 'Later',
      confirmButtonColor: 'red',
      cancelButtonColor: '#6b7280'
    }).then((result) => {
      if (result.isConfirmed) {
        window.location.href = 'renew.html'
      }
    })
  }
});
</script>
</body>
</html>