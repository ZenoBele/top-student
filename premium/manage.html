<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manage Subscription ‚Äì Top Student</title>
  <link rel="icon" type="image/png" sizes="32x32" href="../images/favicon.png">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
</head>
<body class="bg-gray-900 min-h-screen font-sans text-white">

  <header class="flex justify-between items-center bg-gray-900 px-6 py-6 shadow-md">
    <h1 class="text-xl font-bold text-white">Top Student</h1>
    <a href="../index.html" class="text-white hover:text-red-500 transition">
      <i class="fa-solid fa-right-from-bracket"></i>
    </a>
  </header>

  <div class="max-w-2xl mx-auto space-y-10 px-4 py-10">
    <!-- Header -->
    <div class="text-center">
      <h1 class="text-3xl font-bold inline-flex items-center gap-2 text-purple-400">
        <i class="fas fa-cog"></i> Manage Your Subscription
      </h1>
      <p class="text-sm text-gray-300 mt-1">Customize and control your Top Student subscription below.</p>
    </div>

    <!-- Subscription Info -->
    <div class="bg-gray-800 shadow-lg rounded-xl p-6 space-y-4 text-center">
      <h2 class="text-xl font-semibold text-red-500">
        <i class="fas fa-star"></i> Current Plan: <span class="font-bold">Premium</span>
      </h2>
      <p class="text-sm text-gray-300">Monthly Price: <strong>R299</strong></p>
      <p class="text-sm text-gray-300">Status: <span id="statusLabel" class="font-medium text-green-400">Loading...</span></p>
    </div>

    <!-- Actions -->
    <div class="grid gap-4 sm:grid-cols-2">
      <button id="btn-view" class="flex items-center justify-between p-4 bg-gradient-to-r from-red-600 to-purple-700 text-white rounded-xl shadow hover:opacity-90 transition">
        <span><i class="fas fa-arrow-up mr-2"></i> View Premium</span>
        <i class="fas fa-chevron-right"></i>
      </button>

      <button id="btn-pause" class="flex items-center justify-between p-4 bg-gradient-to-r from-gray-700 to-gray-500 text-white rounded-xl shadow hover:opacity-90 transition">
        <span><i class="fas fa-pause-circle mr-2"></i> Pause Subscription</span>
        <i class="fas fa-chevron-right"></i>
      </button>

      <button id="btn-resume" class="flex items-center justify-between p-4 bg-gradient-to-r from-green-600 to-green-400 text-white rounded-xl shadow hover:opacity-90 transition">
        <span><i class="fas fa-play-circle mr-2"></i> Resume Subscription</span>
        <i class="fas fa-chevron-right"></i>
      </button>

      <button id="btn-history" class="flex items-center justify-between p-4 bg-gradient-to-r from-purple-600 to-indigo-400 text-white rounded-xl shadow hover:opacity-90 transition">
        <span><i class="fas fa-clock mr-2"></i> View Payment History</span>
        <i class="fas fa-chevron-right"></i>
      </button>
    </div>

    <!-- Back -->
    <div class="text-center mt-10">
      <button id="btn-back-dashboard" class="inline-block text-purple-400 hover:text-red-500 text-sm transition">
        <i class="fas fa-arrow-left"></i> Back
      </button>
    </div>
  </div>

  <!-- Toast -->
  <div id="toastBox" class="hidden fixed bottom-6 left-1/2 transform -translate-x-1/2 text-white text-sm px-6 py-3 rounded shadow-lg z-50"></div>

  <!-- Confirm Modal -->
  <div id="confirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-gray-800 rounded-lg shadow-lg max-w-sm w-full p-6 text-center space-y-6">
      <p id="confirmMessage" class="text-white text-lg font-semibold"></p>
      <div class="flex justify-center gap-4">
        <button id="confirmCancel" class="px-5 py-2 rounded bg-gray-600 text-white hover:bg-gray-500 transition">Cancel</button>
        <button id="confirmOk" class="px-5 py-2 rounded bg-purple-600 text-white hover:bg-purple-700 transition">Confirm</button>
      </div>
    </div>
  </div>

<div id="loader" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
  <div class="loader-container text-center">
    <div class="loader-spinner animate-spin rounded-full h-12 w-12 border-t-4 border-purple-500 border-solid border-opacity-40"></div>
    <p class="mt-4 text-white text-sm font-medium">Processing...</p>
  </div>
</div>

  <script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  const supabase = createClient(
    'https://mlwxxtvsozhwzjxmsvbg.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1sd3h4dHZzb3pod3pqeG1zdmJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4OTAwOTksImV4cCI6MjA2NDQ2NjA5OX0.i9KySUVeot9imnALKr79DYySocuj0_rko4nzPhPxekU'
  );

  const loader = document.getElementById('loader');
  const toastBox = document.getElementById('toastBox');
  const statusLabel = document.getElementById('statusLabel');

  function showToast(msg, type = 'info') {
    toastBox.textContent = msg;
    toastBox.className = `fixed bottom-6 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded shadow-lg text-white text-sm z-50 ${
      type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600'
    }`;
    toastBox.style.display = 'block';
    setTimeout(() => {
      toastBox.style.display = 'none';
    }, 3500);
  }

  function showConfirm(message) {
    return new Promise((resolve) => {
      const modal = document.getElementById('confirmModal');
      document.getElementById('confirmMessage').textContent = message;
      modal.classList.remove('hidden');

      const ok = document.getElementById('confirmOk');
      const cancel = document.getElementById('confirmCancel');

      function cleanup() {
        ok.removeEventListener('click', onOk);
        cancel.removeEventListener('click', onCancel);
      }

      function onOk() {
        cleanup();
        modal.classList.add('hidden');
        resolve(true);
      }

      function onCancel() {
        cleanup();
        modal.classList.add('hidden');
        resolve(false);
      }

      ok.addEventListener('click', onOk);
      cancel.addEventListener('click', onCancel);
    });
  }

  async function getUser() {
    const { data: { user }, error } = await supabase.auth.getUser();
    if (error || !user) {
      showToast("You're not logged in.", 'error');
      return null;
    }
    return user;
  }

  function updateStatusLabel(status) {
    if (!statusLabel) return;
    if (status === true) {
      statusLabel.textContent = 'Active';
      statusLabel.classList.remove('text-gray-500');
      statusLabel.classList.add('text-green-600');
    } else {
      statusLabel.textContent = 'Paused';
      statusLabel.classList.remove('text-green-600');
      statusLabel.classList.add('text-gray-500');
    }
  }

  // Page load: update status label
  window.addEventListener('DOMContentLoaded', async () => {
    const user = await getUser();
    if (!user) return;

    const { data, error } = await supabase
      .from('profiles')
      .select('status')
      .eq('id', user.id)
      .single();

    if (!error && data) {
      updateStatusLabel(data.status);
    }
  });

  // Button logic
  const viewBtn = document.getElementById('btn-view');
  const pauseBtn = document.getElementById('btn-pause');
  const resumeBtn = document.getElementById('btn-resume');
  const historyBtn = document.getElementById('btn-history');
  const backBtn = document.getElementById('btn-back-dashboard');

  viewBtn.addEventListener('click', () => {
    window.location.href = 'view-premium.html';
  });

  pauseBtn.addEventListener('click', async () => {
    const confirmed = await showConfirm("Pause (downgrade) your subscription?");
    if (!confirmed) return;

    loader.classList.remove('hidden');
    const user = await getUser();
    if (!user) {
      loader.classList.add('hidden');
      return;
    }

    const { data, error: fetchErr } = await supabase
      .from('profiles')
      .select('role')
      .eq('id', user.id)
      .single();

    if (fetchErr || !data?.role) {
      loader.classList.add('hidden');
      showToast("Failed to fetch your current role.", 'error');
      return;
    }

    const currentRole = data.role;
    if (currentRole === 'unpaid') {
  loader.classList.add('hidden');
  Swal.fire({
    icon: 'info',
    title: 'Your Access is Paused',
    text: "Your trial has ended or subscription is paused. Would you like to renew now?",
    showCancelButton: true,
    confirmButtonText: 'Renew Now',
    cancelButtonText: 'Cancel'
  }).then((result) => {
    if (result.isConfirmed) {
      window.location.href = 'renew.html';
    }
  });
  return;
}

    const { error } = await supabase
      .from('profiles')
      .update({
        previous_role: currentRole,
        role: 'unpaid',
        status: false
      })
      .eq('id', user.id);

    loader.classList.add('hidden');

    if (error) {
      showToast("Could not pause your subscription.", 'error');
    } else {
      updateStatusLabel(false);
      showToast("Subscription paused. You‚Äôre now on the unpaid plan.", 'success');
      await supabase.auth.signOut();
      setTimeout(() => window.location.href = '../index.html', 2000);
    }
  });

resumeBtn.addEventListener('click', async () => {
  const confirmed = await showConfirm("Resume your subscription?");
  if (!confirmed) return;

  loader.classList.remove('hidden');

  const user = await getUser();
  if (!user) {
    loader.classList.add('hidden');
    return;
  }

  // üîç Fetch both previous_role and status
  const { data, error: fetchErr } = await supabase
    .from('profiles')
    .select('previous_role, status')
    .eq('id', user.id)
    .single();

  if (fetchErr || !data) {
    loader.classList.add('hidden');
    showToast("Could not check your subscription status.", 'error');
    return;
  }

  // üîÅ If previous_role exists and status is true, redirect to renew.html
  if (data.previous_role && data.status === true) {
    loader.classList.add('hidden');
    window.location.href = 'renew.html';
    return;
  }

  // ‚úÖ Continue with resume process
  const { error } = await supabase
    .from('profiles')
    .update({
      role: data.previous_role,
      previous_role: null,
      status: true
    })
    .eq('id', user.id);

  loader.classList.add('hidden');

  if (error) {
    showToast("Failed to resume subscription.", 'error');
  } else {
    updateStatusLabel(true);
    showToast("Subscription resumed. Welcome back!", 'success');
  }
});

  historyBtn.addEventListener('click', () => {
    window.location.href = 'invoices.html';
  });

  backBtn.addEventListener('click', async () => {
  loader.classList.add('hidden');

  const user = await getUser();
  if (!user) {
    loader.classList.add('hidden');
    return;
  }

  const { data, error } = await supabase
    .from('profiles')
    .select('role, status')
    .eq('id', user.id)
    .single();

  loader.classList.add('hidden');

  if (error || !data) {
    showToast("Could not check your account.", 'error');
    return;
  }

  const isPaused = !data.status;
  const key = `pause_attempts_${user.id}`;

  if (isPaused) {
    let attempts = parseInt(localStorage.getItem(key) || '0', 10);
    attempts++;

    if (attempts >= 3) {
      const { error: inactiveErr } = await supabase
        .from('profiles')
        .update({ is_active: 'false' })
        .eq('id', user.id);

      if (inactiveErr) {
        showToast("Failed to mark account inactive.", 'error');
      } else {
        showToast("‚ùå Account marked inactive. Redirecting...", 'error');
        localStorage.removeItem(key); // ‚úÖ clear attempts
        await supabase.auth.signOut();
        setTimeout(() => {
          window.location.href = '../index.html';
        }, 2500);
      }

      return;
    }

    localStorage.setItem(key, attempts);

    if (attempts === 2) {
      showToast("‚ö†Ô∏è Final warning: Resume your subscription to avoid being blocked.", 'error');
    } else {
      showToast("‚è∏Ô∏è You're paused. Resume to access dashboard. Attempt 1 of 2.", 'info');
    }

    return; // Don't continue if paused
  } else {
    // ‚úÖ Reset attempts if they resumed
    localStorage.removeItem(key);

    // ‚úÖ Continue to dashboard
    if (data.role === 'premium') {
      window.location.href = 'premium.html';
    } else {
      window.location.href = '../index.html';
    }
  }
});
</script>
</body>
</html>