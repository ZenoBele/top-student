<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Exam Tips & Advice - Top Student</title>
  <link rel="icon" type="image/png" sizes="32x32" href="../images/favicon.png">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body class="bg-black text-white font-sans">

  <!-- Header -->
  <header class="flex justify-between items-center bg-gray-900 px-6 py-4 shadow-md">
    <h1 class="text-xl font-bold text-white">Top Student</h1>
    <nav class="flex gap-4 text-sm text-white">
      <a href="premium.html" class="hover:text-[#0EA5E9]">Dashboard</a>
      <a href="contact.html" class="hover:text-[#0EA5E9]"><i class="fa-solid fa-comments"></i></a>
      <a href="../index.html" class="hover:text-[#0EA5E9]"><i class="fa-solid fa-right-from-bracket"></i></a>
    </nav>
  </header>

  <!-- Main Content -->
  <main class="max-w-6xl mx-auto p-6 mt-10 space-y-10">

    <!-- Top Exam Tips -->
    <section class="bg-gray-800 p-6 rounded shadow-md">
      <h2 class="text-xl font-bold mb-4 text-red-600">Top 10 Exam Tips That Work</h2>
      <ul class="list-decimal pl-6 space-y-2 text-gray-300 text-sm">
        <li>Use past exam papers under timed conditions.</li>
        <li>Summarize each topic into flashcards or short notes.</li>
        <li>Teach what you’ve learned to someone else to test your understanding.</li>
        <li>Use the Pomodoro method (25min focus + 5min rest) for effective study blocks.</li>
        <li>Sleep at least 7–8 hours per night, especially before an exam.</li>
        <li>Start with difficult subjects when your energy is highest.</li>
        <li>Revise consistently every day, not just before the exam.</li>
        <li>Highlight keywords in questions to avoid misinterpreting them.</li>
        <li>Eat healthy brain fuel (e.g. eggs, fish, nuts) and stay hydrated.</li>
        <li>Practice writing full answers—not just reading—to build memory and speed.</li>
      </ul>
    </section>

    <!-- Custom Strategy Request -->
    <section class="bg-gray-800 p-6 rounded shadow-md">
      <h2 class="text-xl font-semibold mb-4 text-red-600">Request Your Personal Exam Strategy</h2>
      <p class="text-sm text-gray-400 mb-4 italic">
        These personal tips are reviewed and crafted by top student team. They've perfected these study strategies. 
        You’ll receive advice designed for your subject and situation.
      </p>
      <form id="adviceForm" class="space-y-4">
        <input type="text" name="fullName" id="fullName" placeholder="Full Name" required class="w-full p-2 border border-gray-600 rounded bg-black text-white">
        <input type="text" name="contact" id="contact" placeholder="Contact Number" required class="w-full p-2 border border-gray-600 rounded bg-black text-white">
        <input type="text" name="subject" id="subject" placeholder="Subject" required class="w-full p-2 border border-gray-600 rounded bg-black text-white">
        <textarea name="message" id="message" placeholder="Optional message..." class="w-full p-2 border border-gray-600 rounded bg-black text-white"></textarea>
        <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Submit Request</button>
        <p id="adviceError" class="hidden text-red-600 font-bold mt-2"></p>
        <p id="adviceSuccess" class="text-red-600 text-sm hidden mt-2">Request submitted!</p>
      </form>
    </section>

    <!-- Downloads Section (Empty for now) -->
    <section class="w-[90%] mx-auto mt-10 bg-gray-800 p-6 rounded shadow-md">
      <h2 class="text-xl font-bold mb-4 text-red-600">Top Strategy Tips</h2>
      <div id="strategyTipsList" class="space-y-4 text-sm text-gray-300">
        <p class="italic text-gray-500">Loading tips...</p>
      </div>
    </section>

  </main>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  const supabase = createClient(
    'https://mlwxxtvsozhwzjxmsvbg.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1sd3h4dHZzb3pod3pqeG1zdmJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4OTAwOTksImV4cCI6MjA2NDQ2NjA5OX0.i9KySUVeot9imnALKr79DYySocuj0_rko4nzPhPxekU'
  );

  // Force restore user session (important)
  await supabase.auth.getSession();

  const form = document.getElementById('adviceForm');
  const errorText = document.getElementById('adviceError');
  const successText = document.getElementById('adviceSuccess');
  const tipList = document.getElementById('strategyTipsList');
  const submitBtn = form.querySelector('button[type="submit"]');

  function getCurrentTermRange() {
  const now = new Date();
  const year = now.getFullYear();
  const month = now.getMonth() + 1;

  let termStart, termEnd;

  if (month >= 1 && month <= 3) {
    termStart = new Date(`${year}-01-01`);
    termEnd = new Date(`${year}-03-31`);
  } else if (month >= 4 && month <= 6) {
    termStart = new Date(`${year}-04-01`);
    termEnd = new Date(`${year}-06-30`);
  } else if (month >= 7 && month <= 9) {
    termStart = new Date(`${year}-07-01`);
    termEnd = new Date(`${year}-09-30`);
  } else {
    termStart = new Date(`${year}-10-01`);
    termEnd = new Date(`${year}-12-31`);
  }

  return { termStart, termEnd };
}

  function createLoader() {
    const loader = document.createElement('div');
    loader.className = "inline-block w-5 h-5 border-4 border-t-4 border-gray-200 border-t-blue-600 rounded-full animate-spin ml-2";
    loader.setAttribute('aria-label', 'Loading');
    return loader;
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    errorText.classList.add('hidden');
    successText.classList.add('hidden');

    submitBtn.disabled = true;
    const loader = createLoader();
    submitBtn.appendChild(loader);

    const { termStart, termEnd } = getCurrentTermRange();
    const fullName = document.getElementById('fullName').value.trim();
    const contact = document.getElementById('contact').value.trim();
    const subject = document.getElementById('subject').value.trim();
    const message = document.getElementById('message').value.trim();

    const { data: { user }, error: authError } = await supabase.auth.getUser();

    if (authError || !user) {
      loader.remove();
      submitBtn.disabled = false;
      errorText.textContent = "You must be logged in to request advice.";
      errorText.classList.remove('hidden');
      return;
    }

        console.log("User ID:", user.id);

    const { data: requests, error: countError } = await supabase
  .from('strategy_requests')
  .select('id')
  .gte('created_at', termStart.toISOString())
  .lte('created_at', termEnd.toISOString())
  .eq('user_id', user.id);

    if (countError) {
      loader.remove();
      submitBtn.disabled = false;
      console.error("Count error:", countError);
      errorText.textContent = "Failed to verify request limit.";
      errorText.classList.remove('hidden');
      return;
    }

    console.log("Requests found this term:", requests.length);

    if (requests.length >= 4) {
      loader.remove();
      submitBtn.disabled = false;
      errorText.textContent = "Limit reached: You’ve already made 4 requests this term. New requests will open next term.";
      errorText.classList.remove('hidden');
      return;
    }

    const { error } = await supabase.from('strategy_requests').insert([
      { full_name: fullName, contact, subject, message, user_id: user.id }
    ]);

    loader.remove();
    submitBtn.disabled = false;

    if (error) {
      console.error("Insert error:", error);
      errorText.textContent = "Failed to submit. Try again.";
      errorText.classList.remove('hidden');
    } else {
      successText.classList.remove('hidden');
      form.reset();
    }
  });

  async function loadStrategies() {
    tipList.innerHTML = '';
    const loader = createLoader();
    tipList.appendChild(loader);

    const { data, error } = await supabase
      .from('strategy_sent')
      .select('*')
      .order('created_at', { ascending: false });

    loader.remove();

    if (error) {
      tipList.innerHTML = '<p class="text-red-500">Failed to load strategies.</p>';
      console.error("Load error:", error);
      return;
    }

    if (data.length === 0) {
      tipList.innerHTML = '<p class="text-gray-500 italic">No strategies available yet.</p>';
      return;
    }

    data.forEach((tip) => {
      const item = document.createElement('div');
      item.className = 'p-4 border rounded bg-gray-50 mb-3';

      item.innerHTML = `
        <h3 class="font-semibold text-lg text-green-800 mb-1">${tip.title}</h3>
        <p class="text-sm mb-2"><strong>Subject:</strong> ${tip.subject}</p>
        <p class="text-sm mb-2"><strong>From:</strong> ${tip.author_type}</p>
        ${
          tip.is_pdf && tip.file_url
            ? `<a href="${tip.file_url}" target="_blank" class="text-blue-600 underline text-sm">Download PDF</a>`
            : `<p class="text-gray-700 whitespace-pre-wrap">${tip.strategy}</p>`
        }
      `;

      tipList.appendChild(item);
    });
  }

  loadStrategies();
</script>
</body>
</html>
