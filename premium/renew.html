<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Renew Subscription - Top Student</title>
  <link rel="icon" type="image/png" sizes="32x32" href="../images/favicon.png">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gradient-to-b from-black to-red-800 min-h-screen px-4 py-10 font-sans text-gray-800">

  <div class="max-w-xl mx-auto space-y-8">
    <header class="text-center">
      <h1 class="text-3xl font-bold text-red-600">Renew Your Subscription</h1>
      <p class="text-sm text-gray-500 mt-2">Your previous plan has expired. Continue your journey with Top Student below.</p>
    </header>

    <div id="loader" class="text-center text-gray-500">Checking your plan...</div>

    <div id="renewCards" class="space-y-6 hidden">
      <!-- Plan card injected here -->
    </div>

    <div class="text-center pt-4">
      <button id="backBtn" class="text-yellow-400 hover:underline">Back</button>
    </div>
  </div>

<script type="module"> 
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  const supabase = createClient(
    'https://mlwxxtvsozhwzjxmsvbg.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1sd3h4dHZzb3pod3pqeG1zdmJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4OTAwOTksImV4cCI6MjA2NDQ2NjA5OX0.i9KySUVeot9imnALKr79DYySocuj0_rko4nzPhPxekU'
  );

  const loader = document.getElementById('loader');
  const renewCards = document.getElementById('renewCards');
  const backBtn = document.getElementById('backBtn');

  const payfastConfig = {
    merchant_id: '30322591',
    merchant_key: 'b7owp8kz6kmgz',
    return_url: 'https://topstudent.co.za/payment-success.html',
    cancel_url: 'https://topstudent.co.za/payment-canceled.html',
    notify_url: 'https://mlwxxtvsozhwzjxmsvbg.supabase.co/functions/v1/payfast-webhook'
  };

  const planDetails = {
    standard: {
      title: "Standard",
      amount: 199,
      description: "Access exam papers, study guides, tips, and basic support.",
      btnText: "Renew Standard"
    },
    premium: {
      title: "Premium",
      amount: 299,
      description: "Everything in Standard plus life after school, priority support, and reminders.",
      btnText: "Renew Premium"
    }
  };

  function buildPayfastUrl(plan, userId) {
    const params = new URLSearchParams({
      merchant_id: payfastConfig.merchant_id,
      merchant_key: payfastConfig.merchant_key,
      amount: plan.amount.toString(),
      item_name: `TopStudent${plan.title.replace(/\s/g, '')}`,
      return_url: payfastConfig.return_url,
      cancel_url: payfastConfig.cancel_url,
      notify_url: payfastConfig.notify_url,
	  email_address: user.email,
      custom_str1: userId,
      custom_str2: plan.title
    });

    return `https://www.payfast.co.za/eng/process?${params.toString()}`;
  }

  function showPlanCard(type, userId) {
    const plan = planDetails[type];
    const paymentLink = buildPayfastUrl(plan, userId);

    const card = document.createElement('div');
    card.className = "bg-gray-800 p-6 rounded shadow text-center space-y-4";

    card.innerHTML = `
      <h2 class="text-xl font-bold text-green-500">${plan.title}</h2>
      <p class="text-lg text-green-500 font-medium">R${plan.amount} / month</p>
      <p class="text-sm text-white">${plan.description}</p>
      <a href="${paymentLink}" class="inline-block mt-2 bg-green-600 text-white px-5 py-2 rounded hover:bg-green-700 transition">
        ${plan.btnText}
      </a>
    `;

    renewCards.appendChild(card);
  }

  async function getUser() {
    const { data, error } = await supabase.auth.getUser();
    const user = data?.user || null;
    if (error || !user) return null;
    return user;
  }

  async function loadRenewalOption() {
    const user = await getUser();
    if (!user) {
      loader.textContent = "Not logged in.";
      return;
    }

    const { data, error } = await supabase
      .from('profiles')
      .select('role, previous_role')
      .eq('id', user.id)
      .single();

    loader.style.display = 'none';

    if (error || !data) {
      loader.textContent = "Unable to retrieve your subscription info.";
      return;
    }

    const plan = data.previous_role || data.role || null;
    if (plan === 'standard' || plan === 'premium') {
      showPlanCard(plan, user.id);
      renewCards.classList.remove('hidden');
    } else {
      loader.textContent = "No previous plan found. Please contact support.";
    }
  }

  backBtn.addEventListener('click', async () => {
    const user = await getUser();
    if (!user) return;

    const { data, error } = await supabase
      .from('profiles')
      .select('role')
      .eq('id', user.id)
      .single();

    if (error || !data?.role) {
      alert("Could not load your dashboard.");
      return;
    }

    if (data.role === 'premium') {
      window.location.href = 'premium.html';
    } else {
      window.location.href = '../index.html';
    }
  });

  // Start
  loadRenewalOption();
</script>
</body>
</html>
