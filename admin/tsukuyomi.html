<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Top Student Work Log</title>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      color: #333;
    }
    .primary-bg {
      background-color: #003366;
    }
    .primary-text {
      color: #1e293b;
    }
    .accent-bg {
      background-color: #33aaff;
    }
    .primary-text {
      color: #003366;
    }
    .accent-text {
      color: #33aaff;
    }
    .header-gradient {
      background: linear-gradient(to right, #003366, #33aaff);
    }
  </style>
</head>
<body class="bg-white min-h-screen">

<header class="header-gradient p-6 text-white font-sans shadow-md">
  <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
    <!-- Logo / Title -->
    <div class="flex items-center space-x-3">
      <i class="fas fa-graduation-cap text-2xl"></i>
      <h1 class="text-2xl font-bold">Top Student Admin</h1>
    </div>

    <!-- Navigation Links -->
    <nav>
      <ul class="flex space-x-6 text-white font-medium">
        <li><a href="index.html" class="hover:bg-white hover:text-blue-800 px-3 py-2 rounded transition"><i class="fas fa-house mr-1"></i> Home</a></li>
        <li><a href="tsukuyomi.html" class="hover:bg-white hover:text-blue-800 px-3 py-2 rounded transition"><i class="fas fa-clipboard-list mr-1"></i> Work Log</a></li>
        <li><a href="data.html" class="hover:bg-white hover:text-blue-800 px-3 py-2 rounded transition"><i class="fas fa-chart-line mr-1"></i> Data</a></li>
		<li><a href="pattern.html" class="hover:bg-white hover:text-blue-800 px-3 py-2 rounded transition"><i class="fas fa-chalkboard mr-1"></i> Pattern</a></li>
      </ul>
    </nav>
  </div>
</header>

  <div class="primary-text mt-4 p-6 text-center shadow-lg">
    <div class="flex flex-col md:flex-col md:items-center">
      <h1 class="text-3xl font-bold mb-2">Work Log</h1>
      <p class="opacity-80">Track your daily calls, follow-ups, demos & feedback</p>
    </div>
  </div>

  <!-- Page Container -->
  <div class="max-w-6xl mx-auto p-6">

    <!-- Quick Add Panel -->
    <section class="bg-white shadow rounded-lg p-6 mb-8 border border-gray-200">
      <h2 class="text-xl font-semibold primary-text mb-4">Log New Activity</h2>
      <form id="workLogForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        
        <!-- Activity Type -->
        <div>
          <label class="block primary-text mb-1 font-medium">Activity Type</label>
          <select id="activityType" class="w-full border border-gray-300 rounded-lg p-2 focus:outline-none">
            <option value="Call">Call</option>
            <option value="Follow-up">Follow-up</option>
            <option value="Demo">Demo</option>
            <option value="Feedback">Feedback</option>
          </select>
        </div>

        <!-- School / Contact -->
        <div>
          <label class="block primary-text mb-1 font-medium">School / Contact Name</label>
          <input type="text" id="contactName" placeholder="Eg. St. Mary's High - Principal"
                 class="w-full border border-gray-300 rounded-lg p-2 focus:outline-none">
        </div>

        <div>
          <label class="block primary-text mb-1 font-medium">Contact</label>
          <input type="number" id="phone" placeholder="0712345678"
                 class="w-full border border-gray-300 rounded-lg p-2 focus:outline-none">
        </div>

        <!-- Status -->
        <div>
          <label class="block primary-text mb-1 font-medium">Status</label>
          <select id="status" class="w-full border border-gray-300 rounded-lg p-2 focus:outline-none">
            <option value="Interested">Interested</option>
            <option value="Not Interested">Not Interested</option>
            <option value="Pending">Pending</option>
            <option value="Confirmed">Confirmed</option>
          </select>
        </div>

        <!-- Next Step -->
        <div>
          <label class="block primary-text mb-1 font-medium">Next Step</label>
          <input type="text" id="nextStep" placeholder="Eg. Schedule demo next week"
                 class="w-full border border-gray-300 rounded-lg p-2 focus:outline-none">
        </div>

        <!-- Notes -->
        <div class="md:col-span-2">
          <label class="block primary-text mb-1 font-medium">Notes</label>
          <textarea id="notes" rows="3"
                    class="w-full border border-gray-300 rounded-lg p-2 focus:outline-none"
                    placeholder="Details of the call or meeting"></textarea>
        </div>

        <!-- Submit -->
        <div class="md:col-span-2 flex justify-end">
          <button type="submit" class="primary-bg text-white px-6 py-2 rounded-lg shadow hover:bg-blue-900 transition">
            Save Entry
          </button>
        </div>
      </form>
    </section>

    <!-- Dashboard Stats -->
    <section class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
      <div class="header-gradient text-white rounded-lg p-4 text-center shadow">
        <p class="text-sm">Calls Today</p>
        <p id="callsToday" class="text-2xl font-bold">0</p>
      </div>
      <div class="header-gradient text-white rounded-lg p-4 text-center shadow">
        <p class="text-sm">Follow-ups</p>
        <p id="followUps" class="text-2xl font-bold">0</p>
      </div>
      <div class="header-gradient text-white rounded-lg p-4 text-center shadow">
        <p class="text-sm">Demos/Trials</p>
        <p id="demos" class="text-2xl font-bold">0</p>
      </div>
      <div class="header-gradient text-white rounded-lg p-4 text-center shadow">
        <p class="text-sm">Feedbacks</p>
        <p id="feedbacks" class="text-2xl font-bold">0</p>
      </div>
    </section>

    <!-- Activity Log Table -->
<section class="bg-white shadow rounded-lg p-6 border border-gray-200">
  <h2 class="text-xl font-semibold primary-text mb-4">Activity Log</h2>
  <div class="overflow-x-auto">
    <table class="min-w-full border border-gray-200 text-sm text-left">
      <thead class="primary-bg text-white">
        <tr>
          <th class="px-4 py-2 border">Date</th>
          <th class="px-4 py-2 border">School / Name</th>
          <th class="px-4 py-2 border">Contact</th>
          <th class="px-4 py-2 border">Type</th>
          <th class="px-4 py-2 border">Status</th>
          <th class="px-4 py-2 border">Notes</th>
          <th class="px-4 py-2 border">Next Step</th>
          <th class="px-4 py-2 border">Action</th>
        </tr>
      </thead>
      <tbody id="activityTable">
        <!-- Rows inserted dynamically -->
      </tbody>
    </table>
  </div>
</section>

  </div>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  const supabase = createClient(
    'https://mlwxxtvsozhwzjxmsvbg.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1sd3h4dHZzb3pod3pqeG1zdmJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4OTAwOTksImV4cCI6MjA2NDQ2NjA5OX0.i9KySUVeot9imnALKr79DYySocuj0_rko4nzPhPxekU'
  );
  
const workLogForm = document.getElementById('workLogForm');
const activityTable = document.getElementById('activityTable');

// Get current user
async function getCurrentUser() {
  const { data: { session }, error: sessionError } = await supabase.auth.getSession();
  if (sessionError) throw sessionError;
  if (!session || !session.user) throw new Error("User not logged in");
  return session.user;
}

// Check auth & redirect
async function checkAuth() {
  try {
    const user = await getCurrentUser();
    return user;
  } catch {
    Swal.fire({
      icon: 'warning',
      title: 'Not Logged In',
      text: 'You must be logged in to access this page.',
      confirmButtonText: 'OK'
    }).then(() => window.location.href = "login.html");
  }
}

// Load activity log
async function loadActivityLog() {
  try {
    const user = await getCurrentUser();

    Swal.fire({
      title: 'Loading activity log...',
      allowOutsideClick: false,
      didOpen: () => Swal.showLoading()
    });

    const { data, error } = await supabase
      .from('work_log')
      .select('*')
      .eq('user_id', user.id)
      .order('created_at', { ascending: false });

    Swal.close();

    if (error) throw error;

    activityTable.innerHTML = '';
    data.forEach(entry => {
      const tr = document.createElement('tr');
      tr.classList.add('border-b');

      tr.innerHTML = `
        <td class="px-4 py-2 border">${new Date(entry.created_at).toLocaleString()}</td>
        <td class="px-4 py-2 border">${entry.contact_name}</td>
        <td class="px-4 py-2 border">${entry.contact_number || ''}</td>
        <td class="px-4 py-2 border">${entry.activity_type}</td>
        <td class="px-4 py-2 border" contenteditable="true" data-field="status">${entry.status}</td>
        <td class="px-4 py-2 border" contenteditable="true" data-field="notes">${entry.notes || ''}</td>
        <td class="px-4 py-2 border" contenteditable="true" data-field="next_step">${entry.next_step || ''}</td>
        <td class="px-4 py-2 border">
          <button class="bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600" data-id="${entry.id}">Save</button>
        </td>
      `;
      activityTable.appendChild(tr);
    });

    // Attach save handlers for inline update
    activityTable.querySelectorAll('button').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.dataset.id;
        const tr = btn.closest('tr');

        const updatedFields = {
          status: tr.querySelector('[data-field="status"]').innerText.trim(),
          notes: tr.querySelector('[data-field="notes"]').innerText.trim(),
          next_step: tr.querySelector('[data-field="next_step"]').innerText.trim(),
        };

        const original = data.find(d => d.id == id);
        const hasChanged = Object.keys(updatedFields).some(
          key => updatedFields[key] !== (original[key] || '')
        );
        if (!hasChanged) return Swal.fire({
          icon: 'info',
          title: 'No Changes',
          text: 'Nothing to update!'
        });

        Swal.fire({ title: 'Updating...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

        const { error } = await supabase
          .from('work_log')
          .update(updatedFields)
          .eq('id', id);

        Swal.close();

        if (error) return Swal.fire({
          icon: 'error',
          title: 'Update Failed',
          text: error.message
        });

        Swal.fire({
          icon: 'success',
          title: 'Updated!',
          timer: 1500,
          showConfirmButton: false
        });

        loadActivityLog();
      });
    });

    updateDashboardStats(data);

  } catch (error) {
    Swal.fire({
      icon: 'error',
      title: 'Error Loading Log',
      text: error.message
    });
  }
}

// Update dashboard stats
function updateDashboardStats(data) {
  document.getElementById('callsToday').innerText = data.filter(d => d.activity_type === 'Call').length;
  document.getElementById('followUps').innerText = data.filter(d => d.activity_type === 'Follow-up').length;
  document.getElementById('demos').innerText = data.filter(d => d.activity_type === 'Demo').length;
  document.getElementById('feedbacks').innerText = data.filter(d => d.activity_type === 'Feedback').length;
}

// Handle form submission
workLogForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  try {
    const user = await getCurrentUser();

    const activityType = document.getElementById('activityType').value;
    const contactName = document.getElementById('contactName').value.trim();
    const contactNumber = document.getElementById('phone').value.trim();
    const status = document.getElementById('status').value;
    const nextStep = document.getElementById('nextStep').value.trim();
    const notes = document.getElementById('notes').value.trim();

    if (!activityType || !contactName || !status) {
      return Swal.fire({ icon: 'warning', title: 'Missing Fields', text: 'Please fill required fields.' });
    }

    Swal.fire({ title: 'Saving...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

    const { error } = await supabase.from('work_log').insert([{
      activity_type: activityType,
      contact_name: contactName,
      contact_number: contactNumber,
      status: status,
      next_step: nextStep,
      notes: notes,
      user_id: user.id
    }]);

    Swal.close();

    if (error) throw error;

    workLogForm.reset();
    loadActivityLog();

    Swal.fire({
      icon: 'success',
      title: 'Saved!',
      timer: 1500,
      showConfirmButton: false
    });

  } catch (error) {
    Swal.fire({ icon: 'error', title: 'Error Saving', text: error.message });
  }
});

// Initial load
checkAuth().then(() => loadActivityLog());

// Auto-refresh every 30 seconds
setInterval(loadActivityLog, 30000);
</script>

</body>
</html>