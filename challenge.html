<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>30 Days Master - Top Student (Dynamic)</title>
  <script type="module" src="js/security.js"></script>
  <link rel="icon" type="image/png" sizes="32x32" href="../images/favicon.png">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.10.2/lottie.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; }
    .glass { backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); }
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .btn { @apply px-4 py-2 rounded-lg transition; }
  </style>
</head>
<body class="bg-gradient-to-r from-green-800 to-blue-800 min-h-screen">

  <!-- Sidebar (unchanged from your layout) -->
  <aside class="w-64 hidden md:flex flex-col fixed top-0 left-0 bottom-0 mt-12 mb-12 z-50 text-white overflow-y-auto rounded-3xl"
       style="background: linear-gradient(180deg,#0a0059,#3e95be); box-shadow: 0 20px 50px rgba(0,0,0,0.9); -ms-overflow-style: none;">
  <nav class="px-4 py-6 space-y-2">
    <a href="dashboard.html" data-service="dashboard.html"
       class="flex items-center gap-3 p-2 rounded-lg transition hover:bg-white hover:text-blue-900">
      <i class="fa-solid fa-house"></i><span>Dashboard</span>
    </a>
    <a href="reminder.html" data-service="reminder.html"
       class="flex items-center gap-3 p-2 rounded-lg transition hover:bg-white hover:text-blue-900">
      <i class="fa-solid fa-bell"></i><span>What I Missed</span>
    </a>
    <a href="challenge.html" data-service="challenge.html"
       class="flex items-center gap-3 p-2 rounded-lg transition hover:bg-white hover:text-blue-900">
      <i class="fa-solid fa-calendar-check"></i><span>The 30 Days Master</span>
    </a>
    <a href="pack.html" data-service="pack.html"
       class="flex items-center gap-3 p-2 rounded-lg transition hover:bg-white hover:text-blue-900">
      <i class="fa-solid fa-book-open"></i><span>Smart Pack</span>
    </a>
    <a href="capability.html" data-service="capability.html"
       class="flex items-center gap-3 p-2 rounded-lg transition hover:bg-white hover:text-blue-900">
      <i class="fa-solid fa-chart-line"></i><span>My Capabilities</span>
    </a>
    <a href="scope.html" data-service="scope.html"
       class="flex items-center gap-3 p-2 rounded-lg transition hover:bg-white hover:text-blue-900">
      <i class="fa-solid fa-lightbulb"></i><span>Study Scope</span>
    </a>
    <a href="nsfas.html" data-service="nsfas.html"
       class="flex items-center gap-3 p-2 rounded-lg transition hover:bg-white hover:text-blue-900">
      <i class="fa-solid fa-piggy-bank"></i><span>NSFAS</span>
    </a>
    <a href="university.html" data-service="university.html"
       class="flex items-center gap-3 p-2 rounded-lg transition hover:bg-white hover:text-blue-900">
      <i class="fa-solid fa-university"></i><span>University</span>
    </a>
    <a href="options.html" data-service="options.html"
       class="flex items-center gap-3 p-2 rounded-lg transition hover:bg-white hover:text-blue-900">
      <i class="fa-solid fa-briefcase"></i><span>My Options</span>
    </a>
    <a href="chat.html" data-service="community.html"
       class="flex items-center gap-3 p-2 rounded-lg transition hover:bg-white hover:text-blue-900">
      <i class="fa-solid fa-comments"></i><span>Community Q&A Board</span>
    </a>
	<a href="read.html" data-service="help.html"
       class="flex items-center gap-3 p-2 rounded-lg transition hover:bg-white hover:text-blue-900">
      <i class="fa-solid fa-chalkboard"></i><span>Read With Me</span>
    </a>
    <a href="account.html"
       class="flex items-center gap-3 p-2 rounded-lg transition hover:bg-white hover:text-blue-900">
      <i class="fa-solid fa-user"></i><span>Account</span>
    </a>
  </nav>
</aside>

  <!-- Mobile Menu Button -->
  <div class="md:hidden fixed top-2 right-0 p-4 z-50">
    <button id="menuBtn" class="text-white p-2 rounded bg-transparent focus:outline-none">
      <i id="menuIcon" class="fa-solid fa-bars text-2xl"></i>
    </button>
  </div>

  <!-- Blur Overlay -->
  <div id="blurOverlay" class="fixed inset-0 bg-white bg-opacity-30 glass hidden z-40"></div>

  <!-- Header -->
  <header class="flex items-center justify-between px-4 md:px-6 text-white fixed top-0 z-30 h-24 md:h-24 w-full md:w-3/4 md:ml-80 md:rounded-b-3xl"
          style="background: linear-gradient(60deg,#0a0059,#38b6ff);">
    <div class="flex flex-col ml-16 items-center flex-1 text-center">
      <h2 class="text-xl md:text-2xl font-bold flex items-center justify-center gap-2">The 30 Days Master</h2>
      <p class="text-xs md:text-sm">Ready to start.</p>
    </div>
    <div class="w-20 md:w-28"></div>
  </header>

<main class="flex flex-col items-center md:ml-64 px-6 md:px-12 space-y-8 mt-12 pt-24">

  <!-- Normal content -->
  <div id="normalMainContent">
    <div class="w-full max-w-5xl mt-2 bg-white bg-opacity-80 rounded-t-2xl p-4 shadow">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
      <div>
  <label class="block text-sm text-gray-700 mb-1">Subject</label>
  <select id="subjectSelect" class="w-full bg-white border rounded-lg px-3 py-2 focus:outline-none">
    <option disabled selected>Loading subjects...</option>
  </select>
</div>
      <div class="md:col-span-2 grid grid-cols-2 md:grid-cols-4 gap-2">
        <div class="bg-gray-50 rounded-xl p-3 text-center">
          <div class="text-xs text-gray-500">Completed</div>
          <div id="statCompleted" class="text-xl font-semibold">0</div>
        </div>
        <div class="bg-gray-50 rounded-xl p-3 text-center">
          <div class="text-xs text-gray-500">Remaining</div>
          <div id="statRemaining" class="text-xl font-semibold">30</div>
        </div>
        <div class="bg-gray-50 rounded-xl p-3 text-center">
          <div class="text-xs text-gray-500">Unlocked</div>
          <div id="statUnlocked" class="text-xl font-semibold">1</div>
        </div>
        <div class="bg-gray-50 rounded-xl p-3 text-center">
          <div class="text-xs text-gray-500">Subjects</div>
          <div id="statSubjects" class="text-xl font-semibold">0 / 4</div>
        </div>
      </div>
    </div>
  </div>

    <div class="w-full max-w-5xl bg-white bg-opacity-80 rounded-b-2xl h-4">
      <div id="progressBar" class="bg-blue-500 h-4 rounded-full" style="width: 0%;"></div>
    </div>

    <div id="daysGrid" class="mt-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 w-full max-w-5xl"></div>
  </div>

  <!-- Study content dynamically injected -->
  <div id="lessonMainContent" class="hidden w-full max-w-5xl space-y-12"></div>

<div id="quizModal" class="hidden fixed inset-0 flex justify-center items-start z-50 pt-10">
  <!-- Modal Box -->
  <div class="bg-white rounded-xl shadow-xl w-11/12 md:w-2/3 flex flex-col" style="max-height: 80vh; margin-top: 10vh; margin-bottom: 10vh; overflow: hidden;">
    
    <!-- Header -->
    <div class="flex justify-between items-center mb-4 flex-shrink-0 relative">
  <h2 id="quizModalTitle" class="text-2xl font-bold text-green-800"> Quiz</h2>
  <button id="closeQuizBtn" class="text-gray-600 hover:text-gray-900 text-2xl">&times;</button>
  <span id="quizPercentBadge" class="absolute top-1 left-4 transform -translate-x-4 px-3 py-1 rounded font-bold text-white text-sm bg-gray-400"></span>
</div>

    <!-- Scrollable content -->
    <div id="quizModalContent" class="overflow-y-auto p-4 flex-1" style="max-height: calc(80vh - 96px);"></div>

    <!-- Footer / Submit button -->
    <div class="flex justify-center p-4 border-t flex-shrink-0">
      <button id="submitQuizBtn" class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-6 py-2 rounded hover:opacity-90">
        Submit Quiz
      </button>
    </div>

  </div>
</div>
</main>

<script type="module">
    import { supabase } from './js/supabaseClient.js';

const TOTAL_DAYS = 30;
const SUBJECT_LIMIT = 4;

let currentUser = null;
let userProgressRow = null;
let currentSubject = 'Math';
let lessonsCache = [];
let currentViewingDay = null;

const subjectSelect = document.getElementById('subjectSelect');
const progressBar = document.getElementById('progressBar');
const daysGrid = document.getElementById('daysGrid');
const statCompleted = document.getElementById('statCompleted');
const statRemaining = document.getElementById('statRemaining');
const statUnlocked = document.getElementById('statUnlocked');
const statSubjects = document.getElementById('statSubjects');

// =====================
// 🧠 Helpers
// =====================
function showToast(msg, type = 'info') {
  Swal.fire({
    icon: type,
    title: msg,
    timer: 2000,
    showConfirmButton: false,
    toast: true,
    position: 'top-end',
  });
}

function setProgressUI(completedCount, lastDay) {
  const percent = Math.min(100, (completedCount / TOTAL_DAYS) * 100);
  progressBar.style.width = percent + '%';
  statCompleted.textContent = completedCount;
  statRemaining.textContent = Math.max(0, TOTAL_DAYS - completedCount);
  statUnlocked.textContent = Math.min(TOTAL_DAYS, (lastDay || 0) + 1);
}

function subjectsCount(progressObj) {
  return progressObj ? Object.keys(progressObj).length : 0;
}

function ensureSubjectEntry(progressObj, subject) {
  if (!progressObj[subject]) {
    progressObj[subject] = { completed_days: [], last_day: 0 };
  }
  return progressObj;
}

async function checkSubscription() {
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    // Not logged in → send to dashboard
    window.location.href = "dashboard.html";
    return;
  }

  // Fetch subscription record
  const { data, error } = await supabase
    .from("subscription")
    .select("current_plan")
    .eq("user_id", user.id)
    .single();

  if (error || !data) {
    showUpgradeAlert();
    return;
  }

  const allowedPlans = ["trial", "standard", "premium"];

  if (!allowedPlans.includes(data.current_plan)) {
    showUpgradeAlert();
  }
}

function showUpgradeAlert() {
  Swal.fire({
    icon: 'warning',
    title: 'Access Restricted',
    text: 'This feature is available only for Trial, Standard, or Premium members. Upgrade or activate your plan to continue.',
    confirmButtonText: 'View Plans',
    showCancelButton: true,
    cancelButtonText: 'Go Back',
    confirmButtonColor: '#3085d6',
    cancelButtonColor: '#d33'
  }).then((result) => {
    if (result.isConfirmed) {
      window.location.href = "Subscription.html"; // Upgrade page
    } else {
      window.location.href = "dashboard.html"; // Back to dashboard
    }
  });
}

checkSubscription();

async function loadSubjectsFromProfiles() {

  try {
    // Fetch the subjects for the current user only
    const { data, error } = await supabase
      .from('profiles')
      .select('subjects')
      .eq('id', currentUser.id) // Get subjects of logged-in user only
      .single();

    if (error) {
      console.error(error);
      showToast('Failed to load subjects.', 'error');
      return;
    }

    const subjectSelect = document.getElementById('subjectSelect');
    subjectSelect.innerHTML = ''; // Clear previous options

    // If user has NO subjects → SweetAlert popup
    if (!data || !data.subjects || data.subjects.length === 0) {
      Swal.fire({
        title: 'No Subjects Found',
        text: 'You haven’t set up your subjects yet. Please go to your profile and add them.',
        icon: 'warning',
        confirmButtonText: 'Go to Profile',
        showCancelButton: true,
        cancelButtonText: 'Cancel',
        confirmButtonColor: '#2563EB',
        cancelButtonColor: '#6B7280'
      }).then((result) => {
        if (result.isConfirmed) {
          window.location.href = '/profile.html';
        }
      });

      const option = document.createElement('option');
      option.disabled = true;
      option.textContent = 'No subjects available';
      subjectSelect.appendChild(option);

      return;
    }

    // If subjects exist → add them to dropdown
    data.subjects.forEach(sub => {
      const option = document.createElement('option');
      option.value = sub;
      option.textContent = sub.charAt(0).toUpperCase() + sub.slice(1);
      subjectSelect.appendChild(option);
    });

    // Set default subject
    currentSubject = data.subjects[0];
    subjectSelect.value = currentSubject;

  } catch (err) {
    console.error('Error fetching subjects:', err);
    showToast('Something went wrong loading subjects.', 'error');
  }
}

// =====================
// 🔐 Load session & ensure user row
// =====================
async function initAuthAndData() {
  const { data: { session } } = await supabase.auth.getSession();
  if (!session || !session.user) {
    showToast('Please sign in first to use 30 Days Master.', 'warning');
    return;
  }
  currentUser = session.user;

  await loadSubjectsFromProfiles();

  const { data, error } = await supabase
    .from('user_progress')
    .select('user_id, subjects_progress')
    .eq('user_id', currentUser.id)
    .maybeSingle();

  if (error) {
    console.error(error);
    showToast('Failed to fetch progress.', 'error');
    return;
  }

  if (!data) {
    const insertRes = await supabase
      .from('user_progress')
      .insert({ user_id: currentUser.id, subjects_progress: {} })
      .select()
      .single();
    userProgressRow = insertRes.data;
  } else {
    userProgressRow = data;
  }

  await loadSubject(currentSubject);
  subjectSelect.value = currentSubject;
  await updateSubjectsStat();
}


async function updateSubjectsStat() {
  const count = subjectsCount(userProgressRow?.subjects_progress || {});
  statSubjects.textContent = `${count} / ${SUBJECT_LIMIT}`;
}

// =====================
// 📚 Load lessons for subject
// =====================
async function loadSubject(subject) {
  currentSubject = subject;

  const { data: lessons, error: lessonsErr } = await supabase
    .from('challenge')
    .select('id, subject, day, title, content, introduction, formulas, examples, tips, images, links, quiz')
    .eq('subject', subject)
    .order('day', { ascending: true });

  if (lessonsErr) {
    console.error(lessonsErr);
    showToast('Failed to load lessons.', 'error');
    return;
  }

  Swal.close();

  lessonsCache = lessons || [];

  const progress = userProgressRow.subjects_progress || {};
  const hasSubject = !!progress[subject];
  const used = subjectsCount(progress);

  if (!hasSubject) {
    if (used >= SUBJECT_LIMIT) {
      showToast('You already have 4 subjects. Finish or remove one to add a new subject.', 'warning');
      const available = Object.keys(progress)[0] || subject;
      subjectSelect.value = available;
      return loadSubject(available);
    }

    progress[subject] = { completed_days: [], last_day: 0 };
    const { error: updErr, data: updData } = await supabase
      .from('user_progress')
      .update({ subjects_progress: progress })
      .eq('user_id', currentUser.id)
      .select()
      .single();
    if (updErr) {
      console.error(updErr);
      showToast('Could not add subject to your progress.', 'error');
      return;
    }
    userProgressRow = updData;
    await updateSubjectsStat();
  }

  renderLessons();
}

// =====================
// 📝 Render lessons
// =====================
function renderLessons() {
  daysGrid.innerHTML = '';

  const progress = userProgressRow.subjects_progress || {};
  const subjProg = progress[currentSubject] || { completed_days: [], last_day: 0 };
  const completedSet = new Set(subjProg.completed_days || []);
  const lastDay = subjProg.last_day || 0;
  const completedCount = (subjProg.completed_days || []).length;

  setProgressUI(completedCount, lastDay);

  (lessonsCache || []).forEach((lesson) => {
    const completed = completedSet.has(lesson.day);
    const locked = lesson.day > (lastDay + 1);

    const card = document.createElement('div');
    card.className = `bg-white rounded-3xl shadow-lg p-6 flex flex-col glass hover:shadow-2xl transition ${locked ? 'opacity-50' : ''}`;
    card.innerHTML = `
      <h3 class="text-xl font-bold mb-2">Day ${lesson.day}</h3>
      <p class="text-gray-700 text-sm mb-4">${lesson.title || 'Study the essential topics.'}</p>
      <div class="flex space-x-3">
        <button class="studyBtn bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 flex-1" data-day="${lesson.day}" ${locked ? 'disabled' : ''}>Train</button>
        <button class="practiceBtn bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 flex-1" data-day="${lesson.day}" ${locked ? 'disabled' : ''}>Fight</button>
      </div>
      <button class="completeBtn mt-4 ${completed ? 'bg-green-200 text-green-900' : 'bg-gray-300 text-gray-800'} px-4 py-2 rounded-lg hover:bg-gray-400 w-full" data-day="${lesson.day}" ${locked || completed ? 'disabled' : ''}>${completed ? 'Completed' : 'Mark as done'}</button>
    `;
    daysGrid.appendChild(card);
  });
}

// =====================
// 🧭 Events
// =====================
subjectSelect.addEventListener('change', (e) => loadSubject(e.target.value));

daysGrid.addEventListener('click', async (e) => {
  const dayAttr = e.target.getAttribute('data-day');
  if (!dayAttr) return;
  const day = parseInt(dayAttr, 10);

  const lesson = (lessonsCache || []).find(l => l.day === day);
  if (!lesson) return;

  if (e.target.classList.contains('studyBtn')) {
    openLessonPage(lesson);
  }

  if (e.target.classList.contains('practiceBtn')) {
  openQuiz(lesson);
  }

  if (e.target.classList.contains('completeBtn')) {
    await markComplete(day);
  }
});

// =====================
// 📖 Dynamic Lesson Page
// =====================
function openLessonPage(lesson) {
  currentViewingDay = lesson.day;

  document.getElementById('normalMainContent').classList.add('hidden');
  const lessonDiv = document.getElementById('lessonMainContent');
  lessonDiv.classList.remove('hidden');

  let html = `
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold text-white">Day ${lesson.day}: ${lesson.title || 'Lesson'}</h1>
      <button id="closeLessonBtn" class="text-gray-50 hover:text-red-500 text-2xl"><i class="fas fa-times"></i></button>
    </div>

    ${lesson.introduction ? `<section class="bg-gradient-to-r from-blue-50 to-green-50 p-6 rounded-xl shadow mb-2"><h2 class="text-2xl font-semibold mb-2 text-green-700">Introduction</h2>${lesson.introduction}</section>` : ''}
    ${lesson.content ? `<section class="bg-gradient-to-r from-blue-50 to-green-50 p-6 rounded-xl shadow mb-2"><h2 class="text-2xl font-semibold mb-2 text-green-700">Content</h2>${lesson.content}</section>` : ''}
    ${lesson.formulas ? `<section class="bg-gradient-to-r from-blue-50 to-green-50 p-6 rounded-xl shadow mb-2"><h2 class="text-2xl font-semibold mb-2 text-green-700">Formulas</h2>${lesson.formulas}</section>` : ''}
    ${lesson.examples ? `<section class="bg-gradient-to-r from-green-50 to-blue-50 p-6 rounded-xl shadow mb-2"><h2 class="text-2xl font-semibold mb-2 text-green-700">Examples</h2>${lesson.examples}</section>` : ''}
    ${lesson.tips ? `<section class="bg-gradient-to-r from-blue-50 to-green-50 p-6 rounded-xl shadow mb-2"><h2 class="text-2xl font-semibold mb-2 text-green-700">Tips & Notes</h2>${lesson.tips}</section>` : ''}
    ${lesson.images ? lesson.images.map(img => `<img src="${img}" class="rounded-xl my-2 shadow w-full object-cover">`).join('') : ''}
    ${lesson.links ? `<section class="bg-gradient-to-r from-blue-50 to-green-50 rounded-xl p-4"><h3 class="font-semibold mb-2 text-green-700">Links & Resources</h3><ul class="list-disc list-inside text-blue-700">${lesson.links.map(link => `<li><a href="${link}" target="_blank" class="hover:underline">${link}</a></li>`).join('')}</ul></section>` : ''}

    <div class="flex justify-between mt-6">
      <button id="doneLessonBtn" class="bg-green-600 text-white mb-4 px-6 py-2 rounded hover:bg-green-700">I'm Done</button>
      <button id="closeLessonBtnBottom" class="bg-gray-500 text-white mb-4 px-6 py-2 rounded hover:bg-gray-400">Close</button>
    </div>
  `;

  lessonDiv.innerHTML = html;

  document.getElementById('closeLessonBtn').addEventListener('click', closeLessonPage);
  document.getElementById('closeLessonBtnBottom').addEventListener('click', closeLessonPage);
  document.getElementById('doneLessonBtn').addEventListener('click', async () => {
    await markComplete(lesson.day);
    closeLessonPage();
  });
}

function closeLessonPage() {
  document.getElementById('lessonMainContent').classList.add('hidden');
  document.getElementById('normalMainContent').classList.remove('hidden');
  currentViewingDay = null;
}

// =====================
// 📖 Open Quiz
// =====================
async function openQuiz(lesson) {
  const quizQuestions = lesson.quiz?.questions || [];

  if (quizQuestions.length === 0) {
    showToast('No quiz available for this lesson.', 'info');
    return;
  }

  let userAnswers = new Array(quizQuestions.length).fill(null);
  const day = lesson.day;

  const quizModal = document.getElementById('quizModal');
  const modalTitle = document.getElementById('quizModalTitle');
  const modalContent = document.getElementById('quizModalContent');
  const submitQuizBtn = document.getElementById('submitQuizBtn');
  const closeQuizBtn = document.getElementById('closeQuizBtn');

  // Create or reset percentage badge
  let percentBadge = document.getElementById('quizPercentBadge');
  if (!percentBadge) {
    percentBadge = document.createElement('span');
    percentBadge.id = 'quizPercentBadge';
    percentBadge.className = 'absolute top-2 left-4 rounded font-bold text-white text-sm bg-gray-400';
    modalTitle.parentElement.appendChild(percentBadge);
  }
  percentBadge.textContent = '';
  percentBadge.style.display = 'none';

  // Fetch previous score & answers if available
  const prevData = userProgressRow.subjects_progress?.[currentSubject]?.quizzes?.[day];
  const readOnly = !!prevData;

  if (readOnly) {
    showToast(`You scored ${prevData.score} / ${prevData.total} on this quiz`, 'info');
    userAnswers = prevData.answers || userAnswers;
    const percent = Math.round((prevData.score / prevData.total) * 100);
    updatePercentBadge(percent);
  }

  modalTitle.textContent = ` Quiz - Day ${day}`;

  // Build quiz HTML
  modalContent.innerHTML = quizQuestions.map((q, i) => {
    // Find index of correct answer
    const correctIdx = q.options.findIndex(opt => opt === q.answer);

    return `
      <div class="mb-6 p-4 border rounded-lg bg-gray-50 animate-fade-in">
        <h3 class="font-semibold mb-2 text-gray-800">Q${i + 1}: ${q.question}</h3>
        <div class="flex flex-col space-y-2">
          ${q.options.map((opt, idx) => `
            <label class="inline-flex items-center p-2 rounded cursor-pointer ${
              readOnly
                ? (idx === correctIdx 
                    ? 'bg-green-200' 
                    : (userAnswers[i] === idx ? 'bg-red-200' : ''))
                : ''
            }">
              <input type="radio" name="quiz-${i}" value="${idx}" class="quizOption mr-2" ${readOnly ? 'disabled' : ''} ${userAnswers[i] === idx ? 'checked' : ''}>
              <span>${opt}</span>
            </label>
          `).join('')}
        </div>
      </div>
    `;
  }).join('');

  quizModal.classList.remove('hidden');

  // Make modal content scrollable
  const setModalHeight = () => {
    const viewportHeight = window.innerHeight;
    const headerHeight = modalTitle.offsetHeight + 32;
    const submitHeight = submitQuizBtn.offsetHeight + 16;
    modalContent.style.maxHeight = `${viewportHeight - headerHeight - submitHeight}px`;
    modalContent.style.overflowY = 'auto';
  };
  setModalHeight();
  window.addEventListener('resize', setModalHeight);

  // Handle answer selection
  if (!readOnly) {
    modalContent.querySelectorAll('.quizOption').forEach(input => {
      input.addEventListener('change', e => {
        const [_, qIndex] = e.target.name.split('-');
        userAnswers[parseInt(qIndex, 10)] = parseInt(e.target.value, 10);
      });
    });
  }

  // Reset & style submit button
  submitQuizBtn.disabled = false;
  submitQuizBtn.className = 'mt-4 mx-auto block bg-gradient-to-r from-green-500 to-blue-500 text-white px-6 py-2 rounded hover:from-green-600 hover:to-blue-600';

  // Remove old click handlers and rebind safely
  submitQuizBtn.replaceWith(submitQuizBtn.cloneNode(true));
  const newSubmitBtn = document.getElementById('submitQuizBtn');

  if (readOnly) {
    newSubmitBtn.disabled = true;
  } else {
    newSubmitBtn.onclick = async () => {
      // Show Swal loader
      Swal.fire({
        title: 'Marking Quiz...',
        text: 'Please wait while we mark your Quiz.',
        allowOutsideClick: false,
        allowEscapeKey: false,
        didOpen: () => Swal.showLoading(),
      });

      let score = 0;
      for (let i = 0; i < quizQuestions.length; i++) {
        const qDiv = modalContent.children[i];
        const correctIdx = quizQuestions[i].options.findIndex(opt => opt === quizQuestions[i].answer);

        // Animate marking
        Array.from(qDiv.querySelectorAll('input')).forEach((input, idx) => {
          input.disabled = true;

          // Highlight correct answer
          if (idx === correctIdx) input.parentElement.classList.add('bg-green-200', 'animate-pulse');

          // Highlight user's wrong answer
          if (userAnswers[i] === idx && idx !== correctIdx) input.parentElement.classList.add('bg-red-200', 'animate-pulse');
        });

        if (userAnswers[i] === correctIdx) score++;
        await new Promise(res => setTimeout(res, 300)); // small delay per question
      }

      const percent = Math.round((score / quizQuestions.length) * 100);
      updatePercentBadge(percent);

      await saveQuizScore(day, score, quizQuestions.length, userAnswers);
      showToast(`You scored ${score} / ${quizQuestions.length} (${percent}%)`, 'success');

      newSubmitBtn.disabled = true;
      Swal.close();
    };
  }

  // Handle closing modal
  closeQuizBtn.onclick = () => {
    quizModal.classList.add('hidden');
  };

  // -------------------
  // Update percent badge
  // -------------------
  function updatePercentBadge(percent) {
    percentBadge.textContent = `${percent}%`;
    percentBadge.className = 'absolute top-2 left-1/2 transform -translate-x-1/2 px-3 py-1 rounded font-bold text-white text-sm';
    if (percent < 30) percentBadge.classList.add('bg-red-600');
    else if (percent < 60) percentBadge.classList.add('bg-yellow-500');
    else if (percent < 80) percentBadge.classList.add('bg-blue-500');
    else percentBadge.classList.add('bg-green-600');
    percentBadge.style.display = 'inline-block';
  }
}

// =====================
// 💾 Save Quiz Score with answers
// =====================
async function saveQuizScore(day, score, total, answers) {
  const { data: latest } = await supabase
    .from('user_progress')
    .select('subjects_progress')
    .eq('user_id', currentUser.id)
    .single();

  const progress = latest.subjects_progress || {};
  if (!progress[currentSubject]) progress[currentSubject] = { completed_days: [], last_day: 0, quizzes: {} };

  if (!progress[currentSubject].quizzes) progress[currentSubject].quizzes = {};
  progress[currentSubject].quizzes[day] = { score, total, answers };

  const { error, data: updData } = await supabase
    .from('user_progress')
    .update({ subjects_progress: progress })
    .eq('user_id', currentUser.id)
    .select()
    .single();

  if (error) {
    console.error('Failed to save quiz score:', error);
    showToast('Could not save quiz score.', 'error');
    return;
  }

  userProgressRow = updData;
}

// =====================
// ✅ Mark complete
// =====================
async function markComplete(day) {

Swal.fire({
    title: 'Updating Progress...',
    text: 'Please wait while we save your changes.',
    allowOutsideClick: false,
    allowEscapeKey: false,
    didOpen: () => {
      Swal.showLoading();
    },
  });

  const { data: latest } = await supabase
    .from('user_progress')
    .select('subjects_progress')
    .eq('user_id', currentUser.id)
    .single();

  const progress = latest.subjects_progress || {};
  ensureSubjectEntry(progress, currentSubject);

  const subj = progress[currentSubject];
  if (!subj.completed_days.includes(day)) {
    subj.completed_days.push(day);
    subj.completed_days.sort((a,b)=>a-b);
  }
  subj.last_day = Math.max(subj.last_day || 0, day);

  const { error: updErr, data: updData } = await supabase
    .from('user_progress')
    .update({ subjects_progress: progress })
    .eq('user_id', currentUser.id)
    .select()
    .single();

Swal.close();

  if (updErr) {
    console.error(updErr);
    showToast('Failed to update progress.', 'error');
    return;
  }

  userProgressRow = updData;
  renderLessons();
  await updateSubjectsStat();
  showToast(`Marked Day ${day} as complete for ${currentSubject}.`, 'success');
}

initAuthAndData();

function generateUUID() {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
    const r = Math.random() * 16 | 0;
    const v = c === 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
}

let sessionId = (window.crypto && window.crypto.randomUUID)
  ? window.crypto.randomUUID()
  : generateUUID();
let sessionRowId = null; // store inserted row id
let liveTimer = null;

// --- Track page session start ---
async function startSessionTracking() {
  if (!currentUser) return;
  try {
    const { data, error } = await supabase
      .from('user_activity')
      .insert([{
        user_id: currentUser.id,
        session_id: sessionId,
        page_name: '30DaysMaster', // NOT NULL column
        action: 'Studying',
        started_at: new Date().toISOString(),
        ended_at: new Date().toISOString(), // initial ended_at = started_at
        metadata: { subject: currentSubject } // optional
      }])
      .select()
      .single();

    if (error) throw error;
    sessionRowId = data.id; // store row id to update later
    console.log('Session tracking started:', data);

    // Start live interval
    startLiveTimer();
  } catch (err) {
    console.error('Failed to start session tracking:', err);
  }
}

// --- Live interval: update ended_at every 5 sec ---
function startLiveTimer() {
  if (!sessionRowId) return;
  if (liveTimer) clearInterval(liveTimer);

  liveTimer = setInterval(async () => {
    try {
      const { error } = await supabase
        .from('user_activity')
        .update({ ended_at: new Date().toISOString() })
        .eq('id', sessionRowId);

      if (error) throw error;
      // console.log('Session updated');
    } catch (err) {
      console.error('Failed to update session:', err);
    }
  }, 5000); // update every 5 seconds
}

// --- Track page session end on unload ---
async function endSessionTracking() {
  if (!currentUser || !sessionRowId) return;
  clearInterval(liveTimer); // stop interval
  try {
    const { error } = await supabase
      .from('user_activity')
      .update({ ended_at: new Date().toISOString() })
      .eq('id', sessionRowId);

    if (error) throw error;
    console.log('Session tracking ended');
  } catch (err) {
    console.error('Failed to end session tracking:', err);
  }
}

window.addEventListener('beforeunload', endSessionTracking);

// --- Call after initAuthAndData completes ---
initAuthAndData().then(async () => {
  // Wait for Supabase Auth to confirm the user
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) {
    console.warn('User not logged in, skipping activity tracking.');
    return;
  }

  // Assign to currentUser and start tracking
  currentUser = user;
  startSessionTracking();
});
</script>

<script>
  const menuBtn = document.getElementById("menuBtn");
  const menuIcon = document.getElementById("menuIcon");
  const blurOverlay = document.getElementById("blurOverlay");
  const sidebar = document.querySelector("aside");

  menuBtn.addEventListener("click", () => {
    // Toggle icon
    menuIcon.classList.toggle("fa-bars");
    menuIcon.classList.toggle("fa-xmark");

    // Toggle sidebar
    sidebar.classList.toggle("hidden");
    sidebar.classList.toggle("absolute");
    sidebar.classList.toggle("z-40");
    sidebar.classList.toggle("h-screen");

    // Toggle blur overlay
    blurOverlay.classList.toggle("hidden");
  });

  blurOverlay.addEventListener("click", () => {
    menuIcon.classList.add("fa-bars");
    menuIcon.classList.remove("fa-xmark");
    sidebar.classList.add("hidden");
    sidebar.classList.remove("absolute", "z-40", "h-screen");
    blurOverlay.classList.add("hidden");
  });
</script>
</body>
</html>

