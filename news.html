<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>News Hub</title>
  <link rel="icon" type="image/png" sizes="32x32" href="../images/favicon.png">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    /* Tailwind + simple masonry using column-count */
    #newsGrid {
      column-count: 1;
      column-gap: 1.5rem;
    }

    @media (min-width: 768px) {
      #newsGrid {
        column-count: 2;
      }
    }
    @media (min-width: 1024px) {
      #newsGrid {
        column-count: 3;
      }
    }

    .news-card {
      display: inline-block; /* needed for masonry */
      width: 100%;
      margin-bottom: 1.5rem;
      break-inside: avoid; /* prevent breaking inside column */
    }
  </style>
</head>
<body class="bg-gradient-to-r from-pink-200 to-blue-500 font-sans min-h-screen flex flex-col">

<!-- Header -->
<header class="fixed top-0 left-0 w-full bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-500 rounded-b-3xl text-white p-6 shadow-lg z-50">
  <div class="max-w-6xl mx-auto flex flex-col md:flex-row md:items-center md:justify-between gap-4">
    <div>
      <h1 class="text-4xl font-extrabold flex items-center gap-3">News Hub</h1>
      <p class="mt-1 text-lg opacity-90">Stay updated with the latest education & tech stories.</p>
    </div>
    <div class="flex items-center gap-4 w-full md:w-auto">
      <div class="flex w-full md:w-72">
        <input type="text" id="searchInput" placeholder="Search news..." 
               class="flex-1 px-4 py-2 rounded-l-lg text-gray-800 focus:outline-none">
        <button onclick="searchNews()" 
                class="px-4 py-2 bg-yellow-400 text-gray-900 rounded-r-lg hover:bg-yellow-500">
          <i class="fas fa-search"></i>
        </button>
      </div>
      <a href="dashboard.html" 
         class="ml-auto px-4 py-2 bg-white backdrop-blur-lg rounded-full text-black hover:bg-gray-100 flex items-center gap-2">
         Home
      </a>
    </div>
  </div>
</header>

<!-- Categories -->
<nav class="max-w-6xl mx-auto flex flex-wrap gap-3 p-6 justify-center mt-48">
  <button onclick="filterNews('all', this)" class="category-btn px-4 py-1 bg-gray-200 rounded-full text-gray-800 text-sm">All</button>
  <button onclick="filterNews('education', this)" class="category-btn px-4 py-1 bg-green-200 rounded-full text-green-900 text-sm">Education</button>
  <button onclick="filterNews('technology', this)" class="category-btn px-4 py-1 bg-purple-200 rounded-full text-purple-900 text-sm">Technology</button>
  <button onclick="filterNews('other', this)" class="category-btn px-4 py-1 bg-pink-200 rounded-full text-pink-900 text-sm">Other</button>
</nav>

<!-- News Grid -->
<main id="newsGrid" class="max-w-6xl mx-auto p-6 flex-1 mt-4">
  <!-- Cards inserted dynamically -->
</main>

<div id="loader" class="fixed inset-0 flex items-center justify-center bg-white opacity-50 z-50">
  <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-blue-500 border-b-4 border-gray-300"></div>
</div>

<!-- Footer -->
<footer class="bg-gray-200 rounded-t-3xl text-gray-600 text-center py-6 mt-10">
  <p class="text-sm">© 2025 News Hub (Top Student). All rights reserved.</p>
</footer>

<script type="module">
    import { supabase } from './js/supabaseClient.js';

const loader = document.getElementById('loader');

  async function fetchNews() {
    console.log("Fetching news from Supabase...");
    loader.style.display = 'flex'; // show loader
    try {
      const { data, error } = await supabase
        .from('news')
        .select('*')
        .order('date_posted', { ascending: false });

      if (error) throw error;

      // Randomize news order
      data.sort(() => Math.random() - 0.5);

      console.log("News fetched:", data);
      displayNews(data);
    } catch (err) {
      console.error('Error fetching news:', err.message);
      Swal.fire("Error", "Failed to fetch news: " + err.message, "error");
    } finally {
      loader.style.display = 'none'; // hide loader
    }
  }

  function displayNews(newsItems) {
    console.log("Displaying news, items:", newsItems.length);
    const newsGrid = document.getElementById('newsGrid');
    newsGrid.innerHTML = '';

    newsItems.forEach((item) => {
      const card = document.createElement('article');
      card.className = 'news-card bg-white rounded-2xl shadow hover:shadow-xl transition overflow-hidden flex flex-col';
      card.dataset.category = item.category || 'other';

      card.innerHTML = `
        <img src="${item.image_url || 'https://via.placeholder.com/600x300/cccccc/ffffff?text=No+Image'}" 
             alt="${item.title}" class="w-full object-cover">
        <div class="p-5 flex flex-col">
          <h2 class="text-lg font-semibold text-blue-700">${item.title}</h2>
          <p class="text-gray-500 text-xs mb-2">${new Date(item.date_posted).toLocaleDateString()} • ${item.audience || 'Everyone'}</p>
          <p class="text-gray-600 text-sm mb-3">${item.body}</p>
          <button onclick="openNews('${item.source_url || '#'}')" 
                  class="text-blue-600 hover:underline text-sm mt-2">Read more →</button>
        </div>
      `;
      newsGrid.appendChild(card);
    });
  }

  function openNews(url) {
    if(url && url !== '#'){
      window.open(url, '_blank');
    } else {
      Swal.fire({
        title: 'No source available',
        text: 'This news item does not have an external link.',
        icon: 'info',
        confirmButtonText: 'Close'
      });
    }
  }

  function filterNews(category, btn) {
    console.log("Filtering news by category:", category);
    const cards = document.querySelectorAll('.news-card');
    cards.forEach(card => {
      card.style.display = (category === 'all' || card.dataset.category === category) ? 'inline-block' : 'none';
    });
    document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('ring-2', 'ring-indigo-400'));
    btn.classList.add('ring-2', 'ring-indigo-400');
  }

  function searchNews() {
    const query = document.getElementById('searchInput').value.toLowerCase();
    console.log("Searching for:", query);
    const cards = document.querySelectorAll('.news-card');
    let found = false;

    cards.forEach(card => {
      const text = card.innerText.toLowerCase();
      if (text.includes(query)) {
        card.style.display = "inline-block";
        found = true;
      } else {
        card.style.display = "none";
      }
    });

    if (!found && query.trim() !== "") {
      Swal.fire("No results", "No news found for: " + query, "warning");
    }
  }

  window.addEventListener('DOMContentLoaded', () => {
    document.querySelector('.category-btn').classList.add('ring-2', 'ring-indigo-400');
    fetchNews();
  });

  window.filterNews = filterNews;
  window.searchNews = searchNews;
  window.openNews = openNews;
</script>
</body>
</html>
