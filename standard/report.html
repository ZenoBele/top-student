<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <title>Submit Term Report â€“ Top Student</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body class="bg-gradient-to-b from-blue-100 to-white text-gray-800 font-sans">

<header class="flex justify-between items-center bg-gray-900 mb-16 px-6 py-4 shadow-md">
    <div>
      <h1 class="text-xl font-bold text-white">Top Student</h1>
    </div>
    <div class="flex items-center gap-4">
      <nav class="space-x-4 text-sm">
        <a href="standard.html" class="text-white hover:text-[#0EA5E9]">Dashboard</a>
        <a href="contact.html" class="text-white hover:text-[#0EA5E9]"><i class="fa-solid fa-comments"></i></a>
        <a href="../index.html" class="text-white hover:text-[#0EA5E9]"><i class="fa-solid fa-right-from-bracket"></i></a>
      </nav>
    </div>
  </header>

<div class="max-w-xl mx-auto bg-gray-00 mb-16 p-8 rounded shadow-md border border-indigo-600">
  <h1 class="text-2xl font-bold mb-6 text-indigo-400 text-center">Submit Term Report</h1>

  <form id="reportform" class="space-y-6">

    <div>
      <label class="block font-semibold mb-1 text-gray-900">Name</label>
      <input type="text" id="name" required class="w-full bg-gray-50 text-gray-100 border border-gray-600 p-2 rounded" />
    </div>

    <div>
      <label class="block font-semibold mb-1 text-gray-900">Grade</label>
      <input type="number" id="grade" min="8" max="12" required class="w-full bg-gray-50 text-gray-100 border border-gray-600 p-2 rounded" />
    </div>

    <div>
      <label class="block font-semibold mb-1 text-gray-900">Term (1-4)</label>
      <input type="number" id="term" min="1" max="4" required class="w-full bg-gray-50 text-gray-900 border border-gray-600 p-2 rounded" />
    </div>

    <div>
      <label class="block mb-2 text-sm font-medium text-gray-900">Subjects & Percentages (Max 4)</label>

      <div id="subject-container" class="space-y-3">
        <div class="flex items-center gap-2">
          <input type="text" name="subject[]" placeholder="Subject" class="w-1/2 bg-gray-50 text-gray-900 border border-gray-600 p-2 rounded" required />
          <input type="number" name="percentage[]" placeholder="%" min="0" max="100" class="w-1/4 bg-gray-50 text-gray-900 border border-gray-600 p-2 rounded" required />
          <button type="button" onclick="removeSubjectRow(this)" class="text-red-700 hover:underline text-sm">Remove</button>
        </div>
      </div>

      <button type="button" onclick="addSubjectRow()" class="mt-2 text-green-600 hover:underline text-sm">+ Add Another Subject</button>
      <p id="max-subject-msg" class="text-red-500 mt-1 hidden">You can only add up to 4 subjects.</p>
    </div>

    <!-- Centered Analyze Button -->
    <div class="flex justify-center">
      <button type="submit" class="bg-indigo-500 text-white px-6 py-2 rounded hover:bg-indigo-600">
        Analyze
      </button>
    </div>
  </form>
</div>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  // Initialize Supabase client
  const supabase = createClient(
    'https://mlwxxtvsozhwzjxmsvbg.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1sd3h4dHZzb3pod3pqeG1zdmJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4OTAwOTksImV4cCI6MjA2NDQ2NjA5OX0.i9KySUVeot9imnALKr79DYySocuj0_rko4nzPhPxekU' // YOUR SUPABASE ANON KEY
  );

  // --- Subject row functions ---
  window.addSubjectRow = function() {
    const container = document.getElementById('subject-container');
    const currentRows = container.querySelectorAll('div.flex.items-center').length;
    if (currentRows >= 4) {
      document.getElementById('max-subject-msg').classList.remove('hidden');
      setTimeout(() => document.getElementById('max-subject-msg').classList.add('hidden'), 3000);
      return;
    }
    const newRow = document.createElement('div');
    newRow.className = 'flex items-center gap-2';
    newRow.innerHTML = `
      <input type="text" name="subject[]" placeholder="Subject" class="w-1/2 border border-gray-300 p-2 rounded" required />
      <input type="number" name="percentage[]" placeholder="%" min="0" max="100" class="w-1/4 border border-gray-300 p-2 rounded" required />
      <button type="button" onclick="removeSubjectRow(this)" class="text-red-500 hover:underline text-sm">Remove</button>
    `;
    container.appendChild(newRow);
  };

  window.removeSubjectRow = function(button) {
    const container = document.getElementById('subject-container');
    const rows = container.querySelectorAll('div.flex.items-center');
    if (rows.length === 1) return; // Always keep at least one row
    button.parentElement.remove();
  };

  // --- Feedback generator ---
  function generateFeedback(subjects) {
    return subjects.map(s => {
      if (s.percent < 50) return `${s.subject}: Needs more focus.`;
      if (s.percent < 70) return `${s.subject}: You're on track but can improve.`;
      return `${s.subject}: Great work! Keep it up.`;
    });
  }

  const advice = [
    "Practice 1 past paper per week.",
    "Focus 60% of study time on weaker subjects.",
    "Use exam tips section before writing tests."
  ];

  async function generatePDF(data) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  // ðŸ”· Watermark
  doc.saveGraphicsState();
  doc.setFontSize(50);
  doc.setTextColor(230); // light grey
  doc.setFont("helvetica", "bolditalic");
  doc.text("Top Student", 105, 150, { angle: 45, align: "center" });
  doc.restoreGraphicsState();

  // Title
  doc.setFont("helvetica", "bold");
  doc.setFontSize(18);
  doc.setTextColor("#5B21B6");
  doc.text(`Top Student â€“ Term ${data.term} Performance Report`, 14, 20);

  // Info
  doc.setFontSize(12);
  doc.setFont("helvetica", "normal");
  doc.setTextColor("#111111");
  doc.text(`Name: ${data.name}`, 14, 30);
  doc.text(`Grade: ${data.grade}     Term: ${data.term}     Date: ${data.date}`, 14, 38);

  // Line
  doc.setDrawColor("#5B21B6");
  doc.setLineWidth(0.5);
  doc.line(14, 42, 196, 42);

  // Table header
  doc.setFont("helvetica", "bold");
  doc.setFontSize(13);
  doc.text("Subject", 20, 50);
  doc.text("Mark", 90, 50);
  doc.text("Total", 120, 50);
  doc.text("Percent", 150, 50);

  // Line under headers
  doc.setDrawColor("#5B21B6");
  doc.setLineWidth(0.3);
  doc.line(14, 52, 196, 52);

  // Table rows
  doc.setFont("helvetica", "normal");
  doc.setFontSize(12);
  let y = 60;
  data.subjects.forEach(s => {
    doc.text(s.subject, 20, y);
    doc.text(String(s.mark), 90, y);
    doc.text(String(s.total), 120, y);
    doc.text(`${s.percent}%`, 150, y);
    y += 8;
  });

  // Line after table
  doc.setDrawColor("#5B21B6");
  doc.setLineWidth(0.5);
  doc.line(14, y, 196, y);
  y += 10;

  // Feedback section
  doc.setFont("helvetica", "bold");
  doc.setFontSize(14);
  doc.setTextColor("#5B21B6");
  doc.text("Feedback:", 14, y);
  y += 8;

  doc.setFont("helvetica", "normal");
  doc.setFontSize(12);
  doc.setTextColor("#111111");
  data.feedback.forEach(f => {
    doc.text(`- ${f}`, 18, y);
    y += 7;
  });

  y += 8;

  // Advice section
  doc.setFont("helvetica", "bold");
  doc.setFontSize(14);
  doc.setTextColor("#5B21B6");
  doc.text("Advice:", 14, y);
  y += 8;

  doc.setFont("helvetica", "normal");
  doc.setFontSize(12);
  data.advice.forEach(a => {
    doc.text(`- ${a}`, 18, y);
    y += 7;
  });

  y += 15;
  doc.setFont("helvetica", "italic");
  doc.setFontSize(11);
  doc.setTextColor("#444444");
  doc.text("Stay consistent and disciplined.", 14, y);

  return doc;
}

  // --- Submit handler ---
document.getElementById('reportform').addEventListener('submit', async e => {
    e.preventDefault();

    Swal.fire({
      title: 'Analyzing...',
      text: 'Generating your performance report',
      allowOutsideClick: false,
      didOpen: () => Swal.showLoading()
    });

    const name = document.getElementById('name').value.trim();
    const grade = Number(document.getElementById('grade').value);
    const term = Number(document.getElementById('term').value);
    const date = new Date().toISOString().slice(0, 10);

    // Collect subjects & percentages
    const subjectsInputs = document.querySelectorAll('input[name="subject[]"]');
    const percentagesInputs = document.querySelectorAll('input[name="percentage[]"]');

    if(subjectsInputs.length > 4) {
      Swal.close();
      Swal.fire("You can only add up to 4 subjects.");
      return;
    }

    const subjects = [];
    for(let i = 0; i < subjectsInputs.length; i++) {
      const subject = subjectsInputs[i].value.trim();
      const percent = Number(percentagesInputs[i].value);

      if(!subject) {
        Swal.close();
        Swal.fire("Please fill in all subject names.");
        return;
      }
      if(isNaN(percent) || percent < 0 || percent > 100) {
        Swal.close();
        Swal.fire("Please enter valid percentages between 0 and 100.");
        return;
      }

      subjects.push({
        subject,
        mark: percent,
        total: 100,
        percent
      });
    }

    const feedback = generateFeedback(subjects);
    const advice = [
      "Practice 1 past paper per week.",
      "Focus 60% of study time on weaker subjects.",
      "Use exam tips section before writing tests."
    ];

    const { data: { user } } = await supabase.auth.getUser();
    if(!user) {
      Swal.close();
      Swal.fire("You must be logged in to submit a report.");
      return;
    }

try {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    Swal.close();
    Swal.fire("You must be logged in to submit a report.");
    return;
  }

  // ðŸ§  Check if a report exists for this user
  const { data: existing, error: existingError } = await supabase
    .from('student_term_reports')
    .select('grade')
    .eq('user_id', user.id)
    .single();

  if (existingError && existingError.code !== 'PGRST116') {
    Swal.close();
    Swal.fire("Error checking existing report.");
    return;
  }

  if (existing) {
    if (existing.grade != grade) {
      Swal.close();
      Swal.fire({
        icon: "error",
        title: "Grade Mismatch",
        text: `You register for Grade ${existing.grade}. You cannot submit for Grade ${grade}.`
      });
      return;
    }
  }

  // âœ… Allowed to proceed with generate + upload
  const reportData = { name, grade, term, date, subjects, feedback, advice };
  const pdfDoc = await generatePDF(reportData);
  const pdfBlob = pdfDoc.output('blob');

  const bucketName = 'documents';
  const filename = `reports/${user.id}/term${term}_${Date.now()}.pdf`;

  const { error: uploadError } = await supabase.storage
    .from(bucketName)
    .upload(filename, pdfBlob, {
      cacheControl: '3600',
      upsert: true,
      contentType: 'application/pdf'
    });

  if (uploadError) throw uploadError;

  const { data: signedURLData, error: signedUrlError } = await supabase
    .storage
    .from(bucketName)
    .createSignedUrl(filename, 60 * 60 * 24 * 365);

  if (signedUrlError) throw signedUrlError;
  const signedUrl = signedURLData.signedUrl;

  const { error: dbError } = await supabase
    .from('student_term_reports')
    .upsert({
      user_id: user.id,
      grade,
      term,
      report_date: date,
      subjects: JSON.stringify(subjects),
      feedback,
      advice,
      pdf_url: signedUrl,
      updated_at: new Date().toISOString()
    }, { onConflict: ['user_id', 'grade'] });

  if (dbError) throw dbError;

  Swal.close();
  Swal.fire('Success', 'Report saved and PDF uploaded!', 'success').then(() => {
    window.location.href = 'report-center.html';
  });

} catch (err) {
  Swal.close();
  Swal.fire("Error saving report: " + err.message);
}
});
</script>
</body>
</html>
