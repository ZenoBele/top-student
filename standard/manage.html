<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Manage Subscription – Top Student</title>
  <link rel="icon" type="image/png" sizes="32x32" href="../images/favicon.png">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
</head>
<body class="bg-gradient-to-br from-purple-100 via-blue-50 to-green-100 min-h-screen font-sans text-gray-800">

<header class="flex justify-between items-center bg-gray-900 px-6 py-6 my-8 shadow-md">
    <div>
      <h1 class="text-xl font-bold text-white">Top Student</h1>
    </div>
        <a href="../index.html" class="text-white hover:text-[#0EA5E9]"><i class="fa-solid fa-right-from-bracket"></i></a>
      </nav>
    </div>
  </header>
  
  <div class="max-w-2xl mx-auto space-y-10">
    <!-- Header -->
    <div class="text-center">
      <h1 class="text-3xl font-bold inline-flex items-center gap-2 text-purple-700">
        <i class="fas fa-cog"></i> Manage Your Subscription
      </h1>
      <p class="text-sm text-gray-600 mt-1">Customize and control your Top Student subscription below.</p>
    </div>

    <!-- Subscription Info -->
    <div class="bg-white shadow-md rounded-lg p-6 space-y-4 text-center">
      <h2 class="text-xl font-semibold text-blue-600">
        <i class="fas fa-star"></i> Current Plan: <span class="font-bold">Standard</span>
      </h2>
      <p class="text-sm text-gray-600">Monthly Price: <strong>R199</strong></p>
      <p class="text-sm text-gray-600">Status: <span id="statusLabel" class="font-medium text-green-600"></span></p>
    </div>

    <!-- Actions -->
    <div class="grid gap-4 sm:grid-cols-2">
      <button id="btn-upgrade" class="flex items-center justify-between p-4 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg shadow hover:opacity-90 transition">
        <span><i class="fas fa-arrow-up mr-2"></i> Upgrade Plan</span>
        <i class="fas fa-chevron-right"></i>
      </button>

      <button id="btn-pause" class="flex items-center justify-between p-4 bg-gradient-to-r from-gray-600 to-gray-400 text-white rounded-lg shadow hover:opacity-90 transition">
        <span><i class="fas fa-pause-circle mr-2"></i> Pause Subscription</span>
        <i class="fas fa-chevron-right"></i>
      </button>

      <button id="btn-resume" class="flex items-center justify-between p-4 bg-gradient-to-r from-green-500 to-green-300 text-white rounded-lg shadow hover:opacity-90 transition">
        <span><i class="fas fa-play-circle mr-2"></i> Resume Subscription</span>
        <i class="fas fa-chevron-right"></i>
      </button>

      <button id="btn-history" class="flex items-center justify-between p-4 bg-gradient-to-r from-indigo-600 to-violet-400 text-white rounded-lg shadow hover:opacity-90 transition">
        <span><i class="fas fa-clock mr-2"></i> View Payment History</span>
        <i class="fas fa-chevron-right"></i>
      </button>
    </div>

    <div class="text-center mt-10">
  <button id="btn-back-dashboard" class="inline-block text-blue-600 hover:underline text-sm">
    <i class="fas fa-arrow-left"></i> Back
  </button>
</div>
  </div>

  <div id="toastBox" class="hidden"></div>

  <div id="confirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-lg max-w-sm w-full p-6 text-center space-y-6">
      <p id="confirmMessage" class="text-gray-800 text-lg font-semibold"></p>
      <div class="flex justify-center gap-4">
        <button id="confirmCancel" class="px-5 py-2 rounded bg-gray-300 text-gray-700 hover:bg-gray-400 transition">Cancel</button>
        <button id="confirmOk" class="px-5 py-2 rounded bg-purple-600 text-white hover:bg-purple-700 transition">Confirm</button>
      </div>
    </div>
  </div>

  <script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  const supabase = createClient(
    'https://mlwxxtvsozhwzjxmsvbg.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1sd3h4dHZzb3pod3pqeG1zdmJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4OTAwOTksImV4cCI6MjA2NDQ2NjA5OX0.i9KySUVeot9imnALKr79DYySocuj0_rko4nzPhPxekU'
  );

const loader = document.getElementById('loader');
const toastBox = document.getElementById('toastBox');
const statusLabel = document.getElementById('statusLabel');

function showToast(msg, type = 'info') {
  if (!toastBox) return;
  toastBox.textContent = msg;
  toastBox.className = `fixed bottom-6 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded shadow-lg text-white text-sm z-50 ${
    type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600'
  }`;
  toastBox.style.display = 'block';
  setTimeout(() => {
    if (toastBox) toastBox.style.display = 'none';
  }, 3500);
}

function showConfirm(message) {
  return new Promise((resolve) => {
    const modal = document.getElementById('confirmModal');
    const confirmMessage = document.getElementById('confirmMessage');
    const ok = document.getElementById('confirmOk');
    const cancel = document.getElementById('confirmCancel');

    if (!modal || !confirmMessage || !ok || !cancel) {
      // If modal elements missing, just resolve false immediately
      resolve(false);
      return;
    }

    confirmMessage.textContent = message;
    modal.classList.remove('hidden');

    function cleanup() {
      ok.removeEventListener('click', onOk);
      cancel.removeEventListener('click', onCancel);
    }

    function onOk() {
      cleanup();
      modal.classList.add('hidden');
      resolve(true);
    }

    function onCancel() {
      cleanup();
      modal.classList.add('hidden');
      resolve(false);
    }

    ok.addEventListener('click', onOk, { once: true });
    cancel.addEventListener('click', onCancel, { once: true });
  });
}

async function getUser() {
  if (typeof supabase === 'undefined') {
    showToast('Supabase client not initialized.', 'error');
    return null;
  }
  const { data: { user }, error } = await supabase.auth.getUser();
  if (error || !user) {
    showToast("You're not logged in.", 'error');
    return null;
  }
  return user;
}

function updateStatusLabel(status) {
  if (!statusLabel) return;
  if (status === true) {
    statusLabel.textContent = 'Active';
    statusLabel.classList.remove('text-gray-500');
    statusLabel.classList.add('text-green-600');
  } else {
    statusLabel.textContent = 'Paused';
    statusLabel.classList.remove('text-green-600');
    statusLabel.classList.add('text-gray-500');
  }
}

// Page load: update status label
window.addEventListener('DOMContentLoaded', async () => {
  const user = await getUser();
  if (!user) return;

  const { data, error } = await supabase
    .from('profiles')
    .select('status')
    .eq('id', user.id)
    .single();

  if (!error && data) {
    updateStatusLabel(data.status);
  }
});

// Button logic with safety checks
const upgradeBtn = document.getElementById('btn-upgrade');
if (upgradeBtn) {
  upgradeBtn.addEventListener('click', () => {
    window.location.href =
      'https://www.payfast.co.za/eng/process?merchant_id=30322591&merchant_key=b7owp8kz6kmgz&amount=299&item_name=TopStudentPremium&return_url=https://topstudent.co.za/payment-success.html&cancel_url=https://topstudent.co.za/payment-canceled.html';
  });
}

const pauseBtn = document.getElementById('btn-pause');

if (pauseBtn) {
  pauseBtn.addEventListener('click', async () => {
    const confirmed = await showConfirm('Pause (downgrade) your subscription?');
    if (!confirmed) return;

    if (loader) loader.classList.remove('hidden');

    const user = await getUser();
    if (!user) {
      if (loader) loader.classList.add('hidden');
      return;
    }

    const { data, error: fetchErr } = await supabase
      .from('profiles')
      .select('role')
      .eq('id', user.id)
      .single();

    if (fetchErr || !data?.role) {
      if (loader) loader.classList.add('hidden');
      showToast('Failed to fetch your current role.', 'error');
      return;
    }

    const currentRole = data.role;

    if (currentRole === 'free') {
      if (loader) loader.classList.add('hidden');

      Swal.fire({
        icon: 'info',
        title: 'Your Access is Paused',
        text: 'Your trial has ended or your subscription is already paused. Would you like to renew now?',
        showCancelButton: true,
        confirmButtonText: 'Renew Now',
        cancelButtonText: 'Cancel'
      }).then((result) => {
        if (result.isConfirmed) {
          window.location.href = 'renew.html';
        }
      });

      return;
    }

    const { error } = await supabase
      .from('profiles')
      .update({
        previous_role: currentRole,
        role: 'free',
        status: false,
      })
      .eq('id', user.id);

    if (loader) loader.classList.add('hidden');

    if (error) {
      showToast('Could not pause your subscription.', 'error');
    } else {
      updateStatusLabel(false);
      showToast("Subscription paused. You're now on the free plan.", 'success');

      await supabase.auth.signOut();
      setTimeout(() => {
        window.location.href = '../index.html';
      }, 2000);
    }
  });
}

const resumeBtn = document.getElementById('btn-resume');

if (resumeBtn) {
  resumeBtn.addEventListener('click', async () => {
    const confirmed = await showConfirm("Resume your subscription?");
    if (!confirmed) return;

    const user = await getUser();
    if (!user) {
      loader.classList.add('hidden');
      showToast("User not found.", 'error');
      return;
    }

    // 🔍 Fetch previous_role and status from profile
    const { data, error: fetchErr } = await supabase
      .from('profiles')
      .select('previous_role, status')
      .eq('id', user.id)
      .single();

    if (fetchErr || !data) {
      loader.classList.add('hidden');
      showToast("Unable to fetch subscription status.", 'error');
      return;
    }

    // 🔁 Redirect to renew if paused with valid previous_role
    if (data.previous_role && data.status === true) {
      window.location.href = 'renew.html';
      return;
    }

    // ✅ Resume subscription
    const { error } = await supabase
      .from('profiles')
      .update({
        role: data.previous_role,
        previous_role: null,
        status: true
      })
      .eq('id', user.id);

    loader.classList.add('hidden');

    if (error) {
      showToast("Failed to resume subscription.", 'error');
    } else {
      updateStatusLabel(true);
      showToast("Subscription resumed successfully. Welcome back!", 'success');
    }
  });
}

const historyBtn = document.getElementById('btn-history');
if (historyBtn) {
  historyBtn.addEventListener('click', () => {
    window.location.href = 'invoices.html';
  });
}

const backBtn = document.getElementById('btn-back-dashboard');
if (backBtn) {
  backBtn.addEventListener('click', async () => {
    if (loader) loader.classList.remove('hidden');

    const user = await getUser();
    if (!user) {
      if (loader) loader.classList.add('hidden');
      return;
    }

    const { data, error } = await supabase
      .from('profiles')
      .select('role, status')
      .eq('id', user.id)
      .single();

    if (loader) loader.classList.add('hidden');

    if (error || !data) {
      showToast('Could not check your account.', 'error');
      return;
    }

    const isPaused = data.status === false;
    const key = `pause_attempts_${user.id}`;

    if (isPaused) {
      let attempts = parseInt(localStorage.getItem(key) || '0', 10);
      attempts++;

      if (attempts >= 3) {
        const { error: inactiveErr } = await supabase
          .from('profiles')
          .update({ is_active: false }) // Use boolean false here, not string
          .eq('id', user.id);

        if (inactiveErr) {
          showToast('Failed to mark account inactive.', 'error');
        } else {
          showToast('❌ Account marked inactive. Redirecting...', 'error');
          localStorage.removeItem(key); // Clear attempts
          await supabase.auth.signOut();
          setTimeout(() => {
            window.location.href = '../index.html';
          }, 2500);
        }
        return;
      }

      localStorage.setItem(key, attempts);

      if (attempts === 2) {
        showToast(
          '⚠️ Final warning: Resume your subscription to avoid being blocked.',
          'error'
        );
      } else {
        // Display attempts count dynamically
        const attemptMsg = `Attempt ${attempts} of 2.`;
        showToast(`⏸️ You're paused. Resume to access dashboard. ${attemptMsg}`, 'info');
      }

      return; // Don't continue if paused
    } else {
      // Reset attempts if resumed
      localStorage.removeItem(key);

      // Continue to dashboard
      if (data.role === 'standard') {
        window.location.href = 'standard.html';
      } else {
        window.location.href = '../index.html';
      }
    }
  });
}
</script>
</body>
</html>
