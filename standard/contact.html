<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Top Student - Standard Support</title>
  <link rel="icon" type="image/png" sizes="32x32" href="../images/favicon.png">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
</head>
<body class="bg-gray-100">

  <div class="max-w-xl mx-auto my-12 p-6 bg-white rounded-xl shadow-lg">
    <a href="standard.html" class="text-blue-600 hover:text-red-500">
      <i class="fa-solid fa-arrow-left"></i>
    </a>
    <h1 class="text-2xl font-bold mt-4">Ticket Standard Support</h1>
    <p class="text-sm text-gray-500 mb-2">
      Need help? <a href="mailto:info@topstudent.co.za" class="text-blue-500 underline">info@topstudent.co.za</a>
    </p>

    <form id="supportForm" class="space-y-4">
      <div>
        <label for="name" class="block text-sm font-medium">Your Name</label>
        <input 
          type="text" 
          id="name" 
          name="name" 
          required 
          autocomplete="name"
          class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring focus:border-blue-300">
      </div>

      <div>
        <label for="message" class="block text-sm font-medium">Message</label>
<textarea 
  id="message" 
  name="message" 
  rows="4" 
  required 
  autocomplete="off"
  placeholder="Tell us anything — complaints, UI/UX issues, feature suggestions, support requests, etc." 
  class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring focus:border-blue-300"></textarea>
      </div>

      <button type="submit" id="submitBtn" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 transition">Send Message</button>

      <!-- Tailwind loader -->
      <div id="loader" class="flex justify-center items-center mt-4 space-x-2 hidden">
        <div class="w-3 h-3 bg-blue-800 rounded-full animate-bounce [animation-delay:0s]"></div>
        <div class="w-3 h-3 bg-blue-400 rounded-full animate-bounce [animation-delay:0.3s]"></div>
        <div class="w-3 h-3 bg-blue-200 rounded-full animate-bounce [animation-delay:0.6s]"></div>
      </div>
    </form>
<div id="uiMessage" class="hidden mt-4 px-4 py-2 rounded text-sm font-medium"></div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    window.supabase = createClient(
      'https://mlwxxtvsozhwzjxmsvbg.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1sd3h4dHZzb3pod3pqeG1zdmJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4OTAwOTksImV4cCI6MjA2NDQ2NjA5OX0.i9KySUVeot9imnALKr79DYySocuj0_rko4nzPhPxekU'
    );

const form = document.getElementById('supportForm');
  const loader = document.getElementById('loader');
  const statusMsg = document.getElementById('statusMsg');
  const submitBtn = document.getElementById('submitBtn');
  const uiMessage = document.getElementById('uiMessage');

  async function getCurrentUser() {
    const { data: { user }, error } = await window.supabase.auth.getUser();
    if (error || !user) {
      showMessage("You must be logged in to send a support message.", "red");
      throw new Error("No user session");
    }
    return user;
  }

  function showMessage(msg, type = "blue") {
    const colors = {
      red: "bg-red-100 text-red-700 border border-red-300",
      green: "bg-green-100 text-green-700 border border-green-300",
      yellow: "bg-yellow-100 text-yellow-700 border border-yellow-300",
      blue: "bg-blue-100 text-blue-700 border border-blue-300"
    };

    uiMessage.className = `mt-4 px-4 py-2 rounded text-sm font-medium ${colors[type]}`;
    uiMessage.textContent = msg;
    uiMessage.classList.remove("hidden");

    setTimeout(() => uiMessage.classList.add("hidden"), 5000);
  }

  form.addEventListener('submit', async function (e) {
    e.preventDefault();
    loader.classList.remove('hidden');
    submitBtn.disabled = true;

    const name = document.getElementById('name').value.trim();
    const message = document.getElementById('message').value.trim();

    try {
      const user = await getCurrentUser();

      const startOfMonth = new Date();
      startOfMonth.setDate(1);
      startOfMonth.setHours(0, 0, 0, 0);

      const { count, error: countError } = await window.supabase
        .from('support_tickets')
        .select('*', { count: 'exact', head: true })
        .eq('user_id', user.id)
        .gte('created_at', startOfMonth.toISOString());

      if (countError) throw countError;
      if (count >= 3) {
        showMessage("⚠️ You've already sent 3 support requests this month.", "yellow");
        return;
      }

      const { data, error } = await window.supabase
        .from('support_tickets')
        .insert([{ name, message, user_id: user.id }]);

      if (error) {
        throw error;
      }

      showMessage("Message sent successfully!", "green");
      statusMsg.classList.remove('hidden');
      form.reset();
    } catch (err) {
      console.error(err);
      showMessage("❌ Something went wrong. Please try again.", "red");
    } finally {
      loader.classList.add('hidden');
      submitBtn.disabled = false;
    }
  });
</script>
</body>
</html>
