<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Top Student - Share Your Experience</title>
  <link rel="icon" type="image/png" sizes="32x32" href="../images/favicon.png">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body class="bg-gradient-to-b from-blue-50 to-blue-100 min-h-screen text-gray-800">

  <!-- Header -->
  <header class="flex justify-between items-center bg-gray-900 px-6 py-4 shadow-md">
    <h1 class="text-xl font-bold text-white">Top Student</h1>
    <nav class="flex gap-4 text-sm text-white">
      <a href="standard.html" class="hover:text-[#0EA5E9]" autocomplete="off">Dashboard</a>
      <a href="contact.html" class="hover:text-[#0EA5E9]" autocomplete="off"><i class="fa-solid fa-phone"></i></a>
      <a href="../index.html" class="hover:text-[#0EA5E9]" autocomplete="off"><i class="fa-solid fa-right-from-bracket"></i></a>
    </nav>
  </header>

  <!-- Main Content -->
  <main class="max-w-2xl mx-auto mt-10 bg-white p-8 rounded-lg shadow-md">
    <h2 class="text-2xl font-bold mb-6 text-center">Share Your Experience</h2>
    <p class="text-sm text-gray-600 mb-6 text-center">
      We’d love to hear how Top Student has helped you. Your story could inspire others.
    </p>

    <form id="experienceForm" class="space-y-6" enctype="multipart/form-data" autocomplete="on">
      <!-- Full Name -->
      <div>
        <label for="fullName" class="block text-sm font-medium text-gray-700">Full Name</label>
        <input
          type="text"
          id="fullName"
          name="fullName"
          required
          autocomplete="name"
          class="mt-1 w-full border border-gray-300 p-2 rounded-md focus:ring-blue-500 focus:border-blue-500"
          placeholder="Your full name"
        />
      </div>

      <!-- Email (optional) -->
      <div>
        <label class="block mt-4 font-medium" for="can_publish">
  Can we publish your experience?
</label>
<select name="can_publish" id="can_publish" required class="mt-1 block w-full border border-gray-300 rounded p-2">
  <option value="" disabled selected>Select an option</option>
  <option value="true">Yes, I agree</option>
  <option value="false">No, keep it private</option>
</select>
      </div>

      <!-- Experience Textarea -->
      <div>
        <label for="message" class="block text-sm font-medium text-gray-700">Your Experience</label>
        <textarea
          id="message"
          name="message"
          rows="6"
          required
          placeholder="Write your honest thoughts here..."
          class="mt-1 w-full border border-gray-300 p-2 rounded-md focus:ring-blue-500 focus:border-blue-500"
          autocomplete="off"
        ></textarea>
      </div>

      <!-- Rating -->
      <div>
        <label for="rating" class="block text-sm font-medium text-gray-700">Rating</label>
        <select
          id="rating"
          name="rating"
          required
          class="mt-1 w-full border border-gray-300 p-2 rounded-md focus:ring-blue-500 focus:border-blue-500"
          autocomplete="off"
        >
          <option value="">Select rating</option>
          <option value="5">⭐️⭐️⭐️⭐️⭐️ - Best</option>
          <option value="4">⭐️⭐️⭐️⭐️ - Great</option>
          <option value="3">⭐️⭐️⭐️ - Good</option>
          <option value="2">⭐️⭐️ - Okay</option>
          <option value="1">⭐️ - Needs work</option>
        </select>
      </div>

      <!-- Picture Upload -->
      <div>
        <label for="image" class="block text-sm font-medium text-gray-700">Upload a Photo (optional)</label>
        <input
          type="file"
          id="image"
          name="image"
          accept="image/jpeg, image/png"
          class="mt-1 w-full border border-gray-300 p-2 rounded-md bg-white focus:ring-blue-500 focus:border-blue-500"
          autocomplete="off"
        />
        <p class="text-xs text-gray-500 mt-1">Supported formats: JPG, PNG. Max size: 5MB</p>
      </div>

      <!-- Submit Button -->
      <div class="text-center">
        <button
          type="submit"
          id="submitBtn"
          class="bg-blue-600 text-white px-5 py-2 rounded hover:bg-blue-700"
        >
          Submit Feedback
        </button>
      </div>
    </form>

    <div id="statusMessage" class="mt-4 text-center text-sm"></div>
  </main>

  <!-- Footer -->
  <footer class="text-center text-sm text-gray-500 mt-10 mb-4">
    &copy; 2025 Top Student. All rights reserved.
  </footer>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

  const supabase = createClient(
    'https://mlwxxtvsozhwzjxmsvbg.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1sd3h4dHZzb3pod3pqeG1zdmJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4OTAwOTksImV4cCI6MjA2NDQ2NjA5OX0.i9KySUVeot9imnALKr79DYySocuj0_rko4nzPhPxekU'
  );
  
  const form = document.getElementById("experienceForm");
  const submitBtn = document.getElementById("submitBtn");
  const statusMessage = document.getElementById("statusMessage");

  let userId = null;

  // ⛔️ Hide form if user already submitted
  async function checkExistingExperience() {
    const { data: userData, error: userError } = await supabase.auth.getUser();
    if (userError || !userData.user) {
      console.error("User not logged in.");
      return;
    }

    userId = userData.user.id;

    const { data: experience, error } = await supabase
      .from("experiences")
      .select("id")
      .eq("user_id", userId)
      .maybeSingle();

    if (error) {
      console.error("Check failed:", error);
      return;
    }

    if (experience) {
      form.style.display = "none";
      statusMessage.innerHTML = '<i class="fas fa-check text-green-500 mr-2"></i> You\'ve already submitted your experience.';
      statusMessage.className = "mt-4 text-center text-green-600 font-semibold";
    }
  }

  await checkExistingExperience();

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    submitBtn.disabled = true;
    submitBtn.textContent = "Submitting...";
    statusMessage.textContent = "";

    const { data: userData, error: authError } = await supabase.auth.getUser();
    if (authError || !userData.user) {
      alert("You're not logged in.");
      return;
    }

    userId = userData.user.id;

    // ⛔️ Check again before submit
    const { data: exists } = await supabase
      .from("experiences")
      .select("id")
      .eq("user_id", userId)
      .maybeSingle();

    if (exists) {
      statusMessage.textContent = "❌ You’ve already submitted.";
      statusMessage.className = "mt-4 text-center text-red-600 font-semibold";
      form.style.display = "none";
      return;
    }

    const fullName = form.fullName.value.trim();
    const message = form.message.value.trim();
    const rating = parseInt(form.rating.value);
    const can_publish = form.can_publish.value === "true";
    const fileInput = form.image;

    let imageUrl = null;

    if (fileInput.files.length > 0) {
      const file = fileInput.files[0];
      if (file.size > 5 * 1024 * 1024) {
        alert("Max photo size is 5MB.");
        submitBtn.disabled = false;
        submitBtn.textContent = "Submit Feedback";
        return;
      }

      const fileName = `${Date.now()}_${file.name}`;
      const { data: uploadData, error: uploadError } = await supabase
        .storage
        .from("feedback-photos")
        .upload(fileName, file);

      if (uploadError) {
        alert("Error uploading image.");
        return;
      }

      const { data: publicUrlData } = supabase
        .storage
        .from("feedback-photos")
        .getPublicUrl(fileName);

      imageUrl = publicUrlData.publicUrl;
    }

    const { error } = await supabase.from("experiences").insert([{
      fullName,
      message,
      rating,
      can_publish,
      image_url: imageUrl,
      user_id: userId
    }]);

    if (error) {
      console.error("Insert error:", error);
      statusMessage.textContent = `❌ ${error.message}`;
      statusMessage.className = "mt-4 text-center text-red-600 font-semibold";
    } else {
      statusMessage.textContent = "✅ Thank you for your feedback!";
      statusMessage.className = "mt-4 text-center text-green-600 font-semibold";
      form.style.display = "none";
    }

    submitBtn.disabled = false;
    submitBtn.textContent = "Submit Feedback";
  });
</script>

</body>
</html>
