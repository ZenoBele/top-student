<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Top Student helps Grade 12 learners excel with past papers, study guides, reminders, and one-on-one support." />
  <meta name="keywords" content="Top Student, Study Help, Grade 12, Exam Papers, Study Guides, South Africa, Bellshire" />
  <meta name="author" content="Top Student by Bellshire" />
  <title>Top Student ‚Äì Dashboard</title>
  <link rel="icon" type="image/png" sizes="32x32" href="../images/favicon.png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
<body class="bg-gradient-to-b from-blue-100 to-white text-gray-800 font-sans">

  <!-- Header -->
  <header class="flex justify-between items-center bg-gray-900 px-6 py-4 shadow-md">
    <div>
      <h1 class="text-xl font-bold text-white">Top Student</h1>
    </div>
    <div class="flex items-center gap-4">
      <nav class="space-x-4 text-sm">
        <a href="standard.html" class="text-white hover:text-[#0EA5E9]">Dashboard</a>
        <a href="contact.html" class="text-white hover:text-[#0EA5E9]"><i class="fa-solid fa-phone"></i></a>
        <a href="../index.html" class="text-white hover:text-[#0EA5E9]"><i class="fa-solid fa-right-from-bracket"></i></a>
      </nav>
    </div>
  </header>

  <main class="max-w-5xl mx-auto mt-10 px-4 space-y-10">
    <div class="text-center space-y-3">
      <h2 class="text-3xl font-bold text-gray-800 flex justify-center items-center gap-2">
        <i class="fa-solid fa-graduation-cap text-blue-600"></i> Welcome!
      </h2>
      <p class="text-gray-600">Top Student is with you every step of the way. Stay focused and never give up.</p>
      <div class="flex justify-center">
        <span class="inline-flex items-center gap-2 bg-blue-100 text-blue-800 text-sm px-3 py-1 rounded-full">
          <i class="fas fa-star"></i> Standard Plan
        </span>
      </div>
    </div>

    <!-- Plan Card -->
    <div class="bg-white shadow rounded-lg p-6 space-y-4">
      <h3 class="text-xl font-semibold text-gray-700 flex items-center gap-2">
        <i class="fas fa-layer-group text-blue-500"></i> Plan Status
      </h3>
      <p>You‚Äôre on the <strong>Standard Plan</strong>. Upgrade to unlock all premium features.</p>
      <a href="manage.html">
        <button class="mt-2 px-4 py-2 border border-blue-600 text-blue-600 rounded hover:bg-blue-600 hover:text-white transition text-sm">Manage Subscription</button>
      </a>
    </div>

    <!-- Services Card -->
    <div class="bg-white shadow rounded-lg p-6 space-y-4">
      <h3 class="text-xl font-semibold text-gray-700 flex items-center gap-2">
        <i class="fas fa-cogs text-blue-600"></i> Your Services
      </h3>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div class="flex justify-between items-center border-b pb-2">
          <span><i class="fas fa-book text-yellow-500"></i> Study Guides</span>
          <a href="../guides.html" class="text-blue-600 hover:underline text-sm">Go to Guides</a>
        </div>
        <div class="flex justify-between items-center border-b pb-2">
          <span><i class="fas fa-file-alt text-yellow-500"></i> Past Papers</span>
          <a href="../papers.html" class="text-blue-600 hover:underline text-sm">Browse Papers</a>
        </div>
        <div class="flex justify-between items-center border-b pb-2">
          <span><i class="fas fa-newspaper text-yellow-500"></i> Career News</span>
          <a href="../news.html" class="text-blue-600 hover:underline text-sm">News</a>
        </div>
        <div class="flex justify-between items-center border-b pb-2">
          <span><i class="fas fa-bell text-yellow-500"></i> Reminder System</span>
          <a href="reminder.html" class="text-blue-600 hover:underline text-sm">Edit</a>
        </div>
        <div class="flex justify-between items-center border-b pb-2">
          <span><i class="fas fa-chart-bar text-yellow-500"></i> Progress Reports</span>
          <a href="report.html" class="text-blue-600 hover:underline text-sm">Activate/Deactivate</a>
        </div>
        <div class="flex justify-between items-center border-b pb-2">
          <span><i class="fas fa-brain text-yellow-500"></i> AI Exam Estimation</span>
          <a href="exam.html" class="text-blue-600 hover:underline text-sm">Get Estimations</a>
        </div>
        <div class="flex justify-between items-center">
          <span><i class="fas fa-user text-yellow-500"></i> Exam Strategies</span>
          <a href="tips.html" class="text-blue-600 hover:underline text-sm">Get Tips</a>
        </div>
      </div>
    </div>

    <!-- Two Column Section -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-start">

  <!-- News Section -->
  <div id="news-section" class="bg-white shadow rounded-lg p-6 space-y-4">
    <h3 class="text-xl font-semibold text-gray-700 flex items-center gap-2">
      <i class="fas fa-bell text-red-500"></i> News
    </h3>
    <div id="news-list" class="space-y-2">
      <p class="text-sm text-gray-500">Loading latest news...</p>
    </div>
  </div>

  <!-- Your Space Section -->
  <div class="bg-white shadow rounded-lg p-6 space-y-3">
    <h3 class="text-xl font-semibold text-gray-700 flex items-center gap-2">
      <i class="fas fa-user text-blue-500"></i> Your Space
    </h3>
    <ul class="space-y-2 text-sm">
      <li><a href="profile-view.html" class="text-blue-600 hover:underline"><i class="fas fa-user-edit text-green-500"></i> View Profile</a></li>
      <li><a href="experience.html" class="text-blue-600 hover:underline"><i class="fas fa-receipt text-green-500"></i> Share Your Experience</a></li>
      <li><a href="account.html" class="text-blue-600 hover:underline"><i class="fas fa-gear text-green-500"></i> Account</a></li>
      <li><a href="../index.html" class="text-blue-600 hover:underline"><i class="fas fa-sign-out-alt text-green-500"></i> Logout</a></li>
    </ul>
  </div>

</div>
  </main>

  <!-- Bottom Margin -->
  <div class="mb-10"></div>

<div id="loader" class="fixed inset-0 bg-white bg-opacity-80 z-50 flex flex-row items-center justify-center space-x-2">
    <div class="w-5 h-5 bg-blue-600 rounded-full animate-bounce"></div>
    <div class="w-5 h-5 bg-blue-400 rounded-full animate-bounce animation-delay-150"></div>
    <div class="w-5 h-5 bg-blue-200 rounded-full animate-bounce animation-delay-300"></div>
  </div>
  
<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  const supabase = createClient(
    'https://mlwxxtvsozhwzjxmsvbg.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1sd3h4dHZzb3pod3pqeG1zdmJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4OTAwOTksImV4cCI6MjA2NDQ2NjA5OX0.i9KySUVeot9imnALKr79DYySocuj0_rko4nzPhPxekU'
  );

  const loader = document.getElementById('loader');

  // üîí Load profile from sessionStorage (no DB fetch)
  const profile = JSON.parse(sessionStorage.getItem('user_profile'));

  // ‚ö†Ô∏è Check subscription if date exists
async function checkSubscriptionStatus() {
  if (!profile || !profile.last_paid_at) {
    window.location.href = '../index.html';
    return;
  }

  loader.classList.add('hidden');

  const now = new Date();
  const lastPaid = new Date(profile.last_paid_at);
  const daysSince = Math.floor((now - lastPaid) / (1000 * 60 * 60 * 24));

  // ‚úÖ Downgrade if expired and still standard
  if (daysSince >= 30 && profile.role === 'standard') {
    const { error: downgradeError } = await supabase
      .from('profiles')
      .update({
        role: 'free',
        previous_role: 'standard',
        status: false
      })
      .eq('id', profile.id); // or user.id if profile doesn't contain `id`

    if (downgradeError) {
      console.error("Failed to downgrade expired account:", downgradeError.message);
      alert("Something went wrong updating your subscription status.");
      return;
    }

    alert("‚ö†Ô∏è Your subscription has expired. Please renew to continue.");
    window.location.href = 'renew.html';
  }

  // ‚ö†Ô∏è Warning if close to expiration
  else if (daysSince >= 25 && profile.role === 'standard') {
    const banner = document.createElement('div');
    banner.className = "relative bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-3 mb-4 text-sm flex items-start justify-between gap-4";
    banner.innerHTML = `
      <div>
        ‚ö†Ô∏è Your subscription expires in <strong>${30 - daysSince}</strong> days.
        <a href="renew.html" class="underline text-yellow-800 hover:text-yellow-600 ml-1">Renew Now</a>
      </div>
      <button id="close-banner" class="font-bold text-lg leading-none text-yellow-700 hover:text-red-600 focus:outline-none">&times;</button>
    `;

    document.body.prepend(banner);
    document.getElementById('close-banner').addEventListener('click', () => {
      banner.remove();
    });
  }
}

checkSubscriptionStatus();

  // üì∞ Load news
  const newsList = document.getElementById('news-list');

  async function loadNews() {
    const { data, error } = await supabase
      .from('news')
      .select('*')
      .order('created_at', { ascending: false })
      .limit(1);

    newsList.innerHTML = '';

    if (error) {
      newsList.innerHTML = `<p class="text-red-600">Failed to load news.</p>`;
      console.error(error);
      return;
    }

    if (data.length === 0) {
      newsList.innerHTML = `<p class="text-gray-500">No news at the moment.</p>`;
      return;
    }

    data.forEach(news => {
      const item = document.createElement('div');
      item.className = 'bg-gray-50 p-3 rounded border-l-4 border-red-500';
      item.innerHTML = `
        <p class="font-semibold text-gray-700">
          <i class="fas fa-circle text-[10px] mr-2 text-red-400"></i>${news.title}
        </p>
        <p class="text-sm text-gray-600">${news.body}</p>
      `;
      newsList.appendChild(item);
    });
  }

  loadNews();

document.addEventListener("DOMContentLoaded", async () => {
  const { data: { user } } = await supabase.auth.getUser()
  if (!user) return // not logged in

  const { data: profile, error } = await supabase
    .from('profiles')
    .select('trial, created_at, role')
    .eq('id', user.id)
    .single()

  if (error || !profile?.trial) return

  const createdAt = new Date(profile.created_at)
  const now = new Date()
  const msInDay = 1000 * 60 * 60 * 24
  const daysPassed = Math.floor((now - createdAt) / msInDay)
  const daysLeft = 7 - daysPassed

if (daysPassed >= 7) {
  // Trial expired ‚Üí Update role and logout
  await supabase
    .from('profiles')
    .update({ role: 'free', previous_role: 'standard', trial: false })
    .eq('id', user.id)

  await Swal.fire({
    icon: 'info',
    title: 'Trial Ended',
    text: 'Your trial has ended. Press OK to renew.',
    confirmButtonText: 'OK'
  })

  window.location.href = 'renew.html'

  } else if (daysLeft <= 2) {
    // Trial expiring soon ‚Üí Alert
    Swal.fire({
      icon: 'warning',
      title: '‚è≥ Trial Almost Over',
      text: `You have only ${daysLeft} day${daysLeft === 1 ? '' : 's'} left in your trial.`,
      confirmButtonText: 'Renew',
      showCancelButton: true,
      cancelButtonText: 'Later',
      confirmButtonColor: '#3B82F6',
      cancelButtonColor: '#6b7280'
    }).then((result) => {
      if (result.isConfirmed) {
        window.location.href = 'renew.html'
      }
    })
  }
});
</script>
</body>
</html>
