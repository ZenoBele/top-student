<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Payment - Top Student</title>
  <link rel="icon" type="image/png" sizes="32x32" href="../images/favicon.png">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-blue-100 min-h-screen px-4 py-10 font-sans text-aqua-900">

  <div class="max-w-3xl mx-auto space-y-8">
    <header class="text-center">
      <h1 class="text-3xl font-bold text-blue-500">Payment History</h1>
      <p class="text-sm text-black mt-2">Track your previous Top Student subscription transactions.</p>
    </header>

    <div id="loader" class="text-center text-blue-400">Loading payment history...</div>

    <div id="historyList" class="space-y-4 hidden"></div>

    <div class="text-center pt-6">
      <a href="manage.html" class="inline-block text-blue-500 hover:underline text-sm font-medium">
        ← Back to Manage Subscription
      </a>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const supabase = createClient(
      'https://mlwxxtvsozhwzjxmsvbg.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1sd3h4dHZzb3pod3pqeG1zdmJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4OTAwOTksImV4cCI6MjA2NDQ2NjA5OX0.i9KySUVeot9imnALKr79DYySocuj0_rko4nzPhPxekU'
    );

    const loader = document.getElementById('loader');
    const historyList = document.getElementById('historyList');

    function showToast(msg) {
      alert(msg); // You can replace this with a custom toast if you want
    }

    function formatDate(dateStr) {
      const date = new Date(dateStr);
      return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function addEntry(payment) {
      const item = document.createElement('div');
      item.className = "bg-blue-100";

      item.innerHTML = `
  <div class="bg-blue-100 shadow-md rounded-xl p-4 border border-blue-500 transition duration-300 ease-in-out hover:border-white hover:shadow-lg">
    <div class="flex justify-between items-start">
      <div>
        <p class="text-xl font-bold text-blue-500">R${payment.amount}</p>
        <p class="text-sm text-gray-400">${payment.type || 'Subscription'}</p>
        <p class="text-xs text-gray-400 mt-1">${formatDate(payment.paid_at)}</p>
      </div>
      <div class="text-right">
        ${payment.download_url ? `
          <a href="${payment.download_url}" target="_blank"
             class="inline-block text-sm text-white bg-blue-500 hover:bg-blue-600 px-4 py-1 rounded-full shadow">
            Download PDF
          </a>
        ` : `
          <span class="text-xs text-gray-400 italic">No PDF</span>
        `}
      </div>
    </div>
  </div>
`;
      historyList.appendChild(item);
    }

    async function getUser() {
      const { data: { user }, error } = await supabase.auth.getUser();
      if (error || !user) {
        showToast("You're not logged in.");
        return null;
      }
      return user;
    }

    async function loadPayments() {
      loader.style.display = 'block';
      historyList.innerHTML = '';
      historyList.classList.add('hidden');

      const user = await getUser();
      if (!user) {
        loader.style.display = 'none';
        return;
      }

      const { data, error } = await supabase
        .from('payments')
        .select('*')
        .eq('user_id', user.id)
        .order('paid_at', { ascending: false });

      loader.style.display = 'none';

      if (error) {
        showToast("Failed to load payments: " + error.message);
        return;
      }

      if (!data || data.length === 0) {
        historyList.innerHTML = `<p class="text-center text-gray-500">No payment history found.</p>`;
      } else {
        data.forEach(addEntry);
      }

      historyList.classList.remove('hidden');
    }

 async function generateAndStorePDF(user, amount, plan = 'Standard Plan') {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const paidAt = new Date();
  const paidAtString = paidAt.toLocaleString();
  const invoiceId = `IN${Date.now()}-${Math.floor(Math.random() * 1000)}`;

  // === STYLE ===
  const lineY = (y) => doc.line(15, y, 195, y); // horizontal line
  doc.setFont('helvetica', 'normal');
  doc.setTextColor(0, 0, 0);
  doc.setDrawColor(150);

  // === HEADER ===
  doc.setFontSize(18);
  doc.text('Top Student Invoice', 15, 20);
  doc.setFontSize(12);
  doc.text(`Invoice #: ${invoiceId}`, 135, 20);
  lineY(25);

  // === BILL TO & FROM ===
  doc.setFontSize(10);
  doc.text('From:', 15, 32);
  doc.text('Top Student', 15, 37);
  doc.text('info@topstudent.co.za', 15, 42);
  doc.text('topstudent.co.za', 15, 47);

  doc.text('Billed To:', 110, 32);
  doc.text(user.email, 110, 37);
  doc.text(user.id, 110, 47);
  lineY(52);

  // === INVOICE DETAILS GRID ===
  doc.setFont('helvetica', 'bold');
  doc.text('Description', 15, 60);
  doc.text('Plan', 95, 60);
  doc.text('Amount (ZAR)', 150, 60);
  lineY(62);

  doc.setFont('helvetica', 'normal');
  doc.text('Top Student Subscription', 15, 70);
  doc.text(plan, 95, 70);
  doc.text(`R${amount}`, 150, 70);
  lineY(75);

  // === FOOTER DETAILS ===
  doc.setFontSize(10);
  doc.setFont('helvetica', 'normal');
  doc.text(`Date Paid: ${paidAtString}`, 15, 85);
  doc.text(`User ID: ${user.id}`, 15, 90);

  doc.setFont('helvetica', 'italic');
  doc.text("Thank you for your payment!", 15, 105);
  doc.text("Need help? Contact us at info@topstudent.co.za", 15, 110);

  // === WATERMARK ===
  doc.setFontSize(50);
  doc.setTextColor(240);
  doc.text('Top Student', 105, 180, { align: 'center', angle: 45 });

  // === OUTPUT ===
  const pdfBlob = doc.output("blob");
  const fileName = `receipt-${invoiceId}-${user.id}.pdf`;

  const { error: uploadErr } = await supabase.storage
    .from('receipts')
    .upload(fileName, pdfBlob, {
      cacheControl: '3600',
      upsert: false,
      contentType: 'application/pdf',
    });

  if (uploadErr) {
    showToast("Upload failed: " + uploadErr.message);
    return null;
  }

  const { data } = supabase.storage.from('receipts').getPublicUrl(fileName);
  const publicUrl = data.publicUrl;

  // ✅ Insert record with invoiceId
  const { error: insertErr } = await supabase.from('payments').insert([{
    user_id: user.id,
    amount,
    type: plan,
    invoice: invoiceId, // ✅ here
    paid_at: paidAt.toISOString(),
    download_url: publicUrl
  }]);

  if (insertErr) {
    showToast("Failed to log payment: " + insertErr.message);
    return null;
  }

  showToast("Invoice generated and saved.");
  return publicUrl;
}

    loadPayments();
  </script>
</body>
</html>
