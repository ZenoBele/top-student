<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Top Student - Reminder Preferences</title>
  <link rel="icon" type="image/png" sizes="32x32" href="../images/favicon.png">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body class="bg-gradient-to-b from-blue-50 to-blue-100 text-gray-800 font-sans min-h-screen">
  <!-- Top Bar -->
  <header class="flex justify-between items-center bg-gray-900 px-6 py-4 shadow-md">
    <div>
      <h1 class="text-xl font-bold text-white">Top Student</h1>
    </div>
    <div class="flex items-center gap-4">
      <nav class="space-x-4 text-sm">
        <a href="standard.html" class="text-white hover:text-[#0EA5E9]">Dashboard</a>
        <a href="contact.html" class="text-white hover:text-[#0EA5E9]"><i class="fa-solid fa-phone"></i></a>
        <a href="../index.html" class="text-white hover:text-[#0EA5E9]"><i class="fa-solid fa-right-from-bracket"></i></a>
      </nav>
    </div>
  </header>

  <!-- Reminder Banner -->
  <div id="reminderBanner" class="hidden cursor-pointer mx-6 mt-4 p-4 bg-green-100 text-green-800 border border-green-400 rounded text-sm">
    <i class="fas fa-check text-green-500 mr-2"></i> You have a reminder set. Click here to turn it OFF.
  </div>	

  <!-- Form Section -->
  <main class="max-w-3xl mx-auto p-6 mt-8 bg-white rounded-lg shadow-md">
    <h2 class="text-2xl font-semibold mb-6 text-gray-800">Reminder System Preferences</h2>
	
    <form id="reminderForm">
      <!-- Full Name -->
      <div class="mb-4">
        <label for="fullName" class="block text-sm font-medium text-gray-700">Full Name</label>
        <input id="fullName" type="text" name="fullName" required placeholder="e.g. Anele Mokoena"
          class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500">
      </div>

      <!-- Contact Number -->
      <div class="mb-4">
        <label for="contact" class="block text-sm font-medium text-gray-700">Contact Number</label>
        <input id="contact" type="tel" name="contact" required placeholder="+27 600 000 000"
          class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500">
      </div>

      <!-- Platforms -->
      <div class="mb-4">
        <span class="block text-sm font-medium text-gray-700">Preferred Platforms</span>
        <div class="mt-2 space-y-2">
          <label for="platformWhatsApp" class="inline-flex items-center">
            <input id="platformWhatsApp" type="checkbox" name="platforms" value="WhatsApp" class="form-checkbox text-blue-600">
            <span class="ml-2 text-gray-700">WhatsApp</span>
          </label>
          <label for="platformSMS" class="inline-flex items-center">
            <input id="platformSMS" type="checkbox" name="platforms" value="SMS" class="form-checkbox text-blue-600">
            <span class="ml-2 text-gray-700">SMS</span>
          </label>
          <label for="platformEmail" class="inline-flex items-center">
            <input id="platformEmail" type="checkbox" name="platforms" value="Email" class="form-checkbox text-blue-600">
            <span class="ml-2 text-gray-700">Email</span>
          </label>
        </div>
      </div>

      <!-- Reminder Topic -->
      <div class="mb-4">
        <label for="reminderTopic" class="block text-sm font-medium text-gray-700">Things you need a reminder for</label>
        <input id="reminderTopic" type="text" name="reminderTopic" required
          placeholder="e.g. Life Sciences Study Session or Maths Exam"
          class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500">
      </div>

      <!-- Caption -->
      <div class="mb-4">
        <label for="caption" class="block text-sm font-medium text-gray-700">Caption</label>
        <input id="caption" type="text" name="caption" required
          placeholder="e.g. Remind about Life Sciences study session or Prepare for next week maths exam"
          class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500">
      </div>

<div class="mb-4">
  <label for="reminderDate" class="block text-sm font-medium text-gray-700">Reminder Date</label>
  <input id="reminderDate" type="date" name="reminderDate" required
    class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500">
</div>

      <!-- Reminder Time -->
      <div class="mb-6">
        <label for="timing" class="block text-sm font-medium text-gray-700">When should we remind you?</label>
        <select id="timing" name="timing" required
          class="mt-1 block w-full border border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500">
          <option value="" disabled selected>Select a time</option>
          <option value="1 day before">1 day before</option>
          <option value="1 week before">1 week before</option>
          <option value="1 month before">1 month before</option>
        </select>
      </div>

      <!-- Loading -->
      <p id="loadingText" class="text-sm text-blue-600 mt-2 hidden">Saving your reminder...</p>

      <!-- Submit -->
      <div class="pt-4">
        <button type="submit" class="bg-blue-600 text-white px-5 py-2 rounded hover:bg-blue-700">Set Preferences</button>
      </div>
    </form>
  </main>

  <script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

  const supabase = createClient(
    'https://mlwxxtvsozhwzjxmsvbg.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1sd3h4dHZzb3pod3pqeG1zdmJnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg4OTAwOTksImV4cCI6MjA2NDQ2NjA5OX0.i9KySUVeot9imnALKr79DYySocuj0_rko4nzPhPxekU'
  );

  const form = document.getElementById('reminderForm')
  const banner = document.getElementById('reminderBanner')
  const loading = document.getElementById('loadingText')

    async function checkReminder() {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return;

    const { data, error } = await supabase
      .from('reminders')
      .select('*')
      .eq('user_id', user.id)
      .maybeSingle();

    if (data) {
      banner.classList.remove('hidden');
    }
  }

  checkReminder();

  // ❌ B. Cancel reminder if user clicks banner
  banner.addEventListener('click', async () => {
    const confirmDelete = confirm("Are you sure you want to cancel your reminder?");
    if (!confirmDelete) return;

    const { data: { user } } = await supabase.auth.getUser();

    const { error } = await supabase
      .from('reminders')
      .delete()
      .eq('user_id', user.id);

    if (!error) {
      alert("Reminder cancelled.");
      banner.classList.add('hidden');
    } else {
      console.error(error);
      alert("Failed to cancel reminder.");
    }
  });

  form.addEventListener('submit', async (e) => {
  e.preventDefault()
  loading.classList.remove('hidden')

  const { data: { user } } = await supabase.auth.getUser();  // ✅ GET USER HERE

  const formData = new FormData(form)
  const platforms = formData.getAll('platforms')

  const reminder = {
    user_id: user.id,
    full_name: formData.get('fullName'),
    contact_number: formData.get('contact'),
    platforms: platforms,
    reminder_topic: formData.get('reminderTopic'),
    caption: formData.get('caption'),
    reminder_date: formData.get('reminderDate'),
    timing: formData.get('timing')
  }

  const { data: existingReminder, error: checkError } = await supabase
  .from('reminders')
  .select('*')
  .eq('user_id', user.id)
  .maybeSingle();

if (checkError) {
  alert("Failed to check existing reminders.");
  loading.classList.add('hidden');
  return;
}

if (existingReminder) {
  alert("You already have a reminder set. Please cancel it first before adding a new one.");
  loading.classList.add('hidden');
  return;
}

// Safe to insert now
const { error } = await supabase.from('reminders').insert(reminder);

loading.classList.add('hidden');

if (error) {
  alert('Error saving reminder: ' + error.message);
} else {
  alert('Reminder saved successfully!');
  form.reset();
  banner.classList.remove('hidden');
}

  if (error) {
    alert('Error saving reminder: ' + error.message)
  } else {
    alert('Reminder saved successfully!')
    form.reset()
    banner.classList.remove('hidden')  // ✅ Optional: show the banner again
  }
})
</script>
</body>
</html>
