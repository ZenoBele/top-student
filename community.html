<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Top Student Q&A Board</title>
<link rel="icon" type="image/png" sizes="32x32" href="../images/favicon.png">
<script type="module" src="js/security.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
<style>
  .glass {
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }
  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
</style>
</head>
<body class="flex h-screen bg-gradient-to-br from-blue-200 to-blue-700 font-sans">

<!-- Sidebar -->
  <aside class="w-64 hidden md:flex flex-col fixed top-0 left-0 bottom-0 mt-12 mb-12 z-50 text-white overflow-y-auto rounded-3xl"
       style="background: linear-gradient(180deg,#0a0059,#3e95be); box-shadow: 0 20px 50px rgba(0,0,0,0.9); -ms-overflow-style: none;">
  <nav class="px-4 py-6 space-y-2">
    <a href="dashboard.html" data-service="dashboard.html"
       class="flex items-center gap-3 p-2 rounded-lg transition hover:bg-white hover:text-blue-900">
      <i class="fa-solid fa-house"></i><span>Dashboard</span>
    </a>
    <a href="reminder.html" data-service="reminder.html"
       class="flex items-center gap-3 p-2 rounded-lg transition hover:bg-white hover:text-blue-900">
      <i class="fa-solid fa-bell"></i><span>What I Missed</span>
    </a>
    <a href="challenge.html" data-service="challenge.html"
       class="flex items-center gap-3 p-2 rounded-lg transition hover:bg-white hover:text-blue-900">
      <i class="fa-solid fa-calendar-check"></i><span>The 30 Days Master</span>
    </a>
    <a href="pack.html" data-service="pack.html"
       class="flex items-center gap-3 p-2 rounded-lg transition hover:bg-white hover:text-blue-900">
      <i class="fa-solid fa-book-open"></i><span>Smart Pack</span>
    </a>
    <a href="capability.html" data-service="capability.html"
       class="flex items-center gap-3 p-2 rounded-lg transition hover:bg-white hover:text-blue-900">
      <i class="fa-solid fa-chart-line"></i><span>My Capabilities</span>
    </a>
    <a href="scope.html" data-service="scope.html"
       class="flex items-center gap-3 p-2 rounded-lg transition hover:bg-white hover:text-blue-900">
      <i class="fa-solid fa-lightbulb"></i><span>Study Scope</span>
    </a>
    <a href="nsfas.html" data-service="nsfas.html"
       class="flex items-center gap-3 p-2 rounded-lg transition hover:bg-white hover:text-blue-900">
      <i class="fa-solid fa-piggy-bank"></i><span>NSFAS</span>
    </a>
    <a href="university.html" data-service="university.html"
       class="flex items-center gap-3 p-2 rounded-lg transition hover:bg-white hover:text-blue-900">
      <i class="fa-solid fa-university"></i><span>University</span>
    </a>
    <a href="options.html" data-service="options.html"
       class="flex items-center gap-3 p-2 rounded-lg transition hover:bg-white hover:text-blue-900">
      <i class="fa-solid fa-briefcase"></i><span>My Options</span>
    </a>
    <a href="chat.html" data-service="community.html"
       class="flex items-center gap-3 p-2 rounded-lg transition hover:bg-white hover:text-blue-900">
      <i class="fa-solid fa-comments"></i><span>Community Q&A Board</span>
    </a>
	<a href="read.html" data-service="help.html"
       class="flex items-center gap-3 p-2 rounded-lg transition hover:bg-white hover:text-blue-900">
      <i class="fa-solid fa-chalkboard"></i><span>Read With Me</span>
    </a>
    <a href="account.html"
       class="flex items-center gap-3 p-2 rounded-lg transition hover:bg-white hover:text-blue-900">
      <i class="fa-solid fa-user"></i><span>Account</span>
    </a>
  </nav>
</aside>

<!-- Mobile Menu Button -->
<div class="md:hidden fixed top-2 right-0 p-4 z-50">
    <button id="menuBtn" class="text-white p-2 rounded bg-transparent focus:outline-none">
      <i id="menuIcon" class="fa-solid fa-bars text-2xl"></i>
    </button>
  </div>

  <!-- Blur Overlay -->
  <div id="blurOverlay" class="fixed inset-0 bg-white bg-opacity-30 glass hidden z-40"></div>

  <!-- Header -->
  <header class="flex items-center justify-between px-4 md:px-6 text-white fixed top-0 z-30 h-24 md:h-24
                 w-full md:w-3/4 md:ml-80 md:rounded-b-3xl"
          style="background: linear-gradient(60deg,#0a0059,#38b6ff);">

    <div class="flex flex-col ml-16 items-center flex-1 text-center">
     <h1 class="text-3xl font-bold">Community</h1>
    <p class="text-sm opacity-90">Ask questions, answer peers, and vote on helpful answers.</p>
    </div>

    <!-- Right spacer -->
    <div class="w-20 md:w-28"></div>
  </header>

<!-- Main Content -->
<main class="flex-1 flex flex-col overflow-y-auto relative z-0 mb-12 mt-32 md:ml-64 px-6 md:px-12 space-y-6">

  <!-- Chat Container -->
  <div class="flex flex-col h-[75vh] border rounded-3xl overflow-hidden shadow-2xl glass transition hover:shadow-3xl">
    <!-- Search / Filter -->
    <div class="p-4 flex flex-col md:flex-row shadow-xl items-center gap-4 bg-green-100 backdrop-blur-sm shadow-sm">
  <input 
    type="text" 
    id="searchInput" 
    placeholder="Search by keyword, subject, or name"
    class="flex-1 p-3 rounded-2xl border border-gray-300 shadow-inner focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition duration-300"
  >
  <button 
    id="searchBtn" 
    class="bg-gradient-to-br from-blue-800 to-blue-400 text-white px-6 py-2 rounded-2xl hover:from-blue-400 hover:to-green-200 focus:outline-none focus:ring-2 focus:ring-blue-400 transition duration-300"
  >
    Search
  </button>
<div class="flex items-center gap-2 text-sm text-gray-700">
  <span class="relative flex h-3 w-3">
    <span class="absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75 animate-ping"></span>
    <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
  </span>
  Online: <span id="onlineCount" class="font-semibold">0</span>
</div>
</div>

    <!-- Chat Messages -->
    <div id="chatMessages" class="flex-1 p-4 space-y-3 overflow-y-auto bg-green-100 backdrop-blur-sm scrollbar-hide">
      <!-- Messages will appear here -->
    </div>

    <!-- Chat Input -->
<div class="p-4 flex items-center gap-3 bg-green-100 backdrop-blur-sm shadow-sm">
  <textarea 
    id="chatInput" 
    placeholder="Type your question or answer..."
    rows="1"
    class="flex-1 p-3 rounded-2xl border border-gray-300 shadow-sm resize-none
           focus:outline-none focus:ring-2 focus:ring-blue-400 transition duration-300
           break-words overflow-hidden max-h-40"
  ></textarea>

  <button id="sendBtn"
          class="sendMsgBtn bg-gradient-to-br from-green-400 to-green-200 text-white px-6 py-2 rounded-2xl
                 hover:from-blue-400 hover:to-green-200 transition duration-300 flex items-center justify-center">
    <i class="fas fa-paper-plane"></i>
  </button>
</div>

  </div>
</main>

<script type="module">
    import { supabase } from './js/supabaseClient.js';

// --- DOM refs ---
const chatInput    = document.getElementById('chatInput');
const sendBtn      = document.getElementById('sendBtn');
const chatMessages = document.getElementById('chatMessages');
const searchInput  = document.getElementById('searchInput');
const searchBtn    = document.getElementById('searchBtn');
const onlineCount  = document.getElementById('onlineCount');

// --- State ---
let currentUser = null;
const renderedIds = new Set(); // prevent duplicate renders from realtime + local insert

// Small helper for SweetAlert fallback
function alertErr(title, msg) {
  if (window.Swal) Swal.fire(title, msg, 'error');
  else alert(`${title}\n\n${msg}`);
}

// 1) AUTH + PROFILE
async function initUser() {
  const { data, error } = await supabase.auth.getUser();
  if (error || !data.user) {
    alertErr('Auth required', 'Please log in first.');
    throw new Error('No auth user');
  }

  const user = data.user;
  // Optional: get display name from profiles (if present)
  const { data: profile, error: pErr } = await supabase
    .from('profiles')
    .select('name')
    .eq('id', user.id)
    .maybeSingle();

  if (pErr) console.warn('Profile lookup failed:', pErr?.message);

  currentUser = {
    uid: user.id,
    name: profile?.name || user.user_metadata?.name || 'Student'
  };
}
await initUser();

function formatTime(timestamp) {
  if (!timestamp) return '';
  const date = new Date(timestamp);
  return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

// 2) RENDER ONE MESSAGE
function addMessageToUI(msg) {
  if (!msg || !msg.id) return;
  if (renderedIds.has(msg.id)) return; // avoid duplicates
  renderedIds.add(msg.id);

  const isSelf = msg.user_id === currentUser.uid;

  const wrapper = document.createElement('div');
  wrapper.className = `chat-message flex flex-col gap-1 max-w-full ${isSelf ? 'items-end' : 'items-start'}`;
  wrapper.dataset.id = msg.id;
  wrapper.dataset.author = msg.username || 'Student';
  wrapper.dataset.content = msg.content || '';

  wrapper.innerHTML = `
    <div class="chat-message flex flex-col gap-1 max-w-full ${isSelf ? 'items-end' : 'items-start'}" data-id="${msg.id}">
      
      <!-- Username (only if not self) -->
      ${!isSelf ? `<p class="text-xs font-bold text-gray-600">${msg.username || 'Student'}</p>` : ''}
      <p class="p-3 rounded-2xl max-w-[70%] min-w-0 break-words shadow-md
            ${isSelf 
              ? 'bg-gradient-to-br from-indigo-500 to-purple-500 text-white' 
              : 'bg-gradient-to-br from-yellow-100 to-yellow-200 text-gray-800'} 
            hover:scale-[1.02] transition-transform duration-150">
        ${escapeHtml(msg.content || '')}
      </p>
      <div class="flex items-center gap-3 text-sm mt-1 ${isSelf ? 'justify-end' : 'justify-start'}">
        <button class="upvoteBtn flex items-center gap-1 px-2 py-1 rounded-lg shadow hover:bg-indigo-100 
                       ${Array.isArray(msg.upvotes) && msg.upvotes.includes(currentUser.uid) ? 'bg-indigo-200 text-indigo-800' : 'bg-white text-gray-600'} 
                       transition-colors duration-150" aria-label="Upvote">
          <i class="fa-solid fa-thumbs-up"></i>
          <span>${Array.isArray(msg.upvotes) ? msg.upvotes.length : 0}</span>
        </button>
        <span class="text-[10px] text-gray-400 self-center">
          ${formatTime(msg.created_at)}
        </span>
      </div>
    </div>
  `;
  
  chatMessages.appendChild(wrapper);

  // auto-scroll to newest
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Escape basic HTML to prevent XSS in content
function escapeHtml(str) {
  return String(str)
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;');
}

// 3) INITIAL LOAD
async function fetchMessages() {
  const { data, error } = await supabase
    .from('chats')
    .select('id,user_id,username,content,upvotes,created_at')
    .order('created_at', { ascending: true });

  if (error) {
    alertErr('Load failed', error.message);
    return;
  }

  chatMessages.innerHTML = '';
  renderedIds.clear();
  (data || []).forEach(addMessageToUI);
}
await fetchMessages();

// 4) SEND MESSAGE
async function sendMessage() {
  const text = chatInput.value.trim();
  if (!text) return;

  const { data, error } = await supabase
    .from('chats')
    .insert({
      user_id: currentUser.uid,
      username: currentUser.name,
      content: text
    })
    .select()
    .single();

  if (error) {
    alertErr('Send failed', error.message);
    return;
  }

  // Optimistic render (safe because we de-dupe via id)
  addMessageToUI(data);
  chatInput.value = '';
}
sendBtn.addEventListener('click', sendMessage);
chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });

// 5) REALTIME (Postgres Changes) — messages + votes
const dbChannel = supabase.channel('realtime:chats');

dbChannel
  .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'chats' }, (payload) => {
    addMessageToUI(payload.new);
  })
  .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'chats' }, (payload) => {
  const updated = payload.new;
  const node = document.querySelector(`.chat-message[data-id="${updated.id}"]`);
  if (node) {
    const span = node.querySelector('.upvoteBtn span');
    if (span) span.textContent = Array.isArray(updated.upvotes) ? updated.upvotes.length : 0;
  } else {
    addMessageToUI(updated);
  }
})
  .subscribe((status, err) => {
    if (err) console.error('Realtime subscribe error:', err);
    else console.log('Realtime status:', status);
  });

// 6) UPVOTE (simple increment; consider RPC for high scale concurrency)
chatMessages.addEventListener('click', async (e) => {
  const btn = e.target.closest('.upvoteBtn');
  if (!btn) return;

  const parent = btn.closest('.chat-message');
  const id = parent?.dataset?.id;
  if (!id) return;

  // Fetch current upvotes array
  const { data: row, error: selErr } = await supabase
    .from('chats')
    .select('upvotes')
    .eq('id', id)
    .single();

  if (selErr) {
    alertErr('Upvote failed', selErr.message);
    return;
  }

  let upvotes = row.upvotes || [];
  const userIndex = upvotes.indexOf(currentUser.uid);

  if (userIndex === -1) {
    // User hasn't upvoted yet → add
    upvotes.push(currentUser.uid);
  } else {
    // User already upvoted → remove
    upvotes.splice(userIndex, 1);
  }

  // Update in DB
  const { error: updErr } = await supabase
    .from('chats')
    .update({ upvotes })
    .eq('id', id);

  if (updErr) {
    alertErr('Upvote failed', updErr.message);
    return;
  }

  // Optimistic UI update
  const span = parent.querySelector('.upvoteBtn span');
  if (span) span.textContent = upvotes.length;
});

// 7) REALTIME PRESENCE — live online users (no extra tables)
let presenceChannel = null;

async function initPresence() {
  presenceChannel = supabase.channel('community_chat', {
    config: {
      // If you have Realtime Authorization + private channels configured, set private: true.
      // Otherwise, leave it out to avoid auth policy errors.
      presence: { key: currentUser.uid }
    }
  });

  // When the full presence state syncs (joins/leaves batched)
  presenceChannel.on('presence', { event: 'sync' }, () => {
    updateOnlineFromPresence();
  });

  // Optional: listen to joins/leaves for debugging
  presenceChannel.on('presence', { event: 'join' }, ({ key, newPresences }) => {
    // console.log('Joined:', key, newPresences);
  });
  presenceChannel.on('presence', { event: 'leave' }, ({ key, leftPresences }) => {
    // console.log('Left:', key, leftPresences);
  });

  presenceChannel.subscribe(async (status, err) => {
    if (err) {
      console.error('Presence subscribe error:', err);
      return;
    }
    if (status === 'SUBSCRIBED') {
      // Start tracking this user
      await presenceChannel.track({
        user_id: currentUser.uid,
        name: currentUser.name,
        at: new Date().toISOString()
      });
    }
  });
}

function updateOnlineFromPresence() {
  if (!presenceChannel) return;
  const state = presenceChannel.presenceState();

  // state is { key(uid): [presenceObj, ...], ... }
  const uniqueUserIds = new Set(
    Object.values(state)
      .flat()
      .map(p => p.user_id)
      .filter(Boolean)
  );

  onlineCount.textContent = uniqueUserIds.size.toString();
}

await initPresence();

// Cleanly untrack on tab close/navigation
window.addEventListener('beforeunload', () => {
  try { presenceChannel?.untrack(); } catch { /* ignore */ }
});

// 8) SEARCH / FILTER (client-side)
searchBtn.addEventListener('click', () => {
  const keyword = (searchInput.value || '').toLowerCase();
  document.querySelectorAll('.chat-message').forEach((node) => {
    const author  = (node.dataset.author  || '').toLowerCase();
    const content = (node.dataset.content || '').toLowerCase();
    node.style.display = (author.includes(keyword) || content.includes(keyword))
      ? 'flex'
      : 'none';
  });
});
</script>
<script>
const textarea = document.getElementById("chatInput");
const sendBtns = document.getElementsByClassName("sendMsgBtn");
const maxHeight = 160; // 4x the default ~40px height

// Auto-expand textarea while typing
textarea.addEventListener("input", () => {
  textarea.style.height = "auto"; // Reset before calculating new height
  const newHeight = textarea.scrollHeight;

  if (newHeight <= maxHeight) {
    textarea.style.overflowY = "hidden";
    textarea.style.height = newHeight + "px";
  } else {
    textarea.style.overflowY = "auto";
    textarea.style.height = maxHeight + "px";
  }
});

// Reset textarea height when clicking send buttons
for (let btn of sendBtns) {
  btn.addEventListener("click", () => {
    // Just reset, no sending handled here
    textarea.style.height = "40px";
    textarea.style.overflowY = "hidden";
  });
}
</script>
<script>
  const menuBtn = document.getElementById("menuBtn");
  const menuIcon = document.getElementById("menuIcon");
  const blurOverlay = document.getElementById("blurOverlay");
  const sidebar = document.querySelector("aside");

  menuBtn.addEventListener("click", () => {
    // Toggle icon
    menuIcon.classList.toggle("fa-bars");
    menuIcon.classList.toggle("fa-xmark");

    // Toggle sidebar
    sidebar.classList.toggle("hidden");
    sidebar.classList.toggle("absolute");
    sidebar.classList.toggle("z-40");
    sidebar.classList.toggle("h-screen");

    // Toggle blur overlay
    blurOverlay.classList.toggle("hidden");
  });

  blurOverlay.addEventListener("click", () => {
    menuIcon.classList.add("fa-bars");
    menuIcon.classList.remove("fa-xmark");
    sidebar.classList.add("hidden");
    sidebar.classList.remove("absolute", "z-40", "h-screen");
    blurOverlay.classList.add("hidden");
  });
</script>
</body>
</html>