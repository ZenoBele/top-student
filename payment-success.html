<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Payment Successful - Top Student</title>
  <link rel="icon" type="image/png" sizes="32x32" href="images/favicon.png" />
  <link rel="shortcut icon" type="image/png" href="images/favicon.png" />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-gradient-to-br from-green-100 to-white min-h-screen flex items-center justify-center px-4 relative">

  <!-- Success Box -->
  <div id="success-box" class="w-full max-w-md bg-white p-8 rounded-2xl shadow-xl text-center space-y-6">
    <div class="text-green-600 text-5xl">
      <i class="ph ph-check-circle"></i>
    </div>
    <h2 class="text-2xl font-bold text-gray-800">Payment Successful</h2>
    <p id="success-message" class="text-gray-600">Thank you for joining Top Student. You're all set to begin!</p>

    <div class="space-y-3">
      <button onclick="openLogin()" class="w-full py-2 px-4 text-white font-semibold rounded-lg shadow-md bg-green-600 hover:bg-green-700 transition">
        Log in now
      </button>
      <a href="index.html" class="block w-full py-2 px-4 text-green-700 border border-green-600 rounded-lg hover:bg-green-100 transition text-center">
        Back to Home
      </a>
    </div>
  </div>

  <!-- Login Modal -->
  <div id="login-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[50] hidden">
    <div class="bg-white p-6 rounded-xl w-full max-w-md shadow-lg relative space-y-5">
      <button onclick="closeLogin()" class="absolute top-3 right-3 text-gray-500 hover:text-gray-800" aria-label="Close login modal">
        <i class="ph ph-x text-xl"></i>
      </button>

      <h3 class="text-xl font-bold text-center text-gray-800">Log In</h3>

      <form id="login-form" class="space-y-4" novalidate>
        <input type="email" id="email" required placeholder="Email" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-400" autocomplete="username"/>
        <div class="relative">
          <input type="password" id="password" required placeholder="Password" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-400" autocomplete="current-password"/>
          <button type="button" onclick="togglePassword()" class="absolute top-2 right-2 text-gray-500">
            <i id="eye-icon" class="ph ph-eye text-xl"></i>
          </button>
        </div>
        <button type="submit" class="w-full py-2 px-4 text-white bg-green-600 hover:bg-green-700 rounded-lg font-semibold">
          Sign In
        </button>
      </form>

      <p class="text-sm text-gray-600 text-center">
        Forgot Pin? <a href="reset.html" class="text-green-600 hover:underline">Reset Password</a>
      </p>

      <p class="text-sm text-gray-600 text-center">
        Need help? <a href="mailto:info@topstudent.co.za" class="text-green-600 hover:underline">Contact support</a>
      </p>
    </div>
  </div>

  <!-- Loader overlay -->
  <div id="loader" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-[10000] hidden">
    <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-green-600"></div>
  </div>

<script type="module">
import { supabase } from './js/supabaseClient.js';

  window.openLogin = () => document.getElementById('login-modal').classList.remove('hidden');
  window.closeLogin = () => document.getElementById('login-modal').classList.add('hidden');

  window.togglePassword = () => {
    const pw = document.getElementById("password");
    const icon = document.getElementById("eye-icon");
    if(pw.type === "password"){ pw.type="text"; icon.classList.replace("ph-eye","ph-eye-slash"); }
    else { pw.type="password"; icon.classList.replace("ph-eye-slash","ph-eye"); }
  };

  const loginForm = document.getElementById('login-form');
  const loader = document.getElementById('loader');

  loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;

    // 1. Check if account exists
    const { data: account, error } = await supabase
      .from('accounts')
      .select('*')
      .eq('email', email)
      .single();

    if (error || !account) {
      Swal.fire({
        icon: 'error',
        title: 'Account Not Found',
        text: 'No account exists with this email.',
      });
      return;
    }

    // 2. Check if account is active
    if (!account.is_active) {
      Swal.fire({
        icon: 'warning',
        title: 'Account Inactive',
        html: `Your account is either suspended, scheduled for deletion, or inactive.<br>
               Please <a href="contact.html" class="text-blue-600 underline">contact support</a>.`,
      });
      return;
    }

    // 3. Show loader while signing in
    loader.classList.remove('hidden');

    // 4. Sign in with Supabase auth
    const { data: signInData, error: signInError } = await supabase.auth.signInWithPassword({ email, password });

    loader.classList.add('hidden');

    if (signInError) {
      Swal.fire({
        icon: 'error',
        title: 'Login Failed',
        text: signInError.message,
      });
      return;
    }

    // 5. Success, redirect
    window.location.href = 'dashboard.html';
  });
</script>
<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('js/sw.js')
    .then(() => console.log('âœ… Service Worker registered'))
    .catch(err => console.error('SW failed:', err));
}
</script>
</body>
</html>



